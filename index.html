<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Muslim App</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* iOS-—Å—Ç–∏–ª—å + —Ç—ë–º–Ω–∞—è —Ç–µ–º–∞ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        /* –°–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) */
        :root {
            --bg: #f2f2f7;
            --card-bg: rgba(255,255,255,0.9);
            --text: #1c1c1e;
            --secondary-text: #8e8e93;
            --border: rgba(60,60,67,0.1);
            --accent: #007aff;
            --success: #34c759;
            --warning: #ffcc00;
            --danger: #ff3b30;
        }

        /* –¢—ë–º–Ω–∞—è —Ç–µ–º–∞ ‚Äì –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ prefers-color-scheme –∏–ª–∏ —Ç–µ–º–µ Telegram */
        @media (prefers-color-scheme: dark) {
            :root {
                --bg: #000000;
                --card-bg: rgba(28,28,30,0.9);
                --text: #ffffff;
                --secondary-text: #8e8e93;
                --border: rgba(84,84,88,0.2);
                --accent: #0a84ff;
                --success: #32d74b;
                --warning: #ffd60a;
                --danger: #ff453a;
            }
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.4;
            padding-bottom: 90px;
            min-height: 100vh;
            transition: background 0.2s, color 0.2s;
        }

        /* –¢–∞–±‚Äë–±–∞—Ä */
        .tabs {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            display: flex;
            justify-content: space-around;
            padding: 8px 0 20px;
            border-top: 0.5px solid var(--border);
            z-index: 100;
        }

        .tab {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 6px 0;
            color: var(--secondary-text);
            font-size: 10px;
            font-weight: 500;
            transition: color 0.2s;
            cursor: pointer;
            border: none;
            background: transparent;
        }

        .tab.active {
            color: var(--accent);
        }

        .tab span {
            font-size: 22px;
            margin-bottom: 2px;
        }

        .content {
            padding: 16px;
            max-width: 480px;
            margin: 0 auto;
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0.6; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* –ö–∞—Ä—Ç–æ—á–∫–∏ */
        .card {
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 14px;
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.04);
            border: 0.5px solid var(--border);
        }

        .card h2 {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
            color: var(--text);
            letter-spacing: -0.3px;
        }

        .current-time {
            font-size: 42px;
            font-weight: 700;
            color: var(--text);
            text-align: center;
            margin: 8px 0;
            font-feature-settings: "tnum";
        }

        /* –í—Ä–µ–º—è –Ω–∞–º–∞–∑–∞ */
        .prayer-time {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 0.5px solid var(--border);
        }

        .prayer-time:last-child {
            border-bottom: none;
        }

        .prayer-name {
            font-size: 17px;
            font-weight: 400;
            color: var(--text);
        }

        .prayer-time-value {
            font-size: 19px;
            font-weight: 600;
            color: var(--accent);
            font-feature-settings: "tnum";
        }

        .prayer-emoji {
            font-size: 24px;
            margin-right: 12px;
            vertical-align: middle;
        }

        /* –ü–æ–ª—è –≤–≤–æ–¥–∞ */
        .search-row {
            display: flex;
            gap: 10px;
            margin-bottom: 12px;
        }

        input[type="text"] {
            flex: 1;
            padding: 14px 16px;
            background: rgba(118,118,128,0.08);
            border: 0.5px solid var(--border);
            border-radius: 10px;
            font-size: 17px;
            color: var(--text);
            transition: all 0.2s;
        }

        input[type="text"]:focus {
            outline: none;
            border-color: var(--accent);
            background: var(--card-bg);
        }

        input[type="text"]::placeholder {
            color: var(--secondary-text);
        }

        /* –ö–Ω–æ–ø–∫–∏ */
        button {
            border: none;
            border-radius: 12px;
            padding: 14px 20px;
            font-size: 17px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            background: var(--accent);
            color: white;
            box-shadow: 0 2px 8px rgba(0,122,255,0.2);
        }

        button:active {
            opacity: 0.8;
            transform: scale(0.98);
        }

        .btn-outline {
            background: transparent;
            border: 1.5px solid var(--accent);
            color: var(--accent);
            box-shadow: none;
        }

        .btn-outline:active {
            background: rgba(10,132,255,0.05);
        }

        .btn-success {
            background: var(--success);
            box-shadow: 0 2px 8px rgba(52,199,89,0.2);
        }

        .btn-secondary {
            background: rgba(118,118,128,0.08);
            color: var(--accent);
            box-shadow: none;
        }

        .btn-secondary:active {
            background: rgba(118,118,128,0.2);
        }

        /* –¢–∞—Å–±–∏—Ö */
        .counter-display {
            font-size: 80px;
            font-weight: 700;
            color: var(--text);
            text-align: center;
            margin: 20px 0;
            font-feature-settings: "tnum";
        }

        .counter-button {
            width: 220px;
            height: 220px;
            border-radius: 50%;
            background: var(--accent);
            color: white;
            font-size: 28px;
            border: none;
            margin: 16px auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            box-shadow: 0 8px 24px rgba(0,122,255,0.3);
            transition: all 0.15s;
        }

        .counter-button:active {
            transform: scale(0.94);
            box-shadow: 0 4px 12px rgba(0,122,255,0.3);
        }

        .progress-bar {
            height: 6px;
            background: rgba(118,118,128,0.1);
            border-radius: 3px;
            overflow: hidden;
            margin: 16px 0;
        }

        .progress-fill {
            height: 100%;
            background: var(--accent);
            width: 0%;
            transition: width 0.2s;
            border-radius: 3px;
        }

        /* –ù–∞—Å—Ç—Ä–æ–π–∫–∏ */
        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px 0;
            border-bottom: 0.5px solid var(--border);
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 51px;
            height: 31px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #e9e9ea;
            transition: .2s;
            border-radius: 31px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 29px;
            width: 29px;
            left: 1px;
            bottom: 1px;
            background-color: white;
            transition: .2s;
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        input:checked + .slider {
            background-color: var(--success);
        }

        input:checked + .slider:before {
            transform: translateX(20px);
        }

        /* –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–æ–µ */
        .debug-info {
            font-size: 12px;
            color: var(--secondary-text);
            background: rgba(118,118,128,0.05);
            padding: 12px;
            border-radius: 10px;
            margin-top: 12px;
            font-family: 'SF Mono', monospace;
        }

        .warning {
            background: rgba(255,204,0,0.1);
            border-left: 4px solid var(--warning);
            padding: 14px;
            border-radius: 10px;
            color: var(--secondary-text);
            font-size: 14px;
            margin: 16px 0;
        }

        .geo-status {
            font-size: 14px;
            color: var(--success);
            margin-top: 8px;
            font-weight: 500;
        }

        .info {
            color: var(--secondary-text);
            font-size: 13px;
            text-align: center;
            margin-top: 12px;
        }

        .saved-city-badge {
            display: inline-block;
            background: rgba(10,132,255,0.1);
            border-radius: 8px;
            padding: 8px 12px;
            font-size: 14px;
            color: var(--accent);
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <!-- –ù–∏–∂–Ω–∏–π —Ç–∞–±‚Äë–±–∞—Ä iOS -->
    <div class="tabs">
        <div class="tab active" onclick="switchTab(event, 'prayer')">
            <span>üïå</span>
            <span>–ù–∞–º–∞–∑</span>
        </div>
        <div class="tab" onclick="switchTab(event, 'tasbih')">
            <span>üìø</span>
            <span>–¢–∞—Å–±–∏—Ö</span>
        </div>
        <div class="tab" onclick="switchTab(event, 'settings')">
            <span>‚öôÔ∏è</span>
            <span>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</span>
        </div>
    </div>

    <div class="content">
        <!-- –°–¢–†–ê–ù–ò–¶–ê –ù–ê–ú–ê–ó -->
        <div id="prayer" class="page active">
            <div class="card">
                <h2>üïê –¢–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è</h2>
                <div class="current-time" id="currentTime">--:--:--</div>
                <div class="debug-info">
                    –ß–∞—Å–æ–≤–æ–π –ø–æ—è—Å: <span id="timezoneInfo">--</span><br>
                    Offset: <span id="offsetInfo">--</span> –º–∏–Ω
                </div>
            </div>

            <div class="card">
                <h2>üìç –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è</h2>
                <div class="search-row">
                    <input type="text" id="cityInput" placeholder="–ì–æ—Ä–æ–¥ (–Ω–∞–ø—Ä–∏–º–µ—Ä, Baku)">
                    <button class="btn-outline" onclick="geocodeAndFetchCity()">–ù–∞–π—Ç–∏</button>
                </div>
                <div style="display: flex; gap: 10px; margin-bottom: 8px;">
                    <button class="btn-outline" onclick="getLocationAndFetchTimes()" style="flex: 1;">
                        üìç –ê–≤—Ç–æ
                    </button>
                    <button class="btn-outline" onclick="clearSavedLocation()" style="flex: 1;">
                        üóëÔ∏è –°–º–µ–Ω–∏—Ç—å
                    </button>
                </div>
                <div id="geoStatus" class="geo-status"></div>
                <div id="savedCityInfo" class="saved-city-badge" style="display: none;"></div>
            </div>

            <div class="card" id="prayerTimesCard" style="display:none;">
                <h2 id="cityName">–í—Ä–µ–º—è –Ω–∞–º–∞–∑–∞</h2>
                <div class="debug-info" id="coordsDebug"></div>
                
                <div class="warning">
                    ‚è∞ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø—Ä–∏—Ö–æ–¥—è—Ç <strong>—Ç–æ—á–Ω–æ –≤–æ –≤—Ä–µ–º—è –Ω–∞–º–∞–∑–∞</strong> (–ø–æ –º–µ—Å—Ç–Ω–æ–º—É –≤—Ä–µ–º–µ–Ω–∏ –≥–æ—Ä–æ–¥–∞).<br>
                    üïå –ú–∞–∑—Ö–∞–±: –®–∞—Ñ–∏–∏—Ç—Å–∫–∏–π (–ê—Å—Ä).
                </div>
                
                <div style="margin: 16px 0;">
                    <div class="prayer-time">
                        <div><span class="prayer-emoji">üåÖ</span><span class="prayer-name">–§–∞–¥–∂—Ä</span></div>
                        <span class="prayer-time-value" id="timeFajr">--:--</span>
                    </div>
                    <div class="prayer-time">
                        <div><span class="prayer-emoji">‚òÄÔ∏è</span><span class="prayer-name">–ó—É—Ö—Ä</span></div>
                        <span class="prayer-time-value" id="timeDhuhr">--:--</span>
                    </div>
                    <div class="prayer-time">
                        <div><span class="prayer-emoji">üå§</span><span class="prayer-name">–ê—Å—Ä</span></div>
                        <span class="prayer-time-value" id="timeAsr">--:--</span>
                    </div>
                    <div class="prayer-time">
                        <div><span class="prayer-emoji">üåá</span><span class="prayer-name">–ú–∞–≥—Ä–∏–±</span></div>
                        <span class="prayer-time-value" id="timeMaghrib">--:--</span>
                    </div>
                    <div class="prayer-time">
                        <div><span class="prayer-emoji">üåô</span><span class="prayer-name">–ò—à–∞</span></div>
                        <span class="prayer-time-value" id="timeIsha">--:--</span>
                    </div>
                </div>
                
                <button class="btn-success" onclick="saveToBot()">üì° –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –±–æ—Ç–∞</button>
                <div class="info">–ü–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –±–æ—Ç –±—É–¥–µ—Ç –ø—Ä–∏—Å—ã–ª–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</div>
            </div>
        </div>

        <!-- –°–¢–†–ê–ù–ò–¶–ê –¢–ê–°–ë–ò–• -->
        <div id="tasbih" class="page">
            <div class="card" style="text-align: center;">
                <h2>üìø –¢–∞—Å–±–∏—Ö</h2>
                <div class="counter-display" id="counterDisplay">0</div>
                
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill" style="width: 0%;"></div>
                </div>
                
                <button class="counter-button" onclick="incrementCounter()">
                    <span style="font-size: 48px;">‚òùÔ∏è</span>
                    <span style="font-size: 18px; margin-top: 12px;">–ù–∞–∂–º–∏</span>
                </button>
                
                <div class="target-info" id="targetInfo">–¶–µ–ª—å: 33</div>
                
                <div class="tasbih-controls" style="display: flex; gap: 8px; margin-top: 24px;">
                    <button class="btn-secondary" onclick="setTarget(33)">33</button>
                    <button class="btn-secondary" onclick="setTarget(99)">99</button>
                    <button class="btn-secondary" onclick="setTarget(100)">100</button>
                    <button class="btn-secondary" onclick="resetCounter()">–°–±—Ä–æ—Å</button>
                </div>
            </div>
            
            <div class="card">
                <h2>üìñ –ó–∏–∫—Ä—ã</h2>
                <div style="padding: 10px 0; border-bottom: 0.5px solid var(--border);">
                    <div style="font-weight: 600; margin-bottom: 4px;">ÿ≥Ÿèÿ®Ÿíÿ≠ŸéÿßŸÜŸé ÿßŸÑŸÑŸáŸê</div>
                    <div style="color: var(--secondary-text); font-size: 15px;">–°—É–±—Ö–∞–Ω–∞–ª–ª–∞—Ö (33)</div>
                </div>
                <div style="padding: 10px 0; border-bottom: 0.5px solid var(--border);">
                    <div style="font-weight: 600; margin-bottom: 4px;">ÿßŸÑŸíÿ≠ŸéŸÖŸíÿØŸè ŸÑŸêŸÑŸéŸëŸáŸê</div>
                    <div style="color: var(--secondary-text); font-size: 15px;">–ê–ª—å—Ö–∞–º–¥—É–ª–∏–ª–ª–∞—Ö (33)</div>
                </div>
                <div style="padding: 10px 0;">
                    <div style="font-weight: 600; margin-bottom: 4px;">ÿßŸÑŸÑŸáŸè ÿ£ŸéŸÉŸíÿ®Ÿéÿ±Ÿè</div>
                    <div style="color: var(--secondary-text); font-size: 15px;">–ê–ª–ª–∞—Ö—É –ê–∫–±–∞—Ä (34)</div>
                </div>
            </div>
        </div>

        <!-- –°–¢–†–ê–ù–ò–¶–ê –ù–ê–°–¢–†–û–ô–ö–ò -->
        <div id="settings" class="page">
            <div class="card">
                <h2>üîî –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</h2>
                <div class="setting-item">
                    <span>üåÖ –§–∞–¥–∂—Ä</span>
                    <label class="switch">
                        <input type="checkbox" id="notifFajr" checked onchange="saveNotificationSettings()">
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="setting-item">
                    <span>‚òÄÔ∏è –ó—É—Ö—Ä</span>
                    <label class="switch">
                        <input type="checkbox" id="notifDhuhr" checked onchange="saveNotificationSettings()">
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="setting-item">
                    <span>üå§ –ê—Å—Ä</span>
                    <label class="switch">
                        <input type="checkbox" id="notifAsr" checked onchange="saveNotificationSettings()">
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="setting-item">
                    <span>üåá –ú–∞–≥—Ä–∏–±</span>
                    <label class="switch">
                        <input type="checkbox" id="notifMaghrib" checked onchange="saveNotificationSettings()">
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="setting-item">
                    <span>üåô –ò—à–∞</span>
                    <label class="switch">
                        <input type="checkbox" id="notifIsha" checked onchange="saveNotificationSettings()">
                        <span class="slider"></span>
                    </label>
                </div>
            </div>

            <div class="card">
                <h2>‚öôÔ∏è –ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Ä–∞—Å—á—ë—Ç–∞</h2>
                <div style="margin-bottom: 8px; color: var(--text);">–ú–µ—Ç–æ–¥: 14 (–†–æ—Å—Å–∏—è/–ö–∞–≤–∫–∞–∑)</div>
                <div style="color: var(--secondary-text); font-size: 15px;">–ú–∞–∑—Ö–∞–±: –®–∞—Ñ–∏–∏—Ç—Å–∫–∏–π (—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω)</div>
            </div>

            <div class="card">
                <h2>‚ÑπÔ∏è –û –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏</h2>
                <p style="color: var(--text); line-height: 1.5;">
                    –¢–æ—á–Ω–æ–µ –≤—Ä–µ–º—è –Ω–∞–º–∞–∑–∞ –ø–æ –º–µ—Ç–æ–¥—É 14 (–†–æ—Å—Å–∏—è/–ö–∞–≤–∫–∞–∑), —à–∞—Ñ–∏–∏—Ç—Å–∫–∏–π –º–∞–∑—Ö–∞–±.<br>
                    –ì–µ–æ–ª–æ–∫–∞—Ü–∏—è, —Ä—É—á–Ω–æ–π –ø–æ–∏—Å–∫, —Ç–∞—Å–±–∏—Ö, —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è.<br>
                    –ü–æ—Å–ª–µ–¥–Ω–∏–π –≤—ã–±—Ä–∞–Ω–Ω—ã–π –≥–æ—Ä–æ–¥ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.
                </p>
                <div style="margin-top: 16px; padding-top: 16px; border-top: 0.5px solid var(--border); color: var(--secondary-text); font-size: 13px;">
                    –í–µ—Ä—Å–∏—è 5.0 (—à–∞—Ñ–∏–∏ + —Ç—ë–º–Ω–∞—è —Ç–µ–º–∞)<br>
                    ¬© 2025 Muslim App
                </div>
            </div>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –ø—Ä–∏–º–µ–Ω—è–µ–º —Ç–µ–º—É Telegram (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–∞)
        if (tg.themeParams && tg.themeParams.bg_color) {
            document.documentElement.style.setProperty('--bg', tg.themeParams.bg_color);
            document.documentElement.style.setProperty('--text', tg.themeParams.text_color);
            document.documentElement.style.setProperty('--accent', tg.themeParams.button_color);
            // –∏ —Ç.–¥. ‚Äì –º–æ–∂–Ω–æ —Ä–∞—Å—à–∏—Ä–∏—Ç—å, –Ω–æ –æ—Å—Ç–∞–≤–∏–º –∞–≤—Ç–æ–º–∞—Ç–∏–∫—É
        }

        // --- –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ ---
        let foundLat = 0;
        let foundLon = 0;
        let foundTimezone = '';
        let foundCityName = '';
        const SCHOOL = 0; // 0 = –®–∞—Ñ–∏–∏ (–∂—ë—Å—Ç–∫–æ)

        // –¢–∞—Å–±–∏—Ö
        let counter = parseInt(localStorage.getItem('tasbihCounter') || '0');
        let target = parseInt(localStorage.getItem('tasbihTarget') || '33');

        // --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ---
        updateCounterDisplay();
        loadNotificationSettings();
        updateCurrentTime();
        setInterval(updateCurrentTime, 1000);

        // –ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ ‚Äì –ø–æ–ø—ã—Ç–∞—Ç—å—Å—è –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–æ–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ
        window.addEventListener('load', () => {
            loadSavedLocation();
        });

        // --- –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ç–∞–±–æ–≤ ---
        function switchTab(event, tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            event.currentTarget.classList.add('active');
            document.getElementById(tabName).classList.add('active');
        }

        // --- –í—Ä–µ–º—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ ---
        function updateCurrentTime() {
            const now = new Date();
            document.getElementById('currentTime').textContent = 
                `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}:${String(now.getSeconds()).padStart(2,'0')}`;
            const offset = now.getTimezoneOffset();
            document.getElementById('timezoneInfo').textContent = `UTC${offset<=0?'+':'-'}${Math.abs(offset/60)}`;
            document.getElementById('offsetInfo').textContent = offset;
        }

        // --- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ / –∑–∞–≥—Ä—É–∑–∫–∞ –ª–æ–∫–∞—Ü–∏–∏ –≤ localStorage ---
        const STORAGE_KEY = 'muslim_app_location';

        function saveLocationToStorage(lat, lon, timezone, cityName) {
            const data = { lat, lon, timezone, cityName, timestamp: Date.now() };
            localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
            document.getElementById('savedCityInfo').style.display = 'inline-block';
            document.getElementById('savedCityInfo').innerHTML = `üìç –¢–µ–∫—É—â–∏–π –≥–æ—Ä–æ–¥: ${cityName}`;
        }

        function loadSavedLocation() {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    // –ï—Å–ª–∏ –ø—Ä–æ—à–ª–æ –±–æ–ª—å—à–µ 24 —á–∞—Å–æ–≤ ‚Äì –ª—É—á—à–µ –æ–±–Ω–æ–≤–∏—Ç—å, –Ω–æ –ø–æ–∫–∞ –ø—Ä–æ—Å—Ç–æ –∑–∞–≥—Ä—É–∂–∞–µ–º
                    fetchPrayerTimesByCoords(data.lat, data.lon, data.cityName);
                } catch (e) {
                    console.warn('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–æ–π –ª–æ–∫–∞—Ü–∏–∏', e);
                }
            } else {
                // –ï—Å–ª–∏ –Ω–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–æ–≥–æ ‚Äì –∑–∞–ø—É—Å–∫–∞–µ–º –∞–≤—Ç–æ-GPS —á–µ—Ä–µ–∑ 1 —Å–µ–∫
                setTimeout(() => getLocationAndFetchTimes(), 1000);
            }
        }

        function clearSavedLocation() {
            localStorage.removeItem(STORAGE_KEY);
            foundLat = 0;
            foundLon = 0;
            document.getElementById('prayerTimesCard').style.display = 'none';
            document.getElementById('savedCityInfo').style.display = 'none';
            document.getElementById('geoStatus').innerHTML = 'üîÑ –ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ —Å–±—Ä–æ—à–µ–Ω–æ. –í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥.';
            document.getElementById('geoStatus').style.color = 'var(--secondary-text)';
            // –ü—Ä–µ–¥–ª–æ–∂–∏–º –∞–≤—Ç–æ-GPS
            getLocationAndFetchTimes();
        }

        // --- GPS ---
        function getLocationAndFetchTimes() {
            const status = document.getElementById('geoStatus');
            status.innerHTML = '‚è≥ –û–ø—Ä–µ–¥–µ–ª—è–µ–º –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ...';
            status.style.color = 'var(--accent)';
            if (!navigator.geolocation) {
                status.innerHTML = '‚ùå –ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è';
                status.style.color = 'var(--danger)';
                return;
            }
            navigator.geolocation.getCurrentPosition(
                (pos) => {
                    status.innerHTML = `‚úÖ –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –ø–æ–ª—É—á–µ–Ω—ã. –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—Ä–µ–º—è...`;
                    fetchPrayerTimesByCoords(pos.coords.latitude, pos.coords.longitude, '–í–∞—à–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ');
                },
                (err) => {
                    let msg = '‚ùå –û—à–∏–±–∫–∞: ';
                    if (err.code === 1) msg += '–¥–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω';
                    else if (err.code === 2) msg += '–Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ';
                    else if (err.code === 3) msg += '—Ç–∞–π–º–∞—É—Ç';
                    else msg += err.message;
                    status.innerHTML = msg;
                    status.style.color = 'var(--danger)';
                },
                { enableHighAccuracy: true, timeout: 10000, maximumAge: 60000 }
            );
        }

        // --- –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å –≤—Ä–µ–º–µ–Ω–∏ –ø–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º (—à–∞—Ñ–∏–∏—Ç—Å–∫–∏–π –º–∞–∑—Ö–∞–±) ---
        async function fetchPrayerTimesByCoords(lat, lon, displayName) {
            try {
                const date = new Date();
                const dateStr = `${date.getDate().toString().padStart(2,'0')}-${(date.getMonth()+1).toString().padStart(2,'0')}-${date.getFullYear()}`;
                // school = 0 (—à–∞—Ñ–∏–∏)
                const url = `https://api.aladhan.com/v1/timings/${dateStr}?latitude=${lat}&longitude=${lon}&method=14&school=${SCHOOL}`;
                
                const res = await fetch(url);
                const data = await res.json();
                
                if (data.code === 200) {
                    foundLat = lat;
                    foundLon = lon;
                    foundTimezone = data.data.meta.timezone;
                    foundCityName = displayName;

                    document.getElementById('cityName').innerHTML = `üïå ${displayName} (${foundTimezone})`;
                    document.getElementById('coordsDebug').innerHTML = `
                        üìç ${lat.toFixed(4)}, ${lon.toFixed(4)}<br>
                        üåç ${foundTimezone}<br>
                        üìÖ ${date.toLocaleDateString('ru-RU')}<br>
                        üïå –ú–∞–∑—Ö–∞–±: –®–∞—Ñ–∏–∏
                    `;
                    
                    document.getElementById('timeFajr').innerText = data.data.timings.Fajr;
                    document.getElementById('timeDhuhr').innerText = data.data.timings.Dhuhr;
                    document.getElementById('timeAsr').innerText = data.data.timings.Asr;
                    document.getElementById('timeMaghrib').innerText = data.data.timings.Maghrib;
                    document.getElementById('timeIsha').innerText = data.data.timings.Isha;
                    
                    document.getElementById('prayerTimesCard').style.display = 'block';
                    document.getElementById('geoStatus').innerHTML = '‚úÖ –í—Ä–µ–º—è –Ω–∞–º–∞–∑–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–æ';
                    document.getElementById('geoStatus').style.color = 'var(--success)';
                    
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage
                    saveLocationToStorage(lat, lon, foundTimezone, displayName);
                    
                    tg.HapticFeedback.notificationOccurred('success');
                } else {
                    throw new Error('API error');
                }
            } catch (e) {
                console.error(e);
                document.getElementById('geoStatus').innerHTML = '‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤—Ä–µ–º–µ–Ω–∏';
                document.getElementById('geoStatus').style.color = 'var(--danger)';
            }
        }

        // --- –ì–µ–æ–∫–æ–¥–∏–Ω–≥ (—Ä—É—á–Ω–æ–π –ø–æ–∏—Å–∫ –≥–æ—Ä–æ–¥–∞) ---
        async function geocodeAndFetchCity() {
            const city = document.getElementById('cityInput').value.trim();
            if (!city) {
                tg.showAlert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –≥–æ—Ä–æ–¥–∞');
                return;
            }
            const status = document.getElementById('geoStatus');
            status.innerHTML = `üîç –ò—â–µ–º "${city}"...`;
            status.style.color = 'var(--accent)';
            
            try {
                const geoRes = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(city)}&limit=1`, {
                    headers: { 'User-Agent': 'MuslimApp-Telegram/1.0' }
                });
                const geoData = await geoRes.json();
                if (geoData && geoData.length > 0) {
                    const lat = parseFloat(geoData[0].lat);
                    const lon = parseFloat(geoData[0].lon);
                    const name = geoData[0].display_name.split(',')[0];
                    status.innerHTML = `‚úÖ –ù–∞–π–¥–µ–Ω: ${name}. –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—Ä–µ–º—è...`;
                    await fetchPrayerTimesByCoords(lat, lon, name);
                } else {
                    status.innerHTML = '‚ùå –ì–æ—Ä–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω';
                    status.style.color = 'var(--danger)';
                    tg.showAlert('–ì–æ—Ä–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω');
                }
            } catch (e) {
                console.error(e);
                status.innerHTML = '‚ùå –û—à–∏–±–∫–∞ –≥–µ–æ–∫–æ–¥–∏–Ω–≥–∞';
                status.style.color = 'var(--danger)';
            }
        }

        // --- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –±–æ—Ç–∞ (–ø–µ—Ä–µ–¥–∞—ë–º school=0) ---
        function saveToBot() {
            if (foundLat === 0) {
                tg.showAlert('–°–Ω–∞—á–∞–ª–∞ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –∏–ª–∏ –≥–æ—Ä–æ–¥');
                return;
            }
            const offset = new Date().getTimezoneOffset();
            tg.sendData(JSON.stringify({
                action: 'sync_location',
                lat: foundLat,
                lon: foundLon,
                offset: offset,
                timezone: foundTimezone,
                school: SCHOOL   // 0 = —à–∞—Ñ–∏–∏
            }));
            tg.close();
        }

        // --- –¢–∞—Å–±–∏—Ö ---
        function incrementCounter() {
            counter++;
            localStorage.setItem('tasbihCounter', counter);
            updateCounterDisplay();
            if (counter === target) {
                tg.HapticFeedback.notificationOccurred('success');
                tg.showAlert(`üéâ –ú–∞—à–∞–ª–ª–∞—Ö! –î–æ—Å—Ç–∏–≥–Ω—É—Ç–æ ${target} –∑–∏–∫—Ä–æ–≤!`);
            } else {
                tg.HapticFeedback.impactOccurred('light');
            }
        }

        function updateCounterDisplay() {
            document.getElementById('counterDisplay').innerText = counter;
            document.getElementById('targetInfo').innerText = `–¶–µ–ª—å: ${target} (–æ—Å—Ç–∞–ª–æ—Å—å: ${Math.max(0, target - counter)})`;
            document.getElementById('progressFill').style.width = `${Math.min(100, (counter / target) * 100)}%`;
        }

        function resetCounter() {
            if (counter > 0) {
                tg.showConfirm('–°–±—Ä–æ—Å–∏—Ç—å —Å—á—ë—Ç—á–∏–∫?', (ok) => {
                    if (ok) {
                        counter = 0;
                        localStorage.setItem('tasbihCounter', '0');
                        updateCounterDisplay();
                        tg.HapticFeedback.notificationOccurred('warning');
                    }
                });
            }
        }

        function setTarget(newTarget) {
            target = newTarget;
            localStorage.setItem('tasbihTarget', target);
            updateCounterDisplay();
            tg.HapticFeedback.impactOccurred('medium');
        }

        // --- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π ---
        function loadNotificationSettings() {
            const saved = localStorage.getItem('notificationSettings');
            if (saved) {
                const s = JSON.parse(saved);
                document.getElementById('notifFajr').checked = s.Fajr !== false;
                document.getElementById('notifDhuhr').checked = s.Dhuhr !== false;
                document.getElementById('notifAsr').checked = s.Asr !== false;
                document.getElementById('notifMaghrib').checked = s.Maghrib !== false;
                document.getElementById('notifIsha').checked = s.Isha !== false;
            }
        }

        function saveNotificationSettings() {
            const settings = {
                Fajr: document.getElementById('notifFajr').checked,
                Dhuhr: document.getElementById('notifDhuhr').checked,
                Asr: document.getElementById('notifAsr').checked,
                Maghrib: document.getElementById('notifMaghrib').checked,
                Isha: document.getElementById('notifIsha').checked
            };
            localStorage.setItem('notificationSettings', JSON.stringify(settings));
            tg.sendData(JSON.stringify({ action: 'update_notifications', settings }));
            tg.HapticFeedback.notificationOccurred('success');
        }
    </script>
</body>
</html>

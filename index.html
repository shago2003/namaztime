<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Muslim App</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg-color: #F2F2F7;
            --card-bg: #FFFFFF;
            --text-color: #000000;
            --secondary-text: #8E8E93;
            --accent-color: #007AFF;
            --danger-color: #FF3B30;
            --success-color: #34C759;
            --tab-bar-bg: #FFFFFF;
            --border-color: #E5E5EA;
        }

        [data-theme="dark"] {
            --bg-color: #000000;
            --card-bg: #1C1C1E;
            --text-color: #FFFFFF;
            --secondary-text: #8E8E93;
            --accent-color: #0A84FF;
            --tab-bar-bg: #1C1C1E;
            --border-color: #38383A;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0; padding: 0; padding-bottom: 90px;
            overflow-x: hidden; -webkit-tap-highlight-color: transparent;
        }

        .container { display: none; padding: 20px; animation: fadeIn 0.3s ease; }
        .container.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .card {
            background: var(--card-bg); border-radius: 16px; padding: 20px;
            margin-bottom: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }

        h1 { font-size: 28px; font-weight: 700; margin: 10px 0 20px 0; }
        h2 { font-size: 18px; font-weight: 600; margin-bottom: 10px; margin-top: 5px; color: var(--secondary-text); text-transform: uppercase; letter-spacing: 0.5px; }

        /* HERO & LISTS */
        .hero-card {
            text-align: center; color: white; padding: 40px 20px;
            background: linear-gradient(135deg, #007AFF, #5AC8FA);
        }
        .hero-time { font-size: 48px; font-weight: 800; margin: 10px 0; }
        .prayer-row {
            display: flex; justify-content: space-between; padding: 16px 0;
            border-bottom: 1px solid var(--border-color); font-size: 17px;
        }
        .prayer-row:last-child { border-bottom: none; }
        .prayer-time { font-weight: 600; color: var(--accent-color); }

        /* INPUTS & BUTTONS */
        .setting-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 16px 0; border-bottom: 1px solid var(--border-color);
        }
        .setting-item:last-child { border-bottom: none; }
        
        .btn-full {
            background: var(--accent-color); color: white; border: none;
            padding: 14px; border-radius: 12px; font-size: 16px; font-weight: 600;
            width: 100%; cursor: pointer; margin-top: 10px;
        }
        .btn-full:disabled {
            background-color: var(--secondary-text); opacity: 0.5; cursor: not-allowed;
        }
        .btn-test { background-color: var(--success-color); }
        .input-time {
            background: var(--bg-color); border: 1px solid var(--border-color);
            color: var(--text-color); padding: 12px; border-radius: 8px; 
            font-size: 16px; width: 100%; box-sizing: border-box; display: block;
        }

        /* TOGGLE SWITCH */
        .switch { position: relative; display: inline-block; width: 50px; height: 30px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
            background-color: #ccc; transition: .4s; border-radius: 34px;
        }
        .slider:before {
            position: absolute; content: ""; height: 26px; width: 26px;
            left: 2px; bottom: 2px; background-color: white; transition: .4s; border-radius: 50%;
        }
        input:checked + .slider { background-color: var(--success-color); }
        input:checked + .slider:before { transform: translateX(20px); }

        /* TAB BAR */
        .tab-bar {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: var(--tab-bar-bg); border-top: 1px solid var(--border-color);
            display: flex; justify-content: space-around; height: 60px; padding-bottom: env(safe-area-inset-bottom);
        }
        .tab-btn {
            flex: 1; background: none; border: none; color: var(--secondary-text);
            font-size: 10px; display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .tab-btn.active { color: var(--accent-color); }
        .tab-icon { font-size: 24px; margin-bottom: 4px; }
    </style>
</head>
<body>

    <div id="tab-home" class="container active">
        <h1>–ê—Å—Å–∞–ª—è–º—É –∞–ª–µ–π–∫—É–º</h1>
        <div class="card hero-card" id="heroCard">
            <span style="font-size:50px" id="heroIcon">‚è≥</span>
            <div>–°–ª–µ–¥—É—é—â–∏–π –Ω–∞–º–∞–∑</div>
            <div class="hero-time" id="nextPrayerTime">--:--</div>
            <div id="nextPrayerName">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        </div>
        <div class="card" id="homeScheduleList"></div>
    </div>

    <div id="tab-settings" class="container">
        <h1>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h1>

        <div class="card">
            <div class="setting-item">
                <span>–¢–µ–º–Ω–∞—è —Ç–µ–º–∞</span>
                <label class="switch">
                    <input type="checkbox" id="themeToggle" onchange="toggleTheme()">
                    <span class="slider"></span>
                </label>
            </div>
        </div>

        <h2>–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</h2>
        <div class="card">
            <div class="setting-item">
                <span style="font-weight: 600;">–í–∫–ª—é—á–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</span>
                <label class="switch">
                    <input type="checkbox" id="notifToggle" onchange="toggleNotifications()">
                    <span class="slider"></span>
                </label>
            </div>
            
            <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border-color);">
                <div style="margin-bottom: 10px;">–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–≤—è–∑–∏ —Å –±–æ—Ç–æ–º:</div>
                <button id="btnTest" class="btn-full btn-test" onclick="sendTest()">üîî –ü—Ä–æ–≤–µ—Ä–∏—Ç—å (–¢–µ—Å—Ç)</button>
            </div>

            <div style="margin-top: 20px;">
                <div style="margin-bottom: 10px;">–ù–∞–ø–æ–º–Ω–∏—Ç—å –º–Ω–µ –≤:</div>
                <input type="time" id="alarmTime" class="input-time">
                <button id="btnAlarm" class="btn-full" onclick="setAlarm()">‚è∞ –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
            </div>
            
            <p style="font-size: 13px; color: var(--secondary-text); margin-top: 10px;">
                * –ü—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –∫–Ω–æ–ø–æ–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–∫—Ä–æ–µ—Ç—Å—è, –∏ –±–æ—Ç –ø—Ä–∏—à–ª–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ.
            </p>
        </div>

        <h2>–õ–æ–∫–∞—Ü–∏—è</h2>
        <div class="card">
            <button class="btn-full" onclick="getLocation('gps')">üìç GPS (–ê–≤—Ç–æ)</button>
            <div style="margin-top: 10px; display: flex; gap: 10px;">
                <input type="text" id="cityInput" class="input-time" placeholder="City (e.g. Baku)">
                <button class="btn-full" style="width: 80px; margin-top:0" onclick="getLocation('city')">OK</button>
            </div>
            <div id="locationStatus" style="font-size: 13px; color: var(--secondary-text); margin-top: 5px; text-align: center;"></div>
        </div>
    </div>

    <div class="tab-bar">
        <button class="tab-btn active" onclick="switchTab('home', this)"><span class="tab-icon">üè†</span>–ì–ª–∞–≤–Ω–∞—è</button>
        <button class="tab-btn" onclick="switchTab('settings', this)"><span class="tab-icon">‚öôÔ∏è</span>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        // --- GLOBAL VARIABLES ---
        let notificationsEnabled = localStorage.getItem('notifEnabled') === 'true';
        let currentTimings = null;

        // --- INIT ---
        function init() {
            // Theme
            if(localStorage.getItem('theme') === 'dark') {
                document.body.setAttribute('data-theme', 'dark');
                document.getElementById('themeToggle').checked = true;
            }
            
            // Notifications Toggle State
            document.getElementById('notifToggle').checked = notificationsEnabled;
            updateButtonsState();

            // Location
            const city = localStorage.getItem('savedCity');
            if(city) fetchByCity(city); else getLocation('gps');
        }

        // --- NOTIFICATIONS LOGIC ---
        function toggleNotifications() {
            notificationsEnabled = document.getElementById('notifToggle').checked;
            localStorage.setItem('notifEnabled', notificationsEnabled);
            updateButtonsState();
            
            if(notificationsEnabled) {
                tg.HapticFeedback.notificationOccurred('success');
            }
        }

        function updateButtonsState() {
            // –ï—Å–ª–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –í–´–ö–õ, –∫–Ω–æ–ø–∫–∏ —Å—Ç–∞–Ω–æ–≤—è—Ç—Å—è —Å–µ—Ä—ã–º–∏ (disabled)
            document.getElementById('btnTest').disabled = !notificationsEnabled;
            document.getElementById('btnAlarm').disabled = !notificationsEnabled;
            document.getElementById('alarmTime').disabled = !notificationsEnabled;
        }

        function sendTest() {
            if(!notificationsEnabled) return;
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –±–æ—Ç—É
            const data = JSON.stringify({ action: 'test_notification' });
            tg.sendData(data);
        }

        function setAlarm() {
            if(!notificationsEnabled) return;
            const timeVal = document.getElementById('alarmTime').value;
            if(!timeVal) {
                alert("–í—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–µ–º—è!");
                return;
            }
            const data = JSON.stringify({ action: 'set_alarm', time: timeVal });
            tg.sendData(data);
        }

        // --- LOCATION & API ---
        function getLocation(type) {
            document.getElementById('locationStatus').innerText = "–ü–æ–∏—Å–∫...";
            if (type === 'gps') {
                navigator.geolocation.getCurrentPosition(
                    pos => fetchByCoords(pos.coords.latitude, pos.coords.longitude),
                    err => alert("GPS –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω")
                );
            } else {
                const city = document.getElementById('cityInput').value;
                if(city) { localStorage.setItem('savedCity', city); fetchByCity(city); }
            }
        }

        async function fetchByCoords(lat, lon) {
            const date = Math.floor(Date.now() / 1000);
            const url = `https://api.aladhan.com/v1/timings/${date}?latitude=${lat}&longitude=${lon}&method=3`;
            loadData(url);
        }

        async function fetchByCity(city) {
            const url = `https://api.aladhan.com/v1/timingsByCity?city=${city}&country=Azerbaijan&method=3`;
            loadData(url);
        }

        async function loadData(url) {
            try {
                const res = await fetch(url);
                const data = await res.json();
                currentTimings = data.data.timings || data.data.data.timings;
                document.getElementById('locationStatus').innerText = "–û–±–Ω–æ–≤–ª–µ–Ω–æ";
                renderHome();
            } catch(e) {
                document.getElementById('locationStatus').innerText = "–û—à–∏–±–∫–∞";
            }
        }

        function renderHome() {
            const list = document.getElementById('homeScheduleList');
            list.innerHTML = "";
            const ruNames = {Fajr:"–§–∞–¥–∂—Ä", Sunrise:"–í–æ—Å—Ö–æ–¥", Dhuhr:"–ó—É—Ö—Ä", Asr:"–ê—Å—Ä", Maghrib:"–ú–∞–≥—Ä–∏–±", Isha:"–ò—à–∞"};
            
            // –ù–∞–π—Ç–∏ —Å–ª–µ–¥—É—é—â–∏–π –Ω–∞–º–∞–∑
            const now = new Date();
            const nowMins = now.getHours() * 60 + now.getMinutes();
            let nextName = "Fajr", nextTime = currentTimings["Fajr"];
            
            ['Fajr','Sunrise','Dhuhr','Asr','Maghrib','Isha'].forEach(key => {
                const time = currentTimings[key];
                list.innerHTML += `<div class="prayer-row"><span>${ruNames[key]}</span><span class="prayer-time">${time}</span></div>`;
                
                const [h, m] = time.split(':').map(Number);
                if ((h*60+m) > nowMins && nextName === "Fajr") {
                    nextName = key; nextTime = time;
                }
            });
            
            document.getElementById('nextPrayerName').innerText = ruNames[nextName];
            document.getElementById('nextPrayerTime').innerText = nextTime;
        }

        // --- TABS ---
        function switchTab(tab, btn) {
            document.querySelectorAll('.container').forEach(e => e.classList.remove('active'));
            document.getElementById('tab-'+tab).classList.add('active');
            document.querySelectorAll('.tab-btn').forEach(e => e.classList.remove('active'));
            btn.classList.add('active');
        }

        function toggleTheme() {
            const isDark = document.body.getAttribute('data-theme') === 'dark';
            document.body.setAttribute('data-theme', isDark ? 'light' : 'dark');
            localStorage.setItem('theme', isDark ? 'light' : 'dark');
        }

        init();
    </script>
</body>
</html>

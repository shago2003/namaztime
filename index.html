<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Muslim App</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root { --bg-color: #F2F2F7; --card-bg: #FFFFFF; --text-color: #000000; --accent-color: #007AFF; }
        [data-theme="dark"] { --bg-color: #000000; --card-bg: #1C1C1E; --text-color: #FFFFFF; --accent-color: #0A84FF; }
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: var(--bg-color); color: var(--text-color); margin: 0; padding-bottom: 90px; }
        .container { display: none; padding: 20px; }
        .container.active { display: block; }
        .card { background: var(--card-bg); border-radius: 16px; padding: 20px; margin-bottom: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .btn-full { width: 100%; padding: 15px; background: var(--accent-color); color: white; border: none; border-radius: 12px; font-size: 16px; font-weight: 600; margin-top: 10px; cursor: pointer; }
        .hero-card { text-align: center; color: white; padding: 40px 20px; background: linear-gradient(135deg, #007AFF, #5AC8FA); border-radius: 16px; margin-bottom: 20px; }
        .prayer-row { display: flex; justify-content: space-between; padding: 15px 0; border-bottom: 1px solid #ccc; }
        .tab-bar { position: fixed; bottom: 0; width: 100%; height: 60px; background: var(--card-bg); display: flex; justify-content: space-around; border-top: 1px solid #ccc; z-index: 100;}
        .tab-btn { background: none; border: none; font-size: 24px; color: #888; }
        .tab-btn.active { color: var(--accent-color); }
    </style>
</head>
<body>

    <div id="tab-home" class="container active">
        <h1>–ê—Å—Å–∞–ª—è–º—É –∞–ª–µ–π–∫—É–º</h1>
        <div class="card hero-card">
            <div style="font-size:50px;">üïå</div>
            <div>–°–ª–µ–¥—É—é—â–∏–π –Ω–∞–º–∞–∑</div>
            <div style="font-size:40px; font-weight:800;" id="nextTime">--:--</div>
            <div id="nextName">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            <div id="locationBadge" style="font-size:12px; opacity:0.8; margin-top:10px;">üìç ...</div>
        </div>
        <div class="card" id="scheduleList"></div>
    </div>

    <div id="tab-tasbih" class="container">
        <h1 style="text-align:center">–¢–∞—Å–±–∏—Ö</h1>
        <div class="card" style="text-align:center; padding: 50px 20px;">
            <div id="tasbihCount" style="font-size: 80px; font-weight:bold;">0</div>
            <button class="btn-full" onclick="countTasbih()">–ù–∞–∂–∞—Ç—å üëÜ</button>
            <button style="background:none; border:none; color:red; margin-top:20px;" onclick="resetTasbih()">–°–±—Ä–æ—Å–∏—Ç—å</button>
        </div>
    </div>

    <div id="tab-settings" class="container">
        <h1>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h1>
        
        <div class="card">
            <h3>üîî –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (–ê–≤—Ç–æ–ø–∏–ª–æ—Ç)</h3>
            <p style="font-size:14px; color:gray;">–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ –û–î–ò–ù –†–ê–ó. –ë–æ—Ç –∑–∞–ø–æ–º–Ω–∏—Ç –≤–∞—à –≥–æ—Ä–æ–¥ –∏ –±—É–¥–µ—Ç –ø—Ä–∏—Å—ã–ª–∞—Ç—å –≤—Ä–µ–º—è –Ω–∞–º–∞–∑–∞ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.</p>
            <button class="btn-full" onclick="syncLocation()">üîÑ –í–∫–ª—é—á–∏—Ç—å –ê–≤—Ç–æ-–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</button>
        </div>

        <div class="card">
            <h3>üìç –õ–æ–∫–∞—Ü–∏—è</h3>
            <div id="currentCitySettings">–ê–≤—Ç–æ (GPS)</div>
            <button class="btn-full" style="background:#8E8E93" onclick="getLocation()">–û–±–Ω–æ–≤–∏—Ç—å GPS</button>
        </div>
        
        <div class="card">
             <button class="btn-full" style="background:#34C759" onclick="sendTest()">üîî –¢–µ—Å—Ç (–ü—Ä–æ–≤–µ—Ä–∫–∞)</button>
        </div>
    </div>

    <div class="tab-bar">
        <button class="tab-btn active" onclick="switchTab('home', this)">üè†</button>
        <button class="tab-btn" onclick="switchTab('tasbih', this)">üìø</button>
        <button class="tab-btn" onclick="switchTab('settings', this)">‚öôÔ∏è</button>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        let tasbih = localStorage.getItem('tasbih') || 0;
        let currentLat = 0, currentLon = 0;

        function init() {
            document.getElementById('tasbihCount').innerText = tasbih;
            getLocation();
        }

        function getLocation() {
            document.getElementById('locationBadge').innerText = "‚è≥ ...";
            navigator.geolocation.getCurrentPosition(
                pos => {
                    currentLat = pos.coords.latitude;
                    currentLon = pos.coords.longitude;
                    loadTimings(currentLat, currentLon);
                },
                err => {
                    // –ë–∞–∫—É –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                    currentLat = 40.4093; currentLon = 49.8671;
                    loadTimings(currentLat, currentLon);
                }
            );
        }

        function loadTimings(lat, lon) {
            const date = Math.floor(Date.now() / 1000);
            fetch(`https://api.aladhan.com/v1/timings/${date}?latitude=${lat}&longitude=${lon}&method=3`)
                .then(res => res.json())
                .then(data => renderTimings(data.data.timings));
        }

        function renderTimings(timings) {
            document.getElementById('locationBadge').innerText = "üìç GPS –ê–∫—Ç–∏–≤–µ–Ω";
            const list = document.getElementById('scheduleList');
            list.innerHTML = "";
            const names = {Fajr:"–§–∞–¥–∂—Ä", Sunrise:"–í–æ—Å—Ö–æ–¥", Dhuhr:"–ó—É—Ö—Ä", Asr:"–ê—Å—Ä", Maghrib:"–ú–∞–≥—Ä–∏–±", Isha:"–ò—à–∞"};
            
            const now = new Date();
            const nowMins = now.getHours() * 60 + now.getMinutes();
            let nextFound = false;

            for (let key in names) {
                const time = timings[key];
                list.innerHTML += `<div class="prayer-row"><span>${names[key]}</span><span style="font-weight:600; color:#007AFF">${time}</span></div>`;
                
                const [h, m] = time.split(':').map(Number);
                if (!nextFound && (h*60+m) > nowMins) {
                    document.getElementById('nextTime').innerText = time;
                    document.getElementById('nextName').innerText = names[key];
                    nextFound = true;
                }
            }
            if(!nextFound) {
                document.getElementById('nextTime').innerText = timings['Fajr'];
                document.getElementById('nextName').innerText = "–§–∞–¥–∂—Ä (–ó–∞–≤—Ç—Ä–∞)";
            }
        }

        // --- –ì–õ–ê–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø: –û–¢–ü–†–ê–í–ò–¢–¨ –õ–û–ö–ê–¶–ò–Æ –ë–û–¢–£ ---
        function syncLocation() {
            if(currentLat === 0) return alert("–°–Ω–∞—á–∞–ª–∞ –¥–æ–∂–¥–∏—Ç–µ—Å—å –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è GPS!");
            
            const offset = new Date().getTimezoneOffset();
            tg.sendData(JSON.stringify({ 
                action: 'sync_location', 
                lat: currentLat, 
                lon: currentLon, 
                offset: offset 
            }));
        }

        function sendTest() { tg.sendData(JSON.stringify({ action: 'test_notification' })); }
        
        function countTasbih() {
            tasbih++; document.getElementById('tasbihCount').innerText = tasbih;
            localStorage.setItem('tasbih', tasbih);
            if(tg.HapticFeedback) tg.HapticFeedback.impactOccurred('light');
        }
        function resetTasbih() { tasbih=0; document.getElementById('tasbihCount').innerText=0; localStorage.setItem('tasbih',0); }
        function switchTab(name, btn) {
            document.querySelectorAll('.container').forEach(el => el.classList.remove('active'));
            document.getElementById('tab-'+name).classList.add('active');
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            btn.classList.add('active');
        }

        init();
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Muslim App</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { font-family: -apple-system, sans-serif; background: #F2F2F7; margin: 0; padding-bottom: 80px; -webkit-user-select: none; }
        .container { display: none; padding: 20px; }
        .container.active { display: block; }
        
        .card { background: white; border-radius: 12px; padding: 15px; margin-bottom: 15px; }
        .hero { background: linear-gradient(135deg, #007AFF, #5AC8FA); color: white; text-align: center; padding: 30px; border-radius: 20px; margin-bottom: 20px; }
        .time { font-size: 50px; font-weight: bold; margin: 10px 0; }
        
        .row { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #eee; }
        .save-btn { width: 100%; padding: 15px; background: #34C759; color: white; border: none; border-radius: 12px; font-size: 18px; font-weight: bold; margin-top: 10px; cursor: pointer; }
        
        .tab-bar { position: fixed; bottom: 0; width: 100%; height: 60px; background: white; display: flex; border-top: 1px solid #ccc; }
        .tab-btn { flex: 1; border: none; background: none; font-size: 24px; color: #999; }
        .tab-btn.active { color: #007AFF; }
    </style>
</head>
<body>

    <div id="tab-home" class="container active">
        <div class="hero">
            <div>–°–ª–µ–¥—É—é—â–∏–π –Ω–∞–º–∞–∑</div>
            <div class="time" id="nextTime">--:--</div>
            <div id="nextName">...</div>
            <div id="geo" style="font-size:12px; margin-top:5px;">üìç –ü–æ–∏—Å–∫...</div>
        </div>
        <div class="card" id="list"></div>
    </div>

    <div id="tab-settings" class="container">
        <h1>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h1>
        <div class="card">
            <p>1. –í–≤–µ–¥–∏—Ç–µ –≥–æ—Ä–æ–¥ –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ GPS:</p>
            <input type="text" id="city" placeholder="Baku" style="width:100%; padding:10px; border:1px solid #ccc; border-radius:8px;">
            <button onclick="findCity()" style="margin-top:10px; padding:10px; width:100%; background:#007AFF; color:white; border:none; border-radius:8px;">–ù–∞–π—Ç–∏</button>
            <button onclick="getGPS()" style="margin-top:10px; padding:10px; width:100%; background:#8E8E93; color:white; border:none; border-radius:8px;">üìç GPS</button>
            <p>–¢–µ–∫—É—â–∏–π –≤—ã–±–æ—Ä: <b id="selCity">–ù–µ—Ç</b></p>
        </div>

        <div class="card" style="border: 2px solid #34C759;">
            <p style="text-align:center; font-weight:bold;">2. –ì–õ–ê–í–ù–û–ï –î–ï–ô–°–¢–í–ò–ï</p>
            <p style="text-align:center; font-size:13px;">–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É, —á—Ç–æ–±—ã –±–æ—Ç –∑–∞–ø–æ–º–Ω–∏–ª –≤–∞—Å:</p>
            <button class="save-btn" onclick="saveToBot()">üì° –°–û–•–†–ê–ù–ò–¢–¨ –í –ë–û–¢–ê</button>
        </div>
    </div>

    <div class="tab-bar">
        <button class="tab-btn active" onclick="sw('home', this)">üè†</button>
        <button class="tab-btn" onclick="sw('settings', this)">‚öôÔ∏è</button>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        let lat=0, lon=0;

        function init() { getGPS(); }

        function getGPS() {
            document.getElementById('geo').innerText = "‚è≥...";
            navigator.geolocation.getCurrentPosition(pos => {
                lat = pos.coords.latitude; lon = pos.coords.longitude;
                load(lat, lon);
            }, () => load(40.4093, 49.8671)); // Default Baku
        }

        function findCity() {
            let c = document.getElementById('city').value;
            fetch(`https://api.aladhan.com/v1/timingsByCity?city=${c}&country=&method=3`).then(r=>r.json()).then(d=>{
                if(d.code==200) {
                    lat = d.data.meta.latitude; lon = d.data.meta.longitude;
                    load(lat, lon);
                    document.getElementById('selCity').innerText = c;
                } else alert("–ù–µ –Ω–∞—à–µ–ª");
            });
        }

        function load(lt, ln) {
            let d = Math.floor(Date.now()/1000);
            fetch(`https://api.aladhan.com/v1/timings/${d}?latitude=${lt}&longitude=${ln}&method=3`).then(r=>r.json()).then(D=>{
                let t = D.data.timings;
                render(t);
                document.getElementById('geo').innerText = "üìç –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã OK";
                document.getElementById('selCity').innerText = "–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã OK";
            });
        }

        function render(t) {
            let l = document.getElementById('list'); l.innerHTML="";
            let n = {Fajr:"–§–∞–¥–∂—Ä", Dhuhr:"–ó—É—Ö—Ä", Asr:"–ê—Å—Ä", Maghrib:"–ú–∞–≥—Ä–∏–±", Isha:"–ò—à–∞"};
            let now = new Date().getHours()*60 + new Date().getMinutes();
            let nxt = false;
            for(k in n) {
                l.innerHTML += `<div class="row"><span>${n[k]}</span><b>${t[k]}</b></div>`;
                let [h,m] = t[k].split(':').map(Number);
                if(!nxt && (h*60+m)>now) {
                    document.getElementById('nextTime').innerText = t[k];
                    document.getElementById('nextName').innerText = n[k];
                    nxt=true;
                }
            }
        }

        function saveToBot() {
            if(lat==0) return alert("–°–Ω–∞—á–∞–ª–∞ –Ω–∞–π–¥–∏—Ç–µ –≥–æ—Ä–æ–¥!");
            // –í–û–¢ –ó–î–ï–°–¨ –û–¢–ü–†–ê–í–õ–Ø–ï–ú –°–ú–ï–©–ï–ù–ò–ï
            let off = new Date().getTimezoneOffset();
            tg.sendData(JSON.stringify({ action: 'sync_location', lat: lat, lon: lon, offset: off }));
        }

        function sw(id, b) {
            document.querySelectorAll('.container').forEach(e=>e.classList.remove('active'));
            document.getElementById('tab-'+id).classList.add('active');
            document.querySelectorAll('.tab-btn').forEach(e=>e.classList.remove('active'));
            b.classList.add('active');
        }
        init();
    </script>
</body>
</html>

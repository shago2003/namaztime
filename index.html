<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Muslim App</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg-color: #F2F2F7;
            --card-bg: #FFFFFF;
            --text-color: #000000;
            --secondary-text: #8E8E93;
            --accent-color: #007AFF;
            --success-color: #34C759;
            --danger-color: #FF3B30;
            --border-color: #C6C6C8;
            --tab-bar-bg: #F9F9F9;
        }

        [data-theme="dark"] {
            --bg-color: #000000;
            --card-bg: #1C1C1E;
            --text-color: #FFFFFF;
            --secondary-text: #8E8E93;
            --accent-color: #0A84FF;
            --border-color: #38383A;
            --tab-bar-bg: #1C1C1E;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0; padding: 0; padding-bottom: 90px;
            overflow-x: hidden; -webkit-tap-highlight-color: transparent;
            user-select: none;
        }

        /* --- –ö–û–ù–¢–ï–ô–ù–ï–†–´ --- */
        .container { display: none; padding: 20px; animation: fadeIn 0.3s ease; }
        .container.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        h1 { font-size: 34px; font-weight: 700; margin: 10px 0 20px 0; letter-spacing: -0.5px; }
        h2 { font-size: 13px; text-transform: uppercase; color: var(--secondary-text); margin: 20px 0 8px 15px; }

        /* --- –ö–ê–†–¢–û–ß–ö–ò --- */
        .card {
            background: var(--card-bg);
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 20px;
        }
        
        .list-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 16px;
            border-bottom: 0.5px solid var(--border-color);
            background: var(--card-bg);
        }
        .list-item:last-child { border-bottom: none; }

        .ios-input {
            border: none; background: transparent; font-size: 17px;
            color: var(--text-color); width: 100%; outline: none;
        }
        .search-btn {
            background: var(--accent-color); color: white; border: none;
            border-radius: 6px; padding: 6px 12px; font-size: 14px; font-weight: 600; cursor: pointer;
        }

        /* --- –ì–õ–ê–í–ù–´–ô –≠–ö–†–ê–ù --- */
        .hero-card {
            background: linear-gradient(135deg, #007AFF, #5AC8FA);
            color: white; padding: 30px 20px; border-radius: 20px;
            text-align: center; box-shadow: 0 10px 20px rgba(0,122,255, 0.3);
            margin-bottom: 25px;
        }
        .hero-time { font-size: 60px; font-weight: 700; letter-spacing: -2px; line-height: 1; margin: 10px 0; }
        .hero-label { font-size: 18px; font-weight: 500; opacity: 0.9; }
        .hero-location { font-size: 14px; opacity: 0.7; margin-top: 5px; display: flex; align-items: center; justify-content: center; gap: 5px;}

        /* --- –¢–ê–°–ë–ò–• --- */
        .tasbih-circle {
            width: 250px; height: 250px; border-radius: 50%;
            background: var(--card-bg); border: 1px solid var(--border-color);
            display: flex; align-items: center; justify-content: center; flex-direction: column;
            margin: 40px auto; box-shadow: 0 10px 30px rgba(0,0,0,0.05);
            transition: transform 0.1s; cursor: pointer;
        }
        .tasbih-circle:active { transform: scale(0.95); background: var(--bg-color); }
        .count-text { font-size: 80px; font-weight: 700; font-variant-numeric: tabular-nums; }

        /* --- –ü–ï–†–ï–ö–õ–Æ–ß–ê–¢–ï–õ–¨ --- */
        .switch { position: relative; display: inline-block; width: 51px; height: 31px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
            background-color: #E9E9EA; transition: .4s; border-radius: 34px;
        }
        .slider:before {
            position: absolute; content: ""; height: 27px; width: 27px;
            left: 2px; bottom: 2px; background-color: white; transition: .4s; border-radius: 50%; box-shadow: 0 3px 8px rgba(0,0,0,0.15);
        }
        input:checked + .slider { background-color: var(--success-color); }
        input:checked + .slider:before { transform: translateX(20px); }
        [data-theme="dark"] .slider { background-color: #39393D; }

        /* --- –ù–ò–ñ–ù–ï–ï –ú–ï–ù–Æ --- */
        .tab-bar {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: var(--tab-bar-bg);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border-top: 0.5px solid var(--border-color);
            display: flex; justify-content: space-around;
            padding-bottom: env(safe-area-inset-bottom);
            height: 55px; z-index: 1000;
        }
        .tab-btn {
            background: none; border: none; flex: 1;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: var(--secondary-text); font-size: 10px; font-weight: 500;
        }
        .tab-btn.active { color: var(--accent-color); }
        .tab-icon { font-size: 24px; margin-bottom: 3px; }
        .btn-text { color: var(--accent-color); font-size: 17px; background: none; border: none; cursor: pointer; }
        .btn-danger { color: var(--danger-color); }
    </style>
</head>
<body>

    <div id="tab-home" class="container active">
        <h1>–û–±–∑–æ—Ä</h1>
        <div class="hero-card">
            <div class="hero-label">–°–ª–µ–¥—É—é—â–∏–π –Ω–∞–º–∞–∑</div>
            <div class="hero-time" id="nextTime">--:--</div>
            <div class="hero-label" id="nextName">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            <div class="hero-location" id="locationBadge">üìç –ü–æ–∏—Å–∫...</div>
        </div>
        <h2>–†–ê–°–ü–ò–°–ê–ù–ò–ï</h2>
        <div class="card" id="scheduleList"></div>
    </div>

    <div id="tab-tasbih" class="container">
        <h1>–¢–∞—Å–±–∏—Ö</h1>
        <div class="tasbih-circle" onclick="countTasbih()">
            <div class="count-text" id="tasbihCount">0</div>
            <div style="color: var(--secondary-text); margin-top: 10px;">–ù–∞–∂–∞—Ç—å</div>
        </div>
        <div style="text-align: center;">
            <button class="btn-text btn-danger" onclick="resetTasbih()">–°–±—Ä–æ—Å–∏—Ç—å —Å—á–µ—Ç—á–∏–∫</button>
        </div>
    </div>

    <div id="tab-settings" class="container">
        <h1>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h1>
        <h2>–û–°–ù–û–í–ù–´–ï</h2>
        <div class="card">
            <div class="list-item">
                <span>–¢–µ–º–Ω–∞—è —Ç–µ–º–∞</span>
                <label class="switch">
                    <input type="checkbox" id="themeToggle" onchange="toggleTheme()">
                    <span class="slider"></span>
                </label>
            </div>
            <div class="list-item">
                <span>–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (–ê–≤—Ç–æ)</span>
                <label class="switch">
                    <input type="checkbox" id="notifToggle" onchange="toggleNotifications()">
                    <span class="slider"></span>
                </label>
            </div>
        </div>

        <h2>–õ–û–ö–ê–¶–ò–Ø</h2>
        <div class="card">
            <div class="list-item">
                <input type="text" id="cityInput" class="ios-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –≥–æ—Ä–æ–¥ (–Ω–∞–ø—Ä. Baku)">
                <button class="search-btn" onclick="searchCity(null, true)">–ù–∞–π—Ç–∏</button>
            </div>
            <div class="list-item" onclick="getLocation(true)" style="cursor: pointer;">
                <span style="color: var(--accent-color); display:flex; align-items:center;">
                    <span style="font-size:20px; margin-right:8px;">üìç</span> 
                    –û–±–Ω–æ–≤–∏—Ç—å GPS –∏ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –ë–æ—Ç—É
                </span>
            </div>
            <div class="list-item">
                <span style="color: var(--secondary-text); font-size:14px;">–¢–µ–∫—É—â–∏–π –≥–æ—Ä–æ–¥:</span>
                <span id="currentCityName" style="font-weight:600;">–ù–µ –≤—ã–±—Ä–∞–Ω</span>
            </div>
        </div>

        <h2>–¢–ï–°–¢</h2>
        <div class="card">
            <div class="list-item" onclick="sendTest()" style="cursor: pointer;">
                <span style="color: var(--accent-color)">üîî –¢–µ—Å—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</span>
            </div>
        </div>
    </div>

    <div class="tab-bar">
        <button class="tab-btn active" onclick="switchTab('home', this)">
            <div class="tab-icon">üè†</div>–ì–ª–∞–≤–Ω–∞—è
        </button>
        <button class="tab-btn" onclick="switchTab('tasbih', this)">
            <div class="tab-icon">üìø</div>–¢–∞—Å–±–∏—Ö
        </button>
        <button class="tab-btn" onclick="switchTab('settings', this)">
            <div class="tab-icon">‚öôÔ∏è</div>–ù–∞—Å—Ç—Ä–æ–π–∫–∏
        </button>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        
        let tasbih = parseInt(localStorage.getItem('tasbih')) || 0;
        let isDark = localStorage.getItem('theme') === 'dark';
        let notifEnabled = localStorage.getItem('notifEnabled') === 'true';
        let currentLat = 0, currentLon = 0;

        function init() {
            if(isDark) document.body.setAttribute('data-theme', 'dark');
            document.getElementById('themeToggle').checked = isDark;
            document.getElementById('notifToggle').checked = notifEnabled;
            document.getElementById('tasbihCount').innerText = tasbih;

            const savedCity = localStorage.getItem('savedCity');
            if (savedCity) {
                document.getElementById('cityInput').value = savedCity;
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –¢–ò–•–û (false), –Ω–µ –±–µ—Å–ø–æ–∫–æ—è –±–æ—Ç–∞
                searchCity(savedCity, false);
            } else {
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –¢–ò–•–û (false)
                getLocation(false);
            }
        }

        // --- –õ–û–ì–ò–ö–ê ---
        
        // –ü–æ–ª—É—á–∏—Ç—å GPS
        // isManual = true (–µ—Å–ª–∏ –Ω–∞–∂–∞–ª –∫–Ω–æ–ø–∫—É), false (–µ—Å–ª–∏ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è)
        function getLocation(isManual = false) {
            if(isManual) {
                document.getElementById('locationBadge').innerText = "‚è≥ GPS...";
                document.getElementById('currentCityName').innerText = "–ü–æ–∏—Å–∫ GPS...";
            }
            
            navigator.geolocation.getCurrentPosition(
                pos => {
                    currentLat = pos.coords.latitude;
                    currentLon = pos.coords.longitude;
                    localStorage.removeItem('savedCity');
                    document.getElementById('cityInput').value = ""; 
                    
                    loadTimingsByCoords(currentLat, currentLon, isManual);
                },
                err => {
                    if(isManual) alert("GPS –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.");
                    // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –ë–∞–∫—É (—Ç–∏—Ö–æ)
                    loadTimingsByCoords(40.4093, 49.8671, false);
                }
            );
        }

        function searchCity(cityOverride, isManual = false) {
            let city = cityOverride || document.getElementById('cityInput').value;
            if(!city) return;

            if(isManual) document.getElementById('locationBadge').innerText = "‚è≥...";

            fetch(`https://api.aladhan.com/v1/timingsByCity?city=${city}&country=&method=3`)
                .then(res => res.json())
                .then(data => {
                    if(data.code === 200) {
                        currentLat = data.data.meta.latitude;
                        currentLon = data.data.meta.longitude;
                        localStorage.setItem('savedCity', city);
                        
                        renderTimings(data.data.timings);
                        
                        document.getElementById('currentCityName').innerText = city;
                        document.getElementById('locationBadge').innerText = "üìç " + city;
                        
                        // –û–¢–ü–†–ê–í–õ–Ø–ï–ú –ë–û–¢–£ –¢–û–õ–¨–ö–û –ï–°–õ–ò –≠–¢–û –†–£–ß–ù–û–ï –î–ï–ô–°–¢–í–ò–ï
                        if(isManual && notifEnabled) syncLocationToBot();
                    } else if(isManual) {
                        alert("–ì–æ—Ä–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω!");
                    }
                })
                .catch(e => console.log(e));
        }

        function loadTimingsByCoords(lat, lon, isManual) {
            const date = Math.floor(Date.now() / 1000);
            fetch(`https://api.aladhan.com/v1/timings/${date}?latitude=${lat}&longitude=${lon}&method=3`)
                .then(res => res.json())
                .then(data => {
                    renderTimings(data.data.timings);
                    document.getElementById('currentCityName').innerText = "GPS –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã";
                    document.getElementById('locationBadge').innerText = "üìç –ú–æ—è –ª–æ–∫–∞—Ü–∏—è";
                    
                    // –û–¢–ü–†–ê–í–õ–Ø–ï–ú –ë–û–¢–£ –¢–û–õ–¨–ö–û –ï–°–õ–ò –≠–¢–û –†–£–ß–ù–û–ï –î–ï–ô–°–¢–í–ò–ï
                    if(isManual && notifEnabled) syncLocationToBot();
                });
        }

        function syncLocationToBot() {
            if (currentLat === 0) return alert("–°–Ω–∞—á–∞–ª–∞ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç–µ –≥–æ—Ä–æ–¥!");
            
            const offset = new Date().getTimezoneOffset();
            tg.sendData(JSON.stringify({ 
                action: 'sync_location', 
                lat: currentLat, 
                lon: currentLon, 
                offset: offset 
            }));
            // tg.close();
        }

        function toggleNotifications() {
            notifEnabled = document.getElementById('notifToggle').checked;
            localStorage.setItem('notifEnabled', notifEnabled);
            
            if (notifEnabled) {
                // –ï—Å–ª–∏ –í–ö–õ–Æ–ß–ò–õ–ò –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å - –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ
                syncLocationToBot();
            } else {
                alert("–ê–≤—Ç–æ-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤—ã–∫–ª—é—á–µ–Ω—ã.");
            }
            if(tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('success');
        }

        // --- –í–ò–ó–£–ê–õ ---
        function renderTimings(timings) {
            const list = document.getElementById('scheduleList');
            list.innerHTML = "";
            const names = {Fajr:"–§–∞–¥–∂—Ä", Sunrise:"–í–æ—Å—Ö–æ–¥", Dhuhr:"–ó—É—Ö—Ä", Asr:"–ê—Å—Ä", Maghrib:"–ú–∞–≥—Ä–∏–±", Isha:"–ò—à–∞"};
            const now = new Date();
            const nowMins = now.getHours() * 60 + now.getMinutes();
            let nextFound = false;

            for (let key in names) {
                const time = timings[key];
                list.innerHTML += `
                    <div class="list-item">
                        <span style="font-weight:500;">${names[key]}</span>
                        <span style="font-weight:600; color:var(--accent-color); font-size:17px;">${time}</span>
                    </div>
                `;
                const [h, m] = time.split(':').map(Number);
                if (!nextFound && (h*60+m) > nowMins) {
                    document.getElementById('nextTime').innerText = time;
                    document.getElementById('nextName').innerText = names[key];
                    nextFound = true;
                }
            }
            if(!nextFound) {
                document.getElementById('nextTime').innerText = timings['Fajr'];
                document.getElementById('nextName').innerText = "–§–∞–¥–∂—Ä (–ó–∞–≤—Ç—Ä–∞)";
            }
        }

        function toggleTheme() {
            isDark = !isDark;
            document.body.setAttribute('data-theme', isDark ? 'dark' : 'light');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            if(tg.HapticFeedback) tg.HapticFeedback.selectionChanged();
        }
        function countTasbih() {
            tasbih++; document.getElementById('tasbihCount').innerText = tasbih;
            localStorage.setItem('tasbih', tasbih);
            if(tg.HapticFeedback) tg.HapticFeedback.impactOccurred('light');
        }
        function resetTasbih() { tasbih=0; document.getElementById('tasbihCount').innerText=0; localStorage.setItem('tasbih',0); }
        function sendTest() { tg.sendData(JSON.stringify({ action: 'test_notification' })); }
        function switchTab(name, btn) {
            document.querySelectorAll('.container').forEach(el => el.classList.remove('active'));
            document.getElementById('tab-'+name).classList.add('active');
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            btn.classList.add('active');
        }

        init();
    </script>
</body>
</html>

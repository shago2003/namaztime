<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Muslim App</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg-color: #F2F2F7;
            --card-bg: #FFFFFF;
            --text-color: #000000;
            --secondary-text: #8E8E93;
            --accent-color: #007AFF;
            --success-color: #34C759;
            --danger-color: #FF3B30;
            --border-color: #C6C6C8;
            --tab-bar-bg: #F9F9F9;
        }

        [data-theme="dark"] {
            --bg-color: #000000;
            --card-bg: #1C1C1E;
            --text-color: #FFFFFF;
            --secondary-text: #8E8E93;
            --accent-color: #0A84FF;
            --border-color: #38383A;
            --tab-bar-bg: #1C1C1E;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0; padding: 0; padding-bottom: 90px;
            overflow-x: hidden; -webkit-tap-highlight-color: transparent;
            user-select: none;
        }

        /* --- –ö–û–ù–¢–ï–ô–ù–ï–†–´ --- */
        .container { display: none; padding: 20px; animation: fadeIn 0.3s ease; }
        .container.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        h1 { font-size: 34px; font-weight: 700; margin: 10px 0 20px 0; letter-spacing: -0.5px; }
        h2 { font-size: 13px; text-transform: uppercase; color: var(--secondary-text); margin: 20px 0 8px 15px; }

        /* --- –ö–ê–†–¢–û–ß–ö–ò (iOS Style) --- */
        .card {
            background: var(--card-bg);
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 20px;
        }
        
        .list-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 16px;
            border-bottom: 0.5px solid var(--border-color);
            background: var(--card-bg);
        }
        .list-item:last-child { border-bottom: none; }

        /* –ò–ù–ü–£–¢ –î–õ–Ø –ì–û–†–û–î–ê */
        .ios-input {
            border: none;
            background: transparent;
            font-size: 17px;
            color: var(--text-color);
            width: 100%;
            outline: none;
        }
        .search-btn {
            background: var(--accent-color);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 6px 12px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
        }

        /* --- –ì–õ–ê–í–ù–´–ô –≠–ö–†–ê–ù --- */
        .hero-card {
            background: linear-gradient(135deg, #007AFF, #5AC8FA);
            color: white;
            padding: 30px 20px;
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 10px 20px rgba(0,122,255, 0.3);
            margin-bottom: 25px;
        }
        .hero-time { font-size: 60px; font-weight: 700; letter-spacing: -2px; line-height: 1; margin: 10px 0; }
        .hero-label { font-size: 18px; font-weight: 500; opacity: 0.9; }
        .hero-location { font-size: 14px; opacity: 0.7; margin-top: 5px; display: flex; align-items: center; justify-content: center; gap: 5px;}

        /* --- –¢–ê–°–ë–ò–• --- */
        .tasbih-circle {
            width: 250px; height: 250px;
            border-radius: 50%;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            display: flex; align-items: center; justify-content: center; flex-direction: column;
            margin: 40px auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.05);
            transition: transform 0.1s;
            cursor: pointer;
        }
        .tasbih-circle:active { transform: scale(0.95); background: var(--bg-color); }
        .count-text { font-size: 80px; font-weight: 700; font-variant-numeric: tabular-nums; }

        /* --- –ü–ï–†–ï–ö–õ–Æ–ß–ê–¢–ï–õ–¨ --- */
        .switch { position: relative; display: inline-block; width: 51px; height: 31px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
            background-color: #E9E9EA; transition: .4s; border-radius: 34px;
        }
        .slider:before {
            position: absolute; content: ""; height: 27px; width: 27px;
            left: 2px; bottom: 2px; background-color: white; transition: .4s; border-radius: 50%; box-shadow: 0 3px 8px rgba(0,0,0,0.15);
        }
        input:checked + .slider { background-color: var(--success-color); }
        input:checked + .slider:before { transform: translateX(20px); }
        [data-theme="dark"] .slider { background-color: #39393D; }

        /* --- –ù–ò–ñ–ù–ï–ï –ú–ï–ù–Æ --- */
        .tab-bar {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: var(--tab-bar-bg);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border-top: 0.5px solid var(--border-color);
            display: flex; justify-content: space-around;
            padding-bottom: env(safe-area-inset-bottom);
            height: 55px; z-index: 1000;
        }
        .tab-btn {
            background: none; border: none;
            flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: var(--secondary-text); font-size: 10px; font-weight: 500;
        }
        .tab-btn.active { color: var(--accent-color); }
        .tab-icon { font-size: 24px; margin-bottom: 3px; }
        .btn-text { color: var(--accent-color); font-size: 17px; background: none; border: none; cursor: pointer; }
        .btn-danger { color: var(--danger-color); }
    </style>
</head>
<body>

    <div id="tab-home" class="container active">
        <h1>–û–±–∑–æ—Ä</h1>
        <div class="hero-card">
            <div class="hero-label">–°–ª–µ–¥—É—é—â–∏–π –Ω–∞–º–∞–∑</div>
            <div class="hero-time" id="nextTime">--:--</div>
            <div class="hero-label" id="nextName">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            <div class="hero-location" id="locationBadge">üìç –ü–æ–∏—Å–∫...</div>
        </div>

        <h2>–†–ê–°–ü–ò–°–ê–ù–ò–ï</h2>
        <div class="card" id="scheduleList"></div>
    </div>

    <div id="tab-tasbih" class="container">
        <h1>–¢–∞—Å–±–∏—Ö</h1>
        <div class="tasbih-circle" onclick="countTasbih()">
            <div class="count-text" id="tasbihCount">0</div>
            <div style="color: var(--secondary-text); margin-top: 10px;">–ù–∞–∂–∞—Ç—å</div>
        </div>
        <div style="text-align: center;">
            <button class="btn-text btn-danger" onclick="resetTasbih()">–°–±—Ä–æ—Å–∏—Ç—å —Å—á–µ—Ç—á–∏–∫</button>
        </div>
    </div>

    <div id="tab-settings" class="container">
        <h1>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h1>

        <h2>–û–°–ù–û–í–ù–´–ï</h2>
        <div class="card">
            <div class="list-item">
                <span>–¢–µ–º–Ω–∞—è —Ç–µ–º–∞</span>
                <label class="switch">
                    <input type="checkbox" id="themeToggle" onchange="toggleTheme()">
                    <span class="slider"></span>
                </label>
            </div>
            <div class="list-item">
                <span>–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (–ê–≤—Ç–æ)</span>
                <label class="switch">
                    <input type="checkbox" id="notifToggle" onchange="toggleNotifications()">
                    <span class="slider"></span>
                </label>
            </div>
        </div>

        <h2>–õ–û–ö–ê–¶–ò–Ø</h2>
        <div class="card">
            <div class="list-item">
                <input type="text" id="cityInput" class="ios-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –≥–æ—Ä–æ–¥ (–Ω–∞–ø—Ä. Baku)">
                <button class="search-btn" onclick="searchCity()">–ù–∞–π—Ç–∏</button>
            </div>
            <div class="list-item" onclick="getLocation()" style="cursor: pointer;">
                <span style="color: var(--accent-color); display:flex; align-items:center;">
                    <span style="font-size:20px; margin-right:8px;">üìç</span> 
                    –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –º–æ–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ (GPS)
                </span>
            </div>
            <div class="list-item">
                <span style="color: var(--secondary-text); font-size:14px;">–¢–µ–∫—É—â–∏–π –≥–æ—Ä–æ–¥:</span>
                <span id="currentCityName" style="font-weight:600;">–ù–µ –≤—ã–±—Ä–∞–Ω</span>
            </div>
        </div>

        <h2>–¢–ï–°–¢</h2>
        <div class="card">
            <div class="list-item" onclick="sendTest()" style="cursor: pointer;">
                <span style="color: var(--accent-color)">üîî –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ—Å—Ç</span>
            </div>
        </div>
    </div>

    <div class="tab-bar">
        <button class="tab-btn active" onclick="switchTab('home', this)">
            <div class="tab-icon">üè†</div>–ì–ª–∞–≤–Ω–∞—è
        </button>
        <button class="tab-btn" onclick="switchTab('tasbih', this)">
            <div class="tab-icon">üìø</div>–¢–∞—Å–±–∏—Ö
        </button>
        <button class="tab-btn" onclick="switchTab('settings', this)">
            <div class="tab-icon">‚öôÔ∏è</div>–ù–∞—Å—Ç—Ä–æ–π–∫–∏
        </button>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        
        let tasbih = parseInt(localStorage.getItem('tasbih')) || 0;
        let isDark = localStorage.getItem('theme') === 'dark';
        let notifEnabled = localStorage.getItem('notifEnabled') === 'true';
        
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
        let currentLat = 0;
        let currentLon = 0;

        function init() {
            if(isDark) document.body.setAttribute('data-theme', 'dark');
            document.getElementById('themeToggle').checked = isDark;
            document.getElementById('notifToggle').checked = notifEnabled;
            document.getElementById('tasbihCount').innerText = tasbih;

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π –≥–æ—Ä–æ–¥ –∏–ª–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
            const savedCity = localStorage.getItem('savedCity');
            if (savedCity) {
                document.getElementById('cityInput').value = savedCity;
                searchCity(savedCity);
            } else {
                getLocation(); // –ï—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ—Ç, –ø—Ä–æ–±—É–µ–º GPS
            }
        }

        // --- –õ–û–ì–ò–ö–ê –ì–û–†–û–î–û–í –ò GPS ---
        
        // 1. –ü–æ–∏—Å–∫ –ø–æ GPS
        function getLocation() {
            document.getElementById('locationBadge').innerText = "‚è≥ GPS...";
            document.getElementById('currentCityName').innerText = "–ü–æ–∏—Å–∫ GPS...";
            
            navigator.geolocation.getCurrentPosition(
                pos => {
                    currentLat = pos.coords.latitude;
                    currentLon = pos.coords.longitude;
                    // –û—á–∏—â–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π –≥–æ—Ä–æ–¥, —Ç–∞–∫ –∫–∞–∫ –∏—Å–ø–æ–ª—å–∑—É–µ–º GPS
                    localStorage.removeItem('savedCity');
                    document.getElementById('cityInput').value = ""; 
                    
                    loadTimingsByCoords(currentLat, currentLon);
                },
                err => {
                    alert("GPS –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç. –í–≤–µ–¥–∏—Ç–µ –≥–æ—Ä–æ–¥ –≤—Ä—É—á–Ω—É—é.");
                    document.getElementById('locationBadge').innerText = "‚ùå –ù–µ—Ç GPS";
                }
            );
        }

        // 2. –ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –≥–æ—Ä–æ–¥–∞
        function searchCity(cityOverride) {
            let city = cityOverride || document.getElementById('cityInput').value;
            if(!city) return alert("–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –≥–æ—Ä–æ–¥–∞");

            document.getElementById('locationBadge').innerText = "‚è≥ –ü–æ–∏—Å–∫...";
            document.getElementById('currentCityName').innerText = "–ó–∞–≥—Ä—É–∑–∫–∞...";

            // –ò—Å–ø–æ–ª—å–∑—É–µ–º API –¥–ª—è –ø–æ–∏—Å–∫–∞ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –≥–æ—Ä–æ–¥–∞
            const url = `https://api.aladhan.com/v1/timingsByCity?city=${city}&country=&method=3`;
            
            fetch(url)
                .then(res => res.json())
                .then(data => {
                    if(data.code === 200) {
                        // –°–û–•–†–ê–ù–Ø–ï–ú –ö–û–û–†–î–ò–ù–ê–¢–´ –ì–û–†–û–î–ê!
                        // –≠—Ç–æ –≤–∞–∂–Ω–æ, —á—Ç–æ–±—ã –±–æ—Ç –∑–Ω–∞–ª —Ç–æ—á–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
                        currentLat = data.data.meta.latitude;
                        currentLon = data.data.meta.longitude;
                        
                        localStorage.setItem('savedCity', city); // –ó–∞–ø–æ–º–∏–Ω–∞–µ–º –≤—ã–±–æ—Ä
                        
                        renderTimings(data.data.timings);
                        
                        document.getElementById('currentCityName').innerText = city;
                        document.getElementById('locationBadge').innerText = "üìç " + city;
                        
                        // –ï—Å–ª–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤–∫–ª—é—á–µ–Ω—ã - –æ–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞—Ü–∏—é —É –±–æ—Ç–∞
                        if(notifEnabled) syncLocationToBot();
                    } else {
                        alert("–ì–æ—Ä–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω!");
                    }
                })
                .catch(e => alert("–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è"));
        }

        function loadTimingsByCoords(lat, lon) {
            const date = Math.floor(Date.now() / 1000);
            fetch(`https://api.aladhan.com/v1/timings/${date}?latitude=${lat}&longitude=${lon}&method=3`)
                .then(res => res.json())
                .then(data => {
                    renderTimings(data.data.timings);
                    document.getElementById('currentCityName').innerText = "GPS –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã";
                    document.getElementById('locationBadge').innerText = "üìç –ú–æ—è –ª–æ–∫–∞—Ü–∏—è";
                    if(notifEnabled) syncLocationToBot();
                });
        }

        // --- –û–¢–†–ò–°–û–í–ö–ê ---
        function renderTimings(timings) {
            const list = document.getElementById('scheduleList');
            list.innerHTML = "";
            const names = {Fajr:"–§–∞–¥–∂—Ä", Sunrise:"–í–æ—Å—Ö–æ–¥", Dhuhr:"–ó—É—Ö—Ä", Asr:"–ê—Å—Ä", Maghrib:"–ú–∞–≥—Ä–∏–±", Isha:"–ò—à–∞"};
            const now = new Date();
            const nowMins = now.getHours() * 60 + now.getMinutes();
            let nextFound = false;

            for (let key in names) {
                const time = timings[key];
                list.innerHTML += `
                    <div class="list-item">
                        <span style="font-weight:500;">${names[key]}</span>
                        <span style="font-weight:600; color:var(--accent-color); font-size:17px;">${time}</span>
                    </div>
                `;
                const [h, m] = time.split(':').map(Number);
                if (!nextFound && (h*60+m) > nowMins) {
                    document.getElementById('nextTime').innerText = time;
                    document.getElementById('nextName').innerText = names[key];
                    nextFound = true;
                }
            }
            if(!nextFound) {
                document.getElementById('nextTime').innerText = timings['Fajr'];
                document.getElementById('nextName').innerText = "–§–∞–¥–∂—Ä (–ó–∞–≤—Ç—Ä–∞)";
            }
        }

        // --- –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø ---
        function toggleNotifications() {
            notifEnabled = document.getElementById('notifToggle').checked;
            localStorage.setItem('notifEnabled', notifEnabled);
            
            if (notifEnabled) {
                syncLocationToBot();
            } else {
                alert("–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ—Ç–∫–ª—é—á–µ–Ω—ã (–ª–æ–∫–∞–ª—å–Ω–æ).");
            }
            if(tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('success');
        }

        function syncLocationToBot() {
            if (currentLat === 0) {
                alert("–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥ –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ GPS!");
                document.getElementById('notifToggle').checked = false;
                return;
            }
            const offset = new Date().getTimezoneOffset();
            tg.sendData(JSON.stringify({ 
                action: 'sync_location', 
                lat: currentLat, 
                lon: currentLon, 
                offset: offset 
            }));
            // tg.close(); // –ú–æ–∂–Ω–æ –∑–∞–∫—Ä—ã–≤–∞—Ç—å, –∞ –º–æ–∂–Ω–æ –Ω–µ—Ç
        }

        // --- –û–°–¢–ê–õ–¨–ù–û–ï ---
        function toggleTheme() {
            isDark = !isDark;
            document.body.setAttribute('data-theme', isDark ? 'dark' : 'light');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            if(tg.HapticFeedback) tg.HapticFeedback.selectionChanged();
        }
        function countTasbih() {
            tasbih++; document.getElementById('tasbihCount').innerText = tasbih;
            localStorage.setItem('tasbih', tasbih);
            if(tg.HapticFeedback) tg.HapticFeedback.impactOccurred('light');
        }
        function resetTasbih() { tasbih=0; document.getElementById('tasbihCount').innerText=0; localStorage.setItem('tasbih',0); }
        function sendTest() { tg.sendData(JSON.stringify({ action: 'test_notification' })); }
        function switchTab(name, btn) {
            document.querySelectorAll('.container').forEach(el => el.classList.remove('active'));
            document.getElementById('tab-'+name).classList.add('active');
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            btn.classList.add('active');
        }

        init();
    </script>
</body>
</html>

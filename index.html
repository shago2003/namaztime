<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Muslim App</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* --- Muslim iOS Minimalist Theme --- */
        :root {
            --bg: #F2F2F7;
            --card-bg: #FFFFFF;
            --text: #000000;
            --secondary: #8E8E93;
            --accent: #10B981; /* –ò–∑—É–º—Ä—É–¥–Ω—ã–π */
            --danger: #FF3B30;
            --border: #E5E5EA;
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --bg: #000000;
                --card-bg: #1C1C1E;
                --text: #FFFFFF;
                --secondary: #98989D;
                --border: #38383A;
            }
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", Roboto, sans-serif; background: var(--bg); color: var(--text); padding-bottom: 100px; }

        /* HERO HEADER */
        .hero {
            background: linear-gradient(135deg, #10B981, #047857);
            padding: 30px 20px;
            color: white;
            border-bottom-left-radius: 24px;
            border-bottom-right-radius: 24px;
            box-shadow: 0 4px 20px rgba(16, 185, 129, 0.3);
            text-align: center;
            margin-bottom: 20px;
        }
        .hero-title { font-size: 14px; opacity: 0.9; text-transform: uppercase; letter-spacing: 1px; }
        .hero-name { font-size: 32px; font-weight: 800; margin: 4px 0; }
        .hero-timer { background: rgba(255,255,255,0.2); padding: 6px 14px; border-radius: 20px; font-size: 15px; display: inline-block; backdrop-filter: blur(5px); }

        /* CONTENT */
        .container { padding: 0 16px; max-width: 480px; margin: 0 auto; }
        .card { background: var(--card-bg); border-radius: 16px; padding: 16px; margin-bottom: 16px; }
        
        /* SEARCH */
        .search-box { display: flex; gap: 8px; margin-bottom: 12px; }
        .input-loc { flex: 1; padding: 12px; border-radius: 12px; border: none; background: rgba(118,118,128,0.12); color: var(--text); font-size: 16px; }
        .btn-icon { width: 44px; background: var(--accent); color: white; border: none; border-radius: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 18px; }

        /* PRAYER LIST */
        .row { display: flex; justify-content: space-between; align-items: center; padding: 14px 0; border-bottom: 0.5px solid var(--border); }
        .row:last-child { border-bottom: none; }
        .row.active { color: var(--accent); font-weight: 700; }

        /* COMPASS (QIBLA) */
        .compass-container { position: relative; width: 260px; height: 260px; margin: 20px auto; }
        .compass-dial {
            width: 100%; height: 100%;
            border-radius: 50%;
            border: 4px solid var(--border);
            position: relative;
            transition: transform 0.1s ease-out;
            background: radial-gradient(circle, var(--card-bg) 60%, rgba(118,118,128,0.05) 70%);
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        .compass-arrow {
            position: absolute; top: 50%; left: 50%;
            width: 6px; height: 110px;
            background: var(--secondary); /* –°–µ–≤–µ—Ä */
            transform: translate(-50%, -100%); /* –¶–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ */
            border-radius: 4px;
            transform-origin: bottom center;
        }
        .compass-arrow::after {
            content: "N"; position: absolute; top: -20px; left: -5px; font-weight: 700; color: var(--text);
        }
        
        /* QIBLA NEEDLE */
        .qibla-needle {
            position: absolute; top: 50%; left: 50%;
            width: 8px; height: 100px;
            background: var(--accent); /* –ú–µ–∫–∫–∞ */
            transform-origin: bottom center;
            border-radius: 4px;
            z-index: 10;
            transition: transform 0.5s ease-out;
            box-shadow: 0 0 10px rgba(16, 185, 129, 0.5);
        }
        .qibla-needle::before {
            content: ""; position: absolute; top: -10px; left: -6px;
            border-left: 10px solid transparent; border-right: 10px solid transparent; border-bottom: 15px solid var(--accent);
        }
        .kaaba-icon {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            font-size: 40px; z-index: 20;
        }

        /* SETTINGS & SLIDERS */
        .setting-row { display: flex; justify-content: space-between; align-items: center; padding: 16px 0; border-bottom: 0.5px solid var(--border); }
        .switch { position: relative; display: inline-block; width: 51px; height: 31px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #E9E9EA; transition: .3s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 27px; width: 27px; left: 2px; bottom: 2px; background-color: white; transition: .3s; border-radius: 50%; box-shadow: 0 3px 8px rgba(0,0,0,0.15); }
        input:checked + .slider { background-color: var(--accent); }
        input:checked + .slider:before { transform: translateX(20px); }

        /* TABS */
        .tabs { position: fixed; bottom: 0; width: 100%; background: var(--card-bg); border-top: 0.5px solid var(--border); display: flex; justify-content: space-around; padding: 10px 0 25px; z-index: 99; }
        .tab-btn { background: none; border: none; color: var(--secondary); font-size: 10px; display: flex; flex-direction: column; align-items: center; gap: 4px; cursor: pointer; }
        .tab-btn.active { color: var(--accent); }
        .tab-btn svg { width: 24px; height: 24px; fill: currentColor; }

        /* PAGES */
        .page { display: none; animation: fadeIn 0.3s; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* BUTTONS */
        .btn-main { width: 100%; background: var(--accent); color: white; border: none; padding: 16px; border-radius: 14px; font-weight: 600; font-size: 17px; margin-top: 10px; cursor: pointer; }
        .btn-sec { background: rgba(118,118,128,0.12); color: var(--text); border: none; padding: 10px 20px; border-radius: 10px; font-weight: 500; cursor: pointer; }

        /* TASBIH */
        .tasbih-circle { width: 220px; height: 220px; border-radius: 50%; background: var(--accent); margin: 20px auto; display: flex; flex-direction: column; justify-content: center; align-items: center; color: white; box-shadow: 0 10px 30px rgba(16, 185, 129, 0.4); }
        .tasbih-val { font-size: 70px; font-weight: 800; line-height: 1; }
    </style>
</head>
<body>

    <div class="hero">
        <div class="hero-title">–°–ª–µ–¥—É—é—â–∏–π –Ω–∞–º–∞–∑</div>
        <div class="hero-name" id="heroName">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        <div class="hero-timer" id="heroTimer">--:--:--</div>
    </div>

    <div class="container">
        <div id="p-prayer" class="page active">
            <div class="card">
                <div class="search-box">
                    <input type="text" id="cityInput" class="input-loc" placeholder="–ò–∑–º–µ–Ω–∏—Ç—å –≥–æ—Ä–æ–¥ (–Ω–∞–ø—Ä. –ú–æ—Å–∫–≤–∞)">
                    <button class="btn-icon" onclick="geocode()">üîç</button>
                    <button class="btn-icon" style="background:#007AFF" onclick="getGPS()">üìç</button>
                </div>
                <div id="locationStatus" style="font-size: 13px; color: var(--secondary); text-align: center; margin-bottom: 8px;"></div>
                
                <div id="prayerList"></div>
                
                <button class="btn-main" onclick="saveToBot()">
                    –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
                </button>
            </div>
        </div>

        <div id="p-tasbih" class="page">
            <div class="card" style="text-align:center;">
                <h2 style="margin-bottom:10px;">–≠–ª–µ–∫—Ç—Ä–æ–Ω–Ω—ã–π —Ç–∞—Å–±–∏—Ö</h2>
                <div class="tasbih-circle" onclick="clickTasbih()">
                    <div class="tasbih-val" id="cnt">0</div>
                    <div style="font-size:14px; opacity:0.8;">–ù–∞–∂–º–∏—Ç–µ</div>
                </div>
                <div style="color:var(--accent); font-weight:600; margin-bottom:15px;" id="tgt">–¶–µ–ª—å: 33</div>
                <div style="display:flex; justify-content:center; gap:10px;">
                    <button class="btn-sec" onclick="setTarget(33)">33</button>
                    <button class="btn-sec" onclick="setTarget(99)">99</button>
                    <button class="btn-sec" style="color:var(--danger);" onclick="resetTasbih()">–°–±—Ä–æ—Å</button>
                </div>
            </div>
        </div>

        <div id="p-qibla" class="page">
            <div class="card" style="text-align:center;">
                <h2 style="margin-bottom:10px;">–ö–∏–±–ª–∞</h2>
                <div style="font-size:13px; color:var(--secondary); margin-bottom:10px;" id="qiblaInfo">
                    –ù–∞–∂–º–∏—Ç–µ "–í–∫–ª—é—á–∏—Ç—å –∫–æ–º–ø–∞—Å" –∏ —Ä–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø
                </div>
                
                <div class="compass-container">
                    <div class="compass-dial" id="compassDial">
                        <div class="compass-arrow"></div> <div class="kaaba-icon">üïã</div>
                    </div>
                    <div class="qibla-needle" id="qiblaNeedle" style="transform: translate(-50%, -100%) rotate(0deg);"></div>
                </div>

                <div style="font-size:24px; font-weight:700; margin:10px 0;" id="qiblaDegree">--¬∞</div>

                <button class="btn-main" onclick="startCompass()" style="margin-bottom:10px;">üß≠ –í–∫–ª—é—á–∏—Ç—å –∫–æ–º–ø–∞—Å</button>
                <button class="btn-sec" onclick="getGPSForQibla()">üìç –û–±–Ω–æ–≤–∏—Ç—å GPS</button>
            </div>
            <div class="card">
                <div style="font-size:13px; color:var(--secondary);">
                    ‚Ä¢ –ó–µ–ª–µ–Ω–∞—è —Å—Ç—Ä–µ–ª–∫–∞ —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ –ú–µ–∫–∫—É.<br>
                    ‚Ä¢ –î–µ—Ä–∂–∏—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ.<br>
                    ‚Ä¢ –†–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –≤–∫–ª—é—á–µ–Ω–Ω–æ–º GPS.
                </div>
            </div>
        </div>

        <div id="p-settings" class="page">
            <div class="card">
                <h2 style="margin-bottom:15px;">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</h2>
                <div id="settingsList"></div>
            </div>
            <div class="card">
                <div style="font-size:13px; color:var(--secondary); line-height:1.4;">
                    –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –º–µ—Ç–æ–¥ <b>MWL</b> (–í—Å–µ–º–∏—Ä–Ω–∞—è –ò—Å–ª–∞–º—Å–∫–∞—è –õ–∏–≥–∞).<br>
                    –£–≥–ª—ã: 18¬∞ / 17¬∞.<br>
                    –ì–æ—Ä–æ–¥ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.
                </div>
            </div>
        </div>
    </div>

    <div class="tabs">
        <button class="tab-btn active" onclick="tab('p-prayer', this)">
            <svg viewBox="0 0 24 24"><path d="M12 2L2 12h3v8h6v-6h2v6h6v-8h3z"/></svg>
            <span>–ù–∞–º–∞–∑</span>
        </button>
        <button class="tab-btn" onclick="tab('p-tasbih', this)">
            <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" fill="none" stroke="currentColor" stroke-width="2"/><circle cx="12" cy="12" r="2"/></svg>
            <span>–¢–∞—Å–±–∏—Ö</span>
        </button>
        <button class="tab-btn" onclick="tab('p-qibla', this)">
            <svg viewBox="0 0 24 24"><path d="M12 2L4.5 20.29l.71.71L12 18l6.79 3 .71-.71z"/></svg>
            <span>–ö–∏–±–ª–∞</span>
        </button>
        <button class="tab-btn" onclick="tab('p-settings', this)">
            <svg viewBox="0 0 24 24"><path d="M19.4 13c.1-.3.1-.6.1-1s0-.7-.1-1l2.1-1.7c.2-.2.2-.4.1-.6l-2-3.5c-.1-.2-.3-.3-.5-.2l-2.5 1c-.5-.4-1.1-.8-1.7-1l-.4-2.6c-.1-.2-.3-.4-.5-.4h-4c-.3 0-.5.2-.5.4l-.4 2.6c-.6.3-1.2.6-1.7 1l-2.5-1c-.2-.1-.4 0-.5.2l-2 3.5c-.1.2-.1.5.1.6l2.1 1.7c-.1.3-.1.6-.1 1s0 .7.1 1l-2.1 1.7c-.2.2-.2.4-.1.6l2 3.5c.1.2.3.3.5.2l2.5-1c.5.4 1.1.8 1.7 1l.4 2.6c0 .2.2.4.5.4h4c.3 0 .5-.2.5-.4l.4-2.6c.6-.3 1.2-.6 1.7-1l2.5 1c.2.1.4 0 .5-.2l2-3.5c.1-.2.1-.5-.1-.6l-2.1-1.7zM12 15.5c-1.9 0-3.5-1.6-3.5-3.5s1.6-3.5 3.5-3.5 3.5 1.6 3.5 3.5-1.6 3.5-3.5 3.5z"/></svg>
            <span>–ù–∞—Å—Ç—Ä.</span>
        </button>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        // --- –î–ê–ù–ù–´–ï ---
        let timingsData = null;
        let cityData = { lat: 0, lon: 0, name: '', tz: '' };
        let counter = parseInt(localStorage.getItem('cnt') || 0);
        let target = parseInt(localStorage.getItem('tgt') || 33);
        let qiblaOffset = 0; // –£–≥–æ–ª –Ω–∞ –ú–µ–∫–∫—É –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –°–µ–≤–µ—Ä–∞

        // --- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ---
        window.onload = () => {
            loadCity(); 
            updateTasbihUI();
            renderSettings();
            setInterval(updateTimer, 1000);
        };

        // --- –õ–û–ì–ò–ö–ê –ì–û–†–û–î–ê ---
        function loadCity() {
            const saved = localStorage.getItem('muslim_city');
            if (saved) {
                cityData = JSON.parse(saved);
                document.getElementById('locationStatus').innerText = `üìç –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ: ${cityData.name}`;
                document.getElementById('cityInput').value = cityData.name;
                fetchTimes(cityData.lat, cityData.lon);
                calcQiblaAngle(cityData.lat, cityData.lon); // –°—á–∏—Ç–∞–µ–º –ö–∏–±–ª—É
            } else {
                document.getElementById('heroName').innerText = "–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥";
                document.getElementById('locationStatus').innerText = "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø–æ–∏—Å–∫ –∏–ª–∏ GPS";
            }
        }

        async function fetchTimes(lat, lon) {
            try {
                const date = new Date().toISOString().split('T')[0].split('-').reverse().join('-');
                const url = `https://api.aladhan.com/v1/timings/${date}?latitude=${lat}&longitude=${lon}&method=3&school=0`;
                const res = await fetch(url);
                const data = await res.json();
                
                if (data.code === 200) {
                    timingsData = data.data.timings;
                    cityData.lat = lat; cityData.lon = lon; cityData.tz = data.data.meta.timezone;
                    localStorage.setItem('muslim_city', JSON.stringify(cityData));
                    renderPrayerList();
                    updateTimer();
                    calcQiblaAngle(lat, lon);
                }
            } catch (e) { console.error(e); }
        }

        async function geocode() {
            const city = document.getElementById('cityInput').value;
            if(!city) return;
            const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${city}&limit=1`);
            const data = await res.json();
            if(data.length) {
                cityData.name = data[0].display_name.split(',')[0];
                fetchTimes(data[0].lat, data[0].lon);
                document.getElementById('locationStatus').innerText = `üìç –ù–∞–π–¥–µ–Ω: ${cityData.name}`;
            } else { alert("–ì–æ—Ä–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω"); }
        }

        function getGPS() {
            if(!navigator.geolocation) return alert("–ù–µ—Ç GPS");
            navigator.geolocation.getCurrentPosition(pos => {
                cityData.name = "GPS –õ–æ–∫–∞—Ü–∏—è";
                fetchTimes(pos.coords.latitude, pos.coords.longitude);
                document.getElementById('cityInput').value = "–ú–æ–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ";
            });
        }

        // --- UI –ù–ê–ú–ê–ó–û–í ---
        function renderPrayerList() {
            const list = document.getElementById('prayerList');
            list.innerHTML = '';
            const names = { Fajr:"–§–∞–¥–∂—Ä", Dhuhr:"–ó—É—Ö—Ä", Asr:"–ê—Å—Ä", Maghrib:"–ú–∞–≥—Ä–∏–±", Isha:"–ò—à–∞" };
            const icons = { Fajr:"üåÖ", Dhuhr:"‚òÄÔ∏è", Asr:"üå§", Maghrib:"üåá", Isha:"üåô" };
            for(let key in names) {
                list.innerHTML += `
                    <div class="row" id="row-${key}">
                        <div>${icons[key]} ${names[key]}</div>
                        <div style="font-size:18px;">${timingsData[key]}</div>
                    </div>
                `;
            }
        }

        function updateTimer() {
            if(!timingsData) return;
            const now = new Date();
            let nextName = '', minDiff = Infinity;
            for(let key in timingsData) {
                if(['Sunrise','Sunset','Imsak','Midnight','Firstthird','Lastthird'].includes(key)) continue;
                const [h,m] = timingsData[key].split(':');
                let pTime = new Date();
                pTime.setHours(h, m, 0, 0);
                if(pTime < now) pTime.setDate(pTime.getDate() + 1);
                const diff = pTime - now;
                if(diff < minDiff) {
                    minDiff = diff;
                    nextName = { Fajr:"–§–∞–¥–∂—Ä", Dhuhr:"–ó—É—Ö—Ä", Asr:"–ê—Å—Ä", Maghrib:"–ú–∞–≥—Ä–∏–±", Isha:"–ò—à–∞" }[key];
                }
            }
            document.getElementById('heroName').innerText = nextName;
            const hh = Math.floor(minDiff / 3600000);
            const mm = Math.floor((minDiff % 3600000) / 60000);
            const ss = Math.floor((minDiff % 60000) / 1000);
            document.getElementById('heroTimer').innerText = `${hh}:${String(mm).padStart(2,'0')}:${String(ss).padStart(2,'0')}`;
        }

        // --- –¢–ê–°–ë–ò–• ---
        function clickTasbih() {
            counter++;
            if(counter === target) tg.HapticFeedback.notificationOccurred('success');
            else tg.HapticFeedback.impactOccurred('light');
            saveTasbih();
        }
        function resetTasbih() { counter = 0; saveTasbih(); }
        function setTarget(t) { target = t; saveTasbih(); }
        function saveTasbih() { localStorage.setItem('cnt', counter); localStorage.setItem('tgt', target); updateTasbihUI(); }
        function updateTasbihUI() {
            document.getElementById('cnt').innerText = counter;
            document.getElementById('tgt').innerText = `–¶–µ–ª—å: ${target}`;
        }

        // --- –ö–ò–ë–õ–ê (–õ–û–ì–ò–ö–ê) ---
        function getGPSForQibla() {
            if(!navigator.geolocation) return alert("–í–∫–ª—é—á–∏—Ç–µ GPS");
            navigator.geolocation.getCurrentPosition(pos => {
                calcQiblaAngle(pos.coords.latitude, pos.coords.longitude);
                alert("GPS –æ–±–Ω–æ–≤–ª–µ–Ω! –í–∫–ª—é—á–∏—Ç–µ –∫–æ–º–ø–∞—Å.");
            }, () => alert("–û—à–∏–±–∫–∞ GPS"));
        }

        function calcQiblaAngle(lat, lon) {
            // –§–æ—Ä–º—É–ª–∞ –∞–∑–∏–º—É—Ç–∞ –Ω–∞ –ú–µ–∫–∫—É (21.4225, 39.8262)
            const meccaLat = 21.4225;
            const meccaLon = 39.8262;
            
            const œÜ1 = lat * Math.PI / 180;
            const œÜ2 = meccaLat * Math.PI / 180;
            const ŒîŒª = (meccaLon - lon) * Math.PI / 180;

            const y = Math.sin(ŒîŒª) * Math.cos(œÜ2);
            const x = Math.cos(œÜ1) * Math.sin(œÜ2) - Math.sin(œÜ1) * Math.cos(œÜ2) * Math.cos(ŒîŒª);
            
            let qibla = Math.atan2(y, x) * 180 / Math.PI;
            qibla = (qibla + 360) % 360; // –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è 0-360
            
            qiblaOffset = qibla;
            document.getElementById('qiblaInfo').innerText = `–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ –ú–µ–∫–∫—É: ${qibla.toFixed(1)}¬∞`;
        }

        function startCompass() {
            if (window.DeviceOrientationEvent && typeof window.DeviceOrientationEvent.requestPermission === 'function') {
                // iOS 13+
                window.DeviceOrientationEvent.requestPermission()
                    .then(response => {
                        if (response === 'granted') {
                            window.addEventListener('deviceorientation', handleOrientation);
                            document.getElementById('qiblaInfo').innerText = "–ö–æ–º–ø–∞—Å –∞–∫—Ç–∏–≤–µ–Ω (iOS)";
                        } else {
                            alert("–ù—É–∂–Ω–æ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ –∫–æ–º–ø–∞—Å!");
                        }
                    })
                    .catch(console.error);
            } else {
                // Android / Old iOS
                window.addEventListener('deviceorientationabsolute', handleOrientation);
                window.addEventListener('deviceorientation', handleOrientation);
                document.getElementById('qiblaInfo').innerText = "–ö–æ–º–ø–∞—Å –∞–∫—Ç–∏–≤–µ–Ω";
            }
        }

        function handleOrientation(e) {
            let alpha = e.alpha; // –£–≥–æ–ª –ø–æ–≤–æ—Ä–æ—Ç–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –≤–æ–∫—Ä—É–≥ –æ—Å–∏ Z (0 = –°–µ–≤–µ—Ä)
            
            // Android (deviceorientationabsolute) —Ç–æ—á–Ω–µ–µ, –µ—Å–ª–∏ –µ—Å—Ç—å
            if(e.webkitCompassHeading) {
                // iOS
                alpha = e.webkitCompassHeading;
            } else if (e.alpha) {
                // Android (–Ω—É–∂–Ω–∞ –∏–Ω–≤–µ—Ä—Å–∏—è –¥–ª—è –≤—Ä–∞—â–µ–Ω–∏—è –¥–∏—Å–∫–∞)
                 alpha = 360 - e.alpha;
            }

            // 1. –í—Ä–∞—â–∞–µ–º –í–ï–°–¨ –¥–∏—Å–∫ –∫–æ–º–ø–∞—Å–∞ –ø—Ä–æ—Ç–∏–≤ –¥–≤–∏–∂–µ–Ω–∏—è —Ç–µ–ª–µ—Ñ–æ–Ω–∞, —á—Ç–æ–±—ã "N" –≤—Å–µ–≥–¥–∞ —Å–º–æ—Ç—Ä–µ–ª –Ω–∞ –°–µ–≤–µ—Ä
            // –ù–∞ iOS alpha - —ç—Ç–æ —É–∂–µ –∞–∑–∏–º—É—Ç.
            // –ï—Å–ª–∏ –º—ã –ø–æ–≤–æ—Ä–∞—á–∏–≤–∞–µ–º —Ç–µ–ª–µ—Ñ–æ–Ω –Ω–∞–ø—Ä–∞–≤–æ (90), alpha = 90.
            // –ß—Ç–æ–±—ã –¥–∏—Å–∫ –æ—Å—Ç–∞–ª—Å—è –Ω–∞ –º–µ—Å—Ç–µ, –∫—Ä—É—Ç–∏–º –µ–≥–æ –Ω–∞ -90.
            const dialRotation = -alpha; 
            document.getElementById('compassDial').style.transform = `rotate(${dialRotation}deg)`;

            // 2. –í—Ä–∞—â–∞–µ–º —Å—Ç—Ä–µ–ª–∫—É –ö–∏–±–ª—ã
            // –°—Ç—Ä–µ–ª–∫–∞ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞.
            // –ù–∞–º –Ω—É–∂–Ω–æ, —á—Ç–æ–±—ã –æ–Ω–∞ —É–∫–∞–∑—ã–≤–∞–ª–∞ –Ω–∞ qiblaOffset –û–¢–ù–û–°–ò–¢–ï–õ–¨–ù–û –°–ï–í–ï–†–ê.
            // –¢–∞–∫ –∫–∞–∫ –¥–∏—Å–∫ —É–∂–µ –ø–æ–≤–µ—Ä–Ω—É—Ç –Ω–∞ –°–µ–≤–µ—Ä, –º—ã –ø—Ä–æ—Å—Ç–æ –ø–æ–≤–æ—Ä–∞—á–∏–≤–∞–µ–º —Å—Ç—Ä–µ–ª–∫—É –Ω–∞ —É–≥–æ–ª –ö–∏–±–ª—ã.
            // –ù–æ —Å—Ç—Ä–µ–ª–∫–∞ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –í–ù–ï –¥–∏—Å–∫–∞ (position absolute –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ).
            
            // –í–∞—Ä–∏–∞–Ω—Ç –ø—Ä–æ—â–µ:
            // –ö—Ä—É—Ç–∏–º —Å—Ç—Ä–µ–ª–∫—É –ö–∏–±–ª—ã: (–£–≥–æ–ª –ö–∏–±–ª—ã - –£–≥–æ–ª –¢–µ–ª–µ—Ñ–æ–Ω–∞)
            // –ü—Ä–∏–º–µ—Ä: –ú–µ–∫–∫–∞ 180 (–Æ–≥). –¢–µ–ª–µ—Ñ–æ–Ω —Å–º–æ—Ç—Ä–∏—Ç –Ω–∞ –°–µ–≤–µ—Ä (0). –°—Ç—Ä–µ–ª–∫–∞ = 180 - 0 = 180 (–≤–Ω–∏–∑).
            // –¢–µ–ª–µ—Ñ–æ–Ω —Å–º–æ—Ç—Ä–∏—Ç –Ω–∞ –Æ–≥ (180). –°—Ç—Ä–µ–ª–∫–∞ = 180 - 180 = 0 (–≤–≤–µ—Ä—Ö, –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ —Ç–µ–ª–µ—Ñ–æ–Ω–∞).
            
            const needleRotation = qiblaOffset - alpha;
            
            // –í –º–æ–µ–π –≤–µ—Ä—Å—Ç–∫–µ –∏–≥–ª–∞ –≤–Ω—É—Ç—Ä–∏ –≤—Ä–∞—â–∞–µ—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ.
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º translate(-50%, -100%) –¥–ª—è —Ü–µ–Ω—Ç—Ä–æ–≤–∫–∏, –ø–æ—ç—Ç–æ–º—É –¥–æ–±–∞–≤–ª—è–µ–º rotate.
            document.getElementById('qiblaNeedle').style.transform = `translate(-50%, -100%) rotate(${needleRotation}deg)`;
            
            document.getElementById('qiblaDegree').innerText = `${Math.round(alpha)}¬∞`;
        }

        // --- –ù–ê–°–¢–†–û–ô–ö–ò ---
        function renderSettings() {
            const list = document.getElementById('settingsList');
            const conf = JSON.parse(localStorage.getItem('notif_conf') || '{}');
            const names = { Fajr:"–§–∞–¥–∂—Ä", Dhuhr:"–ó—É—Ö—Ä", Asr:"–ê—Å—Ä", Maghrib:"–ú–∞–≥—Ä–∏–±", Isha:"–ò—à–∞" };
            list.innerHTML = '';
            for(let key in names) {
                const checked = conf[key] !== false ? 'checked' : '';
                list.innerHTML += `
                    <div class="setting-row">
                        <span>${names[key]}</span>
                        <label class="switch">
                            <input type="checkbox" id="chk-${key}" ${checked} onchange="saveSettings()">
                            <span class="slider"></span>
                        </label>
                    </div>
                `;
            }
        }
        function saveSettings() {
            const conf = {};
            ['Fajr','Dhuhr','Asr','Maghrib','Isha'].forEach(k => conf[k] = document.getElementById(`chk-${k}`).checked);
            localStorage.setItem('notif_conf', JSON.stringify(conf));
        }

        // --- –ë–û–¢ ---
        function saveToBot() {
            if(!cityData.lat) return alert("–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥!");
            const notifSettings = JSON.parse(localStorage.getItem('notif_conf') || '{}');
            tg.sendData(JSON.stringify({
                action: 'sync_location', lat: cityData.lat, lon: cityData.lon, city: cityData.name,
                tz: cityData.tz, settings: notifSettings
            }));
        }

        // --- –¢–ê–ë–´ ---
        function tab(id, btn) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            btn.classList.add('active');
        }
    </script>
</body>
</html>

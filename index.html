<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Muslim App</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* –¢–≤–æ–∏ —Å—Ç–∏–ª–∏ (–º–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å –∫–∞–∫ –µ—Å—Ç—å) */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f2f2f7; padding-bottom: 80px; }
        .tabs { position: fixed; bottom: 0; left: 0; right: 0; background: rgba(255,255,255,0.9); backdrop-filter: blur(20px); display: flex; justify-content: space-around; border-top: 1px solid rgba(0,0,0,0.1); }
        .tab { flex: 1; text-align: center; padding: 12px; cursor: pointer; }
        .tab.active { color: #007aff; }
        .card { background: white; border-radius: 16px; padding: 20px; margin-bottom: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.02); }
        .current-time { font-size: 42px; font-weight: bold; text-align: center; }
        .prayer-time { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #eee; }
        .prayer-time-value { color: #007aff; font-weight: bold; }
        .btn-success { background: #34c759; color: white; border: none; padding: 16px; border-radius: 12px; width: 100%; font-size: 16px; }
        /* ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ ... */
    </style>
</head>
<body>
    <div class="tabs">
        <div class="tab active" onclick="switchTab('prayer')">üïå –ù–∞–º–∞–∑</div>
        <div class="tab" onclick="switchTab('tasbih')">üìø –¢–∞—Å–±–∏—Ö</div>
        <div class="tab" onclick="switchTab('settings')">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
    </div>

    <div class="content">
        <div id="prayer" class="page active">
            <!-- –ö–∞—Ä—Ç–æ—á–∫–∞ –≤—Ä–µ–º–µ–Ω–∏ -->
            <div class="card">
                <h2>üïê –¢–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è</h2>
                <div class="current-time" id="currentTime">--:--:--</div>
            </div>

            <!-- –ü–æ–∏—Å–∫ –≥–æ—Ä–æ–¥–∞ -->
            <div class="card">
                <h2>üìç –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è</h2>
                <input type="text" id="cityInput" placeholder="–ì–æ—Ä–æ–¥ (–Ω–∞–ø—Ä–∏–º–µ—Ä, Qusar)">
                <button onclick="geocodeAndFetchCity()">üîç –ù–∞–π—Ç–∏</button>
                <button onclick="getLocationAndFetchTimes()">üìç –ê–≤—Ç–æ</button>
                <button onclick="clearSavedLocation()">üóëÔ∏è –°–º–µ–Ω–∏—Ç—å</button>
                <div id="geoStatus"></div>
            </div>

            <!-- –ö–∞—Ä—Ç–æ—á–∫–∞ –≤—Ä–µ–º–µ–Ω–∏ –Ω–∞–º–∞–∑–∞ -->
            <div class="card" id="prayerTimesCard" style="display:none;">
                <h2 id="cityName">–í—Ä–µ–º—è –Ω–∞–º–∞–∑–∞</h2>
                <div class="debug-info" id="coordsDebug"></div>
                <div style="margin: 16px 0;">
                    <div class="prayer-time"><span>üåÖ –§–∞–¥–∂—Ä</span><span class="prayer-time-value" id="timeFajr">--:--</span></div>
                    <div class="prayer-time"><span>‚òÄÔ∏è –ó—É—Ö—Ä</span><span class="prayer-time-value" id="timeDhuhr">--:--</span></div>
                    <div class="prayer-time"><span>üå§ –ê—Å—Ä</span><span class="prayer-time-value" id="timeAsr">--:--</span></div>
                    <div class="prayer-time"><span>üåá –ú–∞–≥—Ä–∏–±</span><span class="prayer-time-value" id="timeMaghrib">--:--</span></div>
                    <div class="prayer-time"><span>üåô –ò—à–∞</span><span class="prayer-time-value" id="timeIsha">--:--</span></div>
                </div>
                <button class="btn-success" onclick="saveToBot()">üì° –°–û–•–†–ê–ù–ò–¢–¨ –í –ë–û–¢–ê</button>
                <div class="info">–ü–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –±–æ—Ç –ø—Ä–∏—à–ª—ë—Ç —Ç–æ—á–Ω–æ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ (–æ—Ñ–ª–∞–π–Ω-—Ä–∞—Å—á—ë—Ç)</div>
            </div>
        </div>
        <!-- –°—Ç—Ä–∞–Ω–∏—Ü—ã —Ç–∞—Å–±–∏—Ö –∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫ (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π, –º–æ–∂–µ—à—å –æ—Å—Ç–∞–≤–∏—Ç—å —Å–≤–æ–∏) -->
    </div>

    <script>
        const tg = Telegram.WebApp;
        tg.expand();

        let foundLat = 0, foundLon = 0, foundTimezone = '', foundCityName = '';

        // --- –§—É–Ω–∫—Ü–∏–∏ ---
        function switchTab(tab) { /* —Ç–≤–æ–π –∫–æ–¥ */ }

        // –ü–æ–ª—É—á–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –æ—Ç API (–¢–û–õ–¨–ö–û –¥–ª—è –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞)
        async function fetchPrayerTimesByCoords(lat, lon, displayName) {
            try {
                const date = new Date();
                const url = `https://api.aladhan.com/v1/timings/${date.getDate()}-${date.getMonth()+1}-${date.getFullYear()}?latitude=${lat}&longitude=${lon}&method=14&school=0`;
                const res = await fetch(url);
                const data = await res.json();
                if (data.code === 200) {
                    foundLat = lat; foundLon = lon; foundTimezone = data.data.meta.timezone; foundCityName = displayName;
                    document.getElementById('cityName').innerHTML = `üïå ${displayName} (${foundTimezone})`;
                    document.getElementById('coordsDebug').innerHTML = `üìç ${lat.toFixed(4)}, ${lon.toFixed(4)}<br>üåç ${foundTimezone}<br>‚ö†Ô∏è –≠—Ç–æ –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–µ –≤—Ä–µ–º—è! –¢–æ—á–Ω–æ–µ –≤—Ä–µ–º—è —Ä–∞—Å—Å—á–∏—Ç–∞–µ—Ç –±–æ—Ç.`;
                    document.getElementById('timeFajr').innerText = data.data.timings.Fajr;
                    document.getElementById('timeDhuhr').innerText = data.data.timings.Dhuhr;
                    document.getElementById('timeAsr').innerText = data.data.timings.Asr;
                    document.getElementById('timeMaghrib').innerText = data.data.timings.Maghrib;
                    document.getElementById('timeIsha').innerText = data.data.timings.Isha;
                    document.getElementById('prayerTimesCard').style.display = 'block';
                    tg.HapticFeedback.notificationOccurred('success');
                }
            } catch (e) { console.error(e); }
        }

        // –ì–µ–æ–∫–æ–¥–∏–Ω–≥ —Å —Ç–æ—á–Ω—ã–º–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º–∏ –¥–ª—è –ö—É—Å–∞—Ä–æ–≤
        async function geocodeAndFetchCity() {
            let city = document.getElementById('cityInput').value.trim();
            if (!city) return;
            const exact = {
                '–∫—É—Å–∞—Ä—ã': { lat: 41.4288, lon: 48.4378, name: '–ö—É—Å–∞—Ä—ã' },
                'qusar': { lat: 41.4288, lon: 48.4378, name: 'Qusar' },
                '—Å–∞–º—É—Ä': { lat: 41.6325, lon: 48.4302, name: '–°–∞–º—É—Ä' },
                'samur': { lat: 41.6325, lon: 48.4302, name: 'Samur' }
            };
            if (exact[city.toLowerCase()]) {
                const c = exact[city.toLowerCase()];
                await fetchPrayerTimesByCoords(c.lat, c.lon, c.name);
                return;
            }
            // –æ–±—ã—á–Ω—ã–π –≥–µ–æ–∫–æ–¥–∏–Ω–≥
            try {
                const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(city)}&limit=1`, {
                    headers: { 'User-Agent': 'MuslimApp/1.0' }
                });
                const data = await res.json();
                if (data.length) {
                    await fetchPrayerTimesByCoords(data[0].lat, data[0].lon, data[0].display_name.split(',')[0]);
                }
            } catch (e) { console.error(e); }
        }

        // GPS
        function getLocationAndFetchTimes() {
            navigator.geolocation.getCurrentPosition(
                pos => fetchPrayerTimesByCoords(pos.coords.latitude, pos.coords.longitude, '–í–∞—à–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ'),
                err => alert('–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞')
            );
        }

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –±–æ—Ç–∞ ‚Äî –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –¢–û–õ–¨–ö–û –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∏ —á–∞—Å–æ–≤–æ–π –ø–æ—è—Å
        function saveToBot() {
            if (!foundLat) { alert('–°–Ω–∞—á–∞–ª–∞ –Ω–∞–π–¥–∏—Ç–µ –≥–æ—Ä–æ–¥'); return; }
            tg.sendData(JSON.stringify({
                action: 'sync_location',
                lat: foundLat,
                lon: foundLon,
                offset: new Date().getTimezoneOffset(),
                timezone: foundTimezone,
                school: 0
            }));
            tg.close();
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–æ–≥–æ –≥–æ—Ä–æ–¥–∞
        window.onload = () => {
            const saved = localStorage.getItem('muslim_app_location');
            if (saved) {
                const d = JSON.parse(saved);
                fetchPrayerTimesByCoords(d.lat, d.lon, d.cityName);
            } else {
                getLocationAndFetchTimes();
            }
        };
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Muslim App</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* --- Muslim iOS Minimalist Theme --- */
        :root {
            --bg: #F2F2F7;
            --card-bg: #FFFFFF;
            --text: #000000;
            --secondary: #8E8E93;
            --accent: #10B981; /* –ò–∑—É–º—Ä—É–¥–Ω—ã–π */
            --danger: #FF3B30;
            --border: #E5E5EA;
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --bg: #000000;
                --card-bg: #1C1C1E;
                --text: #FFFFFF;
                --secondary: #98989D;
                --border: #38383A;
            }
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", Roboto, sans-serif; background: var(--bg); color: var(--text); padding-bottom: 100px; }

        /* HERO CARD */
        .hero {
            background: linear-gradient(135deg, #10B981, #047857);
            padding: 30px 20px;
            color: white;
            border-bottom-left-radius: 24px;
            border-bottom-right-radius: 24px;
            box-shadow: 0 4px 20px rgba(16, 185, 129, 0.3);
            text-align: center;
            margin-bottom: 20px;
        }
        .hero-title { font-size: 14px; opacity: 0.9; text-transform: uppercase; letter-spacing: 1px; }
        .hero-name { font-size: 32px; font-weight: 800; margin: 4px 0; }
        .hero-timer { background: rgba(255,255,255,0.2); padding: 6px 14px; border-radius: 20px; font-size: 15px; display: inline-block; backdrop-filter: blur(5px); }

        /* CONTENT */
        .container { padding: 0 16px; max-width: 480px; margin: 0 auto; }
        .card { background: var(--card-bg); border-radius: 16px; padding: 16px; margin-bottom: 16px; }
        
        /* SEARCH */
        .search-box { display: flex; gap: 8px; margin-bottom: 12px; }
        .input-loc { flex: 1; padding: 12px; border-radius: 12px; border: none; background: rgba(118,118,128,0.12); color: var(--text); font-size: 16px; }
        .btn-icon { width: 44px; background: var(--accent); color: white; border: none; border-radius: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 18px; }

        /* PRAYER LIST */
        .row { display: flex; justify-content: space-between; align-items: center; padding: 14px 0; border-bottom: 0.5px solid var(--border); }
        .row:last-child { border-bottom: none; }
        .row.active { color: var(--accent); font-weight: 700; }

        /* SETTINGS & SLIDERS */
        .setting-row { display: flex; justify-content: space-between; align-items: center; padding: 16px 0; border-bottom: 0.5px solid var(--border); }
        .switch { position: relative; display: inline-block; width: 51px; height: 31px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #E9E9EA; transition: .3s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 27px; width: 27px; left: 2px; bottom: 2px; background-color: white; transition: .3s; border-radius: 50%; box-shadow: 0 3px 8px rgba(0,0,0,0.15); }
        input:checked + .slider { background-color: var(--accent); }
        input:checked + .slider:before { transform: translateX(20px); }

        /* TABS */
        .tabs { position: fixed; bottom: 0; width: 100%; background: var(--card-bg); border-top: 0.5px solid var(--border); display: flex; justify-content: space-around; padding: 10px 0 25px; z-index: 99; }
        .tab-btn { background: none; border: none; color: var(--secondary); font-size: 10px; display: flex; flex-direction: column; align-items: center; gap: 4px; cursor: pointer; }
        .tab-btn.active { color: var(--accent); }
        .tab-btn svg { width: 24px; height: 24px; fill: currentColor; }

        /* PAGES */
        .page { display: none; animation: fadeIn 0.3s; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* BUTTONS */
        .btn-main { width: 100%; background: var(--accent); color: white; border: none; padding: 16px; border-radius: 14px; font-weight: 600; font-size: 17px; margin-top: 10px; cursor: pointer; }
        .btn-sec { background: rgba(118,118,128,0.12); color: var(--text); border: none; padding: 10px 20px; border-radius: 10px; font-weight: 500; cursor: pointer; }

        /* TASBIH */
        .tasbih-circle { width: 220px; height: 220px; border-radius: 50%; background: var(--accent); margin: 20px auto; display: flex; flex-direction: column; justify-content: center; align-items: center; color: white; box-shadow: 0 10px 30px rgba(16, 185, 129, 0.4); }
        .tasbih-val { font-size: 70px; font-weight: 800; line-height: 1; }
    </style>
</head>
<body>

    <div class="hero">
        <div class="hero-title">–°–ª–µ–¥—É—é—â–∏–π –Ω–∞–º–∞–∑</div>
        <div class="hero-name" id="heroName">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        <div class="hero-timer" id="heroTimer">--:--:--</div>
    </div>

    <div class="container">
        <div id="p-prayer" class="page active">
            <div class="card">
                <div class="search-box">
                    <input type="text" id="cityInput" class="input-loc" placeholder="–ò–∑–º–µ–Ω–∏—Ç—å –≥–æ—Ä–æ–¥ (–Ω–∞–ø—Ä. –ú–æ—Å–∫–≤–∞)">
                    <button class="btn-icon" onclick="geocode()">üîç</button>
                    <button class="btn-icon" style="background:#007AFF" onclick="getGPS()">üìç</button>
                </div>
                <div id="locationStatus" style="font-size: 13px; color: var(--secondary); text-align: center; margin-bottom: 8px;"></div>
                
                <div id="prayerList"></div>
                
                <button class="btn-main" onclick="saveToBot()">
                    –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
                </button>
            </div>
        </div>

        <div id="p-tasbih" class="page">
            <div class="card" style="text-align:center;">
                <h2 style="margin-bottom:10px;">–≠–ª–µ–∫—Ç—Ä–æ–Ω–Ω—ã–π —Ç–∞—Å–±–∏—Ö</h2>
                <div class="tasbih-circle" onclick="clickTasbih()">
                    <div class="tasbih-val" id="cnt">0</div>
                    <div style="font-size:14px; opacity:0.8;">–ù–∞–∂–º–∏—Ç–µ</div>
                </div>
                <div style="color:var(--accent); font-weight:600; margin-bottom:15px;" id="tgt">–¶–µ–ª—å: 33</div>
                <div style="display:flex; justify-content:center; gap:10px;">
                    <button class="btn-sec" onclick="setTarget(33)">33</button>
                    <button class="btn-sec" onclick="setTarget(99)">99</button>
                    <button class="btn-sec" style="color:var(--danger);" onclick="resetTasbih()">–°–±—Ä–æ—Å</button>
                </div>
            </div>
        </div>

        <div id="p-settings" class="page">
            <div class="card">
                <h2 style="margin-bottom:15px;">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</h2>
                <div id="settingsList"></div>
            </div>
            <div class="card">
                <div style="font-size:13px; color:var(--secondary); line-height:1.4;">
                    –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –º–µ—Ç–æ–¥ <b>MWL</b> (–í—Å–µ–º–∏—Ä–Ω–∞—è –ò—Å–ª–∞–º—Å–∫–∞—è –õ–∏–≥–∞).<br>
                    –£–≥–ª—ã: 18¬∞ / 17¬∞.<br>
                    –ì–æ—Ä–æ–¥ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.
                </div>
            </div>
        </div>
    </div>

    <div class="tabs">
        <button class="tab-btn active" onclick="tab('p-prayer', this)">
            <svg viewBox="0 0 24 24"><path d="M12 2L2 12h3v8h6v-6h2v6h6v-8h3z"/></svg>
            <span>–ù–∞–º–∞–∑</span>
        </button>
        <button class="tab-btn" onclick="tab('p-tasbih', this)">
            <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" fill="none" stroke="currentColor" stroke-width="2"/><circle cx="12" cy="12" r="2"/></svg>
            <span>–¢–∞—Å–±–∏—Ö</span>
        </button>
        <button class="tab-btn" onclick="tab('p-settings', this)">
            <svg viewBox="0 0 24 24"><path d="M19.4 13c.1-.3.1-.6.1-1s0-.7-.1-1l2.1-1.7c.2-.2.2-.4.1-.6l-2-3.5c-.1-.2-.3-.3-.5-.2l-2.5 1c-.5-.4-1.1-.8-1.7-1l-.4-2.6c-.1-.2-.3-.4-.5-.4h-4c-.3 0-.5.2-.5.4l-.4 2.6c-.6.3-1.2.6-1.7 1l-2.5-1c-.2-.1-.4 0-.5.2l-2 3.5c-.1.2-.1.5.1.6l2.1 1.7c-.1.3-.1.6-.1 1s0 .7.1 1l-2.1 1.7c-.2.2-.2.4-.1.6l2 3.5c.1.2.3.3.5.2l2.5-1c.5.4 1.1.8 1.7 1l.4 2.6c0 .2.2.4.5.4h4c.3 0 .5-.2.5-.4l.4-2.6c.6-.3 1.2-.6 1.7-1l2.5 1c.2.1.4 0 .5-.2l2-3.5c.1-.2.1-.5-.1-.6l-2.1-1.7zM12 15.5c-1.9 0-3.5-1.6-3.5-3.5s1.6-3.5 3.5-3.5 3.5 1.6 3.5 3.5-1.6 3.5-3.5 3.5z"/></svg>
            <span>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</span>
        </button>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        // --- –î–ê–ù–ù–´–ï ---
        let timingsData = null;
        let cityData = { lat: 0, lon: 0, name: '', tz: '' };
        let counter = parseInt(localStorage.getItem('cnt') || 0);
        let target = parseInt(localStorage.getItem('tgt') || 33);

        // --- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ---
        window.onload = () => {
            loadCity(); // –ó–ê–ì–†–£–ó–ö–ê –°–û–•–†–ê–ù–ï–ù–ù–û–ì–û –ì–û–†–û–î–ê
            updateTasbihUI();
            renderSettings();
            setInterval(updateTimer, 1000);
        };

        // --- –õ–û–ì–ò–ö–ê –ì–û–†–û–î–ê ---
        function loadCity() {
            const saved = localStorage.getItem('muslim_city');
            if (saved) {
                // –ï—Å–ª–∏ –µ—Å—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π –≥–æ—Ä–æ–¥ - —Å—Ä–∞–∑—É –ø–æ–∫–∞–∑—ã–≤–∞–µ–º!
                cityData = JSON.parse(saved);
                document.getElementById('locationStatus').innerText = `üìç –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ: ${cityData.name}`;
                document.getElementById('cityInput').value = cityData.name; // –ó–∞–ø–æ–ª–Ω—è–µ–º –ø–æ–ª–µ, —á—Ç–æ–±—ã –º–æ–∂–Ω–æ –±—ã–ª–æ –ø–æ–º–µ–Ω—è—Ç—å
                fetchTimes(cityData.lat, cityData.lon);
            } else {
                document.getElementById('heroName').innerText = "–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥";
                document.getElementById('locationStatus').innerText = "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø–æ–∏—Å–∫ –∏–ª–∏ GPS";
            }
        }

        async function fetchTimes(lat, lon) {
            try {
                const date = new Date().toISOString().split('T')[0].split('-').reverse().join('-');
                const url = `https://api.aladhan.com/v1/timings/${date}?latitude=${lat}&longitude=${lon}&method=3&school=0`;
                const res = await fetch(url);
                const data = await res.json();
                
                if (data.code === 200) {
                    timingsData = data.data.timings;
                    cityData.lat = lat; 
                    cityData.lon = lon; 
                    cityData.tz = data.data.meta.timezone;
                    
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –ø–∞–º—è—Ç—å —Ç–µ–ª–µ—Ñ–æ–Ω–∞
                    localStorage.setItem('muslim_city', JSON.stringify(cityData));
                    
                    renderPrayerList();
                    updateTimer();
                }
            } catch (e) {
                alert("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è");
            }
        }

        async function geocode() {
            const city = document.getElementById('cityInput').value;
            if(!city) return;
            const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${city}&limit=1`);
            const data = await res.json();
            if(data.length) {
                cityData.name = data[0].display_name.split(',')[0];
                fetchTimes(data[0].lat, data[0].lon);
                document.getElementById('locationStatus').innerText = `üìç –ù–∞–π–¥–µ–Ω: ${cityData.name}`;
            } else {
                alert("–ì–æ—Ä–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω");
            }
        }

        function getGPS() {
            if(!navigator.geolocation) return alert("–ù–µ—Ç GPS");
            navigator.geolocation.getCurrentPosition(pos => {
                cityData.name = "GPS –õ–æ–∫–∞—Ü–∏—è";
                fetchTimes(pos.coords.latitude, pos.coords.longitude);
                document.getElementById('cityInput').value = "–ú–æ–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ";
            });
        }

        // --- UI –ù–ê–ú–ê–ó–û–í ---
        function renderPrayerList() {
            const list = document.getElementById('prayerList');
            list.innerHTML = '';
            const names = { Fajr:"–§–∞–¥–∂—Ä", Dhuhr:"–ó—É—Ö—Ä", Asr:"–ê—Å—Ä", Maghrib:"–ú–∞–≥—Ä–∏–±", Isha:"–ò—à–∞" };
            const icons = { Fajr:"üåÖ", Dhuhr:"‚òÄÔ∏è", Asr:"üå§", Maghrib:"üåá", Isha:"üåô" };
            
            for(let key in names) {
                list.innerHTML += `
                    <div class="row" id="row-${key}">
                        <div>${icons[key]} ${names[key]}</div>
                        <div style="font-size:18px;">${timingsData[key]}</div>
                    </div>
                `;
            }
        }

        function updateTimer() {
            if(!timingsData) return;
            const now = new Date();
            let nextName = '', minDiff = Infinity;
            
            for(let key in timingsData) {
                if(['Sunrise','Sunset','Imsak','Midnight','Firstthird','Lastthird'].includes(key)) continue;
                
                const [h,m] = timingsData[key].split(':');
                let pTime = new Date();
                pTime.setHours(h, m, 0, 0);
                if(pTime < now) pTime.setDate(pTime.getDate() + 1);
                
                const diff = pTime - now;
                if(diff < minDiff) {
                    minDiff = diff;
                    nextName = { Fajr:"–§–∞–¥–∂—Ä", Dhuhr:"–ó—É—Ö—Ä", Asr:"–ê—Å—Ä", Maghrib:"–ú–∞–≥—Ä–∏–±", Isha:"–ò—à–∞" }[key];
                }
            }
            
            document.getElementById('heroName').innerText = nextName;
            const hh = Math.floor(minDiff / 3600000);
            const mm = Math.floor((minDiff % 3600000) / 60000);
            const ss = Math.floor((minDiff % 60000) / 1000);
            document.getElementById('heroTimer').innerText = `${hh}:${String(mm).padStart(2,'0')}:${String(ss).padStart(2,'0')}`;
        }

        // --- –¢–ê–°–ë–ò–• ---
        function clickTasbih() {
            counter++;
            if(counter === target) tg.HapticFeedback.notificationOccurred('success');
            else tg.HapticFeedback.impactOccurred('light');
            saveTasbih();
        }
        function resetTasbih() { counter = 0; saveTasbih(); }
        function setTarget(t) { target = t; saveTasbih(); }
        function saveTasbih() {
            localStorage.setItem('cnt', counter);
            localStorage.setItem('tgt', target);
            updateTasbihUI();
        }
        function updateTasbihUI() {
            document.getElementById('cnt').innerText = counter;
            document.getElementById('tgt').innerText = `–¶–µ–ª—å: ${target}`;
        }

        // --- –ù–ê–°–¢–†–û–ô–ö–ò (–ü–û–õ–ó–£–ù–ö–ò) ---
        function renderSettings() {
            const list = document.getElementById('settingsList');
            const conf = JSON.parse(localStorage.getItem('notif_conf') || '{}');
            const names = { Fajr:"–§–∞–¥–∂—Ä", Dhuhr:"–ó—É—Ö—Ä", Asr:"–ê—Å—Ä", Maghrib:"–ú–∞–≥—Ä–∏–±", Isha:"–ò—à–∞" };
            
            list.innerHTML = '';
            for(let key in names) {
                const checked = conf[key] !== false ? 'checked' : '';
                list.innerHTML += `
                    <div class="setting-row">
                        <span>${names[key]}</span>
                        <label class="switch">
                            <input type="checkbox" id="chk-${key}" ${checked} onchange="saveSettings()">
                            <span class="slider"></span>
                        </label>
                    </div>
                `;
            }
        }

        function saveSettings() {
            const conf = {};
            ['Fajr','Dhuhr','Asr','Maghrib','Isha'].forEach(k => {
                conf[k] = document.getElementById(`chk-${k}`).checked;
            });
            localStorage.setItem('notif_conf', JSON.stringify(conf));
            // –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ –±–æ—Ç —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –æ–±—â–µ–≥–æ –ø—Ä–æ—Ñ–∏–ª—è –∏–ª–∏ –º–æ–∂–Ω–æ —Å—Ä–∞–∑—É
        }

        // --- –û–¢–ü–†–ê–í–ö–ê –í –ë–û–¢ ---
        function saveToBot() {
            if(!cityData.lat) return alert("–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥!");
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π —Ç–æ–∂–µ
            const notifSettings = JSON.parse(localStorage.getItem('notif_conf') || '{}');
            
            const payload = {
                action: 'sync_location',
                lat: cityData.lat,
                lon: cityData.lon,
                city: cityData.name, // –ü–µ—Ä–µ–¥–∞–µ–º –∏–º—è –≥–æ—Ä–æ–¥–∞!
                tz: cityData.tz,
                settings: notifSettings
            };
            tg.sendData(JSON.stringify(payload));
        }

        // --- –¢–ê–ë–´ ---
        function tab(id, btn) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            btn.classList.add('active');
        }
    </script>
</body>
</html>

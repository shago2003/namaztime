<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Muslim App</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root { --bg-color: #F2F2F7; --card-bg: #FFFFFF; --text-color: #000000; --accent-color: #007AFF; }
        [data-theme="dark"] { --bg-color: #000000; --card-bg: #1C1C1E; --text-color: #FFFFFF; --accent-color: #0A84FF; }
        body { font-family: sans-serif; background: var(--bg-color); color: var(--text-color); margin: 0; padding-bottom: 90px; }
        .container { display: none; padding: 20px; }
        .container.active { display: block; }
        .card { background: var(--card-bg); border-radius: 16px; padding: 20px; margin-bottom: 15px; }
        
        /* –ì–õ–ê–í–ù–´–ô –≠–ö–†–ê–ù */
        .hero-card { text-align: center; color: white; padding: 40px 20px; background: linear-gradient(135deg, #007AFF, #5AC8FA); border-radius: 16px; margin: 20px; }
        .hero-time { font-size: 50px; font-weight: 800; }
        
        /* –°–ü–ò–°–û–ö */
        .prayer-row { display: flex; justify-content: space-between; align-items: center; padding: 15px 0; border-bottom: 1px solid #ccc; }
        .prayer-name { font-weight: 600; }
        .prayer-right { display: flex; align-items: center; gap: 10px; }
        .bell-btn { background: none; border: none; font-size: 20px; cursor: pointer; opacity: 0.5; transition: 0.2s; }
        .bell-btn.active { opacity: 1; transform: scale(1.2); }

        /* –ú–ï–ù–Æ */
        .tab-bar { position: fixed; bottom: 0; width: 100%; background: var(--card-bg); display: flex; height: 60px; border-top: 1px solid #ccc; }
        .tab-btn { flex: 1; border: none; background: none; color: #888; font-size: 24px; }
        .tab-btn.active { color: var(--accent-color); }
    </style>
</head>
<body>

    <div id="tab-home" class="container active">
        <h1 style="text-align:center; margin-top:0;">Muslim App</h1>
        <div class="hero-card">
            <div style="font-size:60px;">üïå</div>
            <div>–°–ª–µ–¥—É—é—â–∏–π –Ω–∞–º–∞–∑:</div>
            <div class="hero-time" id="nextTime">--:--</div>
            <div id="nextName">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            <div id="locationBadge" style="margin-top:10px; font-size:12px; opacity:0.8;">üìç –ü–æ–∏—Å–∫...</div>
        </div>

        <div class="card">
            <h3 style="margin-top:0;">–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è</h3>
            <div id="scheduleList"></div>
        </div>
    </div>

    <div id="tab-tasbih" class="container">
        <h1 style="text-align:center">–¢–∞—Å–±–∏—Ö</h1>
        <div class="card" style="text-align:center; padding: 50px 20px;">
            <div id="tasbihCount" style="font-size: 80px; font-weight:bold;">0</div>
            <button onclick="countTasbih()" style="width:100%; padding:20px; background:var(--accent-color); color:white; border:none; border-radius:12px; font-size:20px; margin-top:20px;">–ù–∞–∂–∞—Ç—å</button>
            <button onclick="resetTasbih()" style="margin-top:20px; background:none; border:none; color:red;">–°–±—Ä–æ—Å–∏—Ç—å</button>
        </div>
    </div>

    <div id="tab-settings" class="container">
        <h1>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h1>
        <div class="card">
            <p>–õ–æ–∫–∞—Ü–∏—è: <span id="currentCity">–ê–≤—Ç–æ</span></p>
            <button onclick="getLocation()" style="width:100%; padding:10px; background:var(--accent-color); color:white; border-radius:8px; border:none;">üîÑ –û–±–Ω–æ–≤–∏—Ç—å GPS</button>
        </div>
        <div class="card">
            <p>–¢–µ—Å—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π:</p>
            <button onclick="sendTest()" style="width:100%; padding:10px; background:#34C759; color:white; border-radius:8px; border:none;">üîî –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ—Å—Ç</button>
        </div>
    </div>

    <div class="tab-bar">
        <button class="tab-btn active" onclick="switchTab('home', this)">üè†</button>
        <button class="tab-btn" onclick="switchTab('tasbih', this)">üìø</button>
        <button class="tab-btn" onclick="switchTab('settings', this)">‚öôÔ∏è</button>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        let tasbih = localStorage.getItem('tasbih') || 0;
        let currentTimings = {};
        
        function init() {
            document.getElementById('tasbihCount').innerText = tasbih;
            getLocation();
        }

        // --- –õ–û–ö–ê–¶–ò–Ø –ò API ---
        function getLocation() {
            document.getElementById('locationBadge').innerText = "‚è≥ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ...";
            navigator.geolocation.getCurrentPosition(
                pos => loadTimings(pos.coords.latitude, pos.coords.longitude),
                err => {
                    // –ï—Å–ª–∏ –Ω–µ—Ç GPS, –ø—Ä–æ–±—É–µ–º –ë–∞–∫—É –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                    fetch(`https://api.aladhan.com/v1/timingsByCity?city=Baku&country=Azerbaijan&method=3`)
                        .then(res => res.json())
                        .then(data => renderTimings(data.data.timings, "Baku (Default)"));
                }
            );
        }

        function loadTimings(lat, lon) {
            const date = Math.floor(Date.now() / 1000);
            fetch(`https://api.aladhan.com/v1/timings/${date}?latitude=${lat}&longitude=${lon}&method=3`)
                .then(res => res.json())
                .then(data => renderTimings(data.data.timings, "GPS –õ–æ–∫–∞—Ü–∏—è"));
        }

        function renderTimings(timings, locName) {
            currentTimings = timings;
            document.getElementById('locationBadge').innerText = "üìç " + locName;
            
            const list = document.getElementById('scheduleList');
            list.innerHTML = "";
            
            const names = {Fajr:"–§–∞–¥–∂—Ä", Sunrise:"–í–æ—Å—Ö–æ–¥", Dhuhr:"–ó—É—Ö—Ä", Asr:"–ê—Å—Ä", Maghrib:"–ú–∞–≥—Ä–∏–±", Isha:"–ò—à–∞"};
            const keys = ['Fajr', 'Sunrise', 'Dhuhr', 'Asr', 'Maghrib', 'Isha'];
            
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å–ª–µ–¥—É—é—â–∏–π –Ω–∞–º–∞–∑
            const now = new Date();
            const nowMins = now.getHours() * 60 + now.getMinutes();
            let nextKey = "Fajr";
            let foundNext = false;

            keys.forEach(key => {
                const time = timings[key];
                
                // --- –ì–õ–ê–í–ù–û–ï: –ö–ù–û–ü–ö–ê-–ö–û–õ–û–ö–û–õ–¨–ß–ò–ö ---
                // –ü—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —ç—Ç–æ—Ç –Ω–∞–º–∞–∑ –±–æ—Ç—É
                const row = `
                    <div class="prayer-row">
                        <span class="prayer-name">${names[key]}</span>
                        <div class="prayer-right">
                            <span>${time}</span>
                            <button class="bell-btn" onclick="setAlarm('${time}', '${names[key]}', this)">üîî</button>
                        </div>
                    </div>
                `;
                list.innerHTML += row;

                // –õ–æ–≥–∏–∫–∞ —Å–ª–µ–¥—É—é—â–µ–≥–æ –Ω–∞–º–∞–∑–∞
                const [h, m] = time.split(':').map(Number);
                if (!foundNext && (h*60+m) > nowMins) {
                    nextKey = key; 
                    foundNext = true;
                    document.getElementById('nextTime').innerText = time;
                    document.getElementById('nextName').innerText = names[key];
                }
            });
            
            if(!foundNext) {
                // –ï—Å–ª–∏ –≤—Å–µ –ø—Ä–æ—à–ª–∏, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –§–∞–¥–∂—Ä –∑–∞–≤—Ç—Ä–∞
                document.getElementById('nextTime').innerText = timings['Fajr'];
                document.getElementById('nextName').innerText = "–§–∞–¥–∂—Ä (–ó–∞–≤—Ç—Ä–∞)";
            }
        }

        // --- –û–¢–ü–†–ê–í–ö–ê –ë–£–î–ò–õ–¨–ù–ò–ö–ê –ë–û–¢–£ ---
        function setAlarm(time, name, btn) {
            // –í–∏–∑—É–∞–ª—å–Ω–æ –≤–∫–ª—é—á–∞–µ–º –∫–æ–ª–æ–∫–æ–ª—å—á–∏–∫
            btn.classList.add('active');
            btn.innerText = "‚úÖ";
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –±–æ—Ç—É
            const offset = new Date().getTimezoneOffset();
            tg.sendData(JSON.stringify({ 
                action: 'set_alarm', 
                time: time, 
                offset: offset 
            }));
            
            // –í–∏–±—Ä–∞—Ü–∏—è
            if(tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('success');
            
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º, —á—Ç–æ–±—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–≤–∏–¥–µ–ª —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —á–∞—Ç–µ
            setTimeout(() => {
               tg.close();
            }, 500);
        }

        function sendTest() {
            tg.sendData(JSON.stringify({ action: 'test_notification' }));
        }

        // --- –¢–ê–°–ë–ò–• –ò –í–ö–õ–ê–î–ö–ò ---
        function countTasbih() {
            tasbih++;
            document.getElementById('tasbihCount').innerText = tasbih;
            localStorage.setItem('tasbih', tasbih);
            if(tg.HapticFeedback) tg.HapticFeedback.impactOccurred('light');
        }
        function resetTasbih() { tasbih=0; document.getElementById('tasbihCount').innerText=0; localStorage.setItem('tasbih',0); }
        
        function switchTab(name, btn) {
            document.querySelectorAll('.container').forEach(el => el.classList.remove('active'));
            document.getElementById('tab-'+name).classList.add('active');
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            btn.classList.add('active');
        }

        init();
    </script>
</body>
</html>

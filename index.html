<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Muslim App</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* iOS-—Å—Ç–∏–ª—å */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: #f2f2f7; /* —Å–≤–µ—Ç–ª—ã–π —Å–µ—Ä—ã–π, –∫–∞–∫ –≤ iOS */
            color: #1c1c1e;
            line-height: 1.4;
            padding-bottom: 90px;
            min-height: 100vh;
        }

        /* Tab bar –≤ —Å—Ç–∏–ª–µ iOS */
        .tabs {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            display: flex;
            justify-content: space-around;
            padding: 8px 0 20px;
            border-top: 0.5px solid rgba(60, 60, 67, 0.2);
            z-index: 100;
        }

        .tab {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 6px 0;
            color: #8e8e93;
            font-size: 10px;
            font-weight: 500;
            transition: color 0.2s;
            cursor: pointer;
            border: none;
            background: transparent;
        }

        .tab.active {
            color: #007aff; /* —Å–∏—Å—Ç–µ–º–Ω—ã–π —Å–∏–Ω–∏–π */
        }

        .tab span {
            font-size: 22px;
            margin-bottom: 2px;
        }

        /* –ö–æ–Ω—Ç–µ–Ω—Ç */
        .content {
            padding: 16px;
            max-width: 480px;
            margin: 0 auto;
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0.6; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* –ö–∞—Ä—Ç–æ—á–∫–∏ */
        .card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 14px;
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.04);
            border: 0.5px solid rgba(60, 60, 67, 0.1);
        }

        .card h2 {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
            color: #1c1c1e;
            letter-spacing: -0.3px;
        }

        /* –¢–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è */
        .current-time {
            font-size: 42px;
            font-weight: 700;
            color: #1c1c1e;
            text-align: center;
            margin: 8px 0;
            font-feature-settings: "tnum";
        }

        /* –í—Ä–µ–º—è –Ω–∞–º–∞–∑–∞ */
        .prayer-time {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 0.5px solid rgba(60, 60, 67, 0.1);
        }

        .prayer-time:last-child {
            border-bottom: none;
        }

        .prayer-name {
            font-size: 17px;
            font-weight: 400;
            color: #1c1c1e;
        }

        .prayer-time-value {
            font-size: 19px;
            font-weight: 600;
            color: #007aff;
            font-feature-settings: "tnum";
        }

        .prayer-emoji {
            font-size: 24px;
            margin-right: 12px;
            vertical-align: middle;
        }

        /* –ü–æ–ª—è –≤–≤–æ–¥–∞ */
        .search-row {
            display: flex;
            gap: 10px;
            margin-bottom: 12px;
        }

        input[type="text"] {
            flex: 1;
            padding: 14px 16px;
            background: rgba(118, 118, 128, 0.08);
            border: 0.5px solid rgba(60, 60, 67, 0.1);
            border-radius: 10px;
            font-size: 17px;
            color: #1c1c1e;
            transition: all 0.2s;
        }

        input[type="text"]:focus {
            outline: none;
            border-color: #007aff;
            background: #ffffff;
        }

        input[type="text"]::placeholder {
            color: #8e8e93;
        }

        /* –ö–Ω–æ–ø–∫–∏ */
        button {
            border: none;
            border-radius: 12px;
            padding: 14px 20px;
            font-size: 17px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            background: #007aff;
            color: white;
            box-shadow: 0 2px 8px rgba(0, 122, 255, 0.2);
        }

        button:active {
            opacity: 0.8;
            transform: scale(0.98);
        }

        .btn-outline {
            background: transparent;
            border: 1.5px solid #007aff;
            color: #007aff;
            box-shadow: none;
        }

        .btn-outline:active {
            background: rgba(0, 122, 255, 0.05);
        }

        .btn-success {
            background: #34c759;
            box-shadow: 0 2px 8px rgba(52, 199, 89, 0.2);
        }

        .btn-secondary {
            background: rgba(118, 118, 128, 0.08);
            color: #007aff;
            box-shadow: none;
        }

        .btn-secondary:active {
            background: rgba(118, 118, 128, 0.2);
        }

        /* –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å –º–∞–∑—Ö–∞–±–∞ */
        .madhab-selector {
            background: rgba(118, 118, 128, 0.08);
            border-radius: 10px;
            padding: 6px;
            display: flex;
            margin: 16px 0 8px;
        }

        .madhab-option {
            flex: 1;
            text-align: center;
            padding: 10px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            color: #8e8e93;
            transition: all 0.2s;
            cursor: pointer;
        }

        .madhab-option.active {
            background: #ffffff;
            color: #007aff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.02);
        }

        /* –¢–∞—Å–±–∏—Ö */
        .counter-display {
            font-size: 80px;
            font-weight: 700;
            color: #1c1c1e;
            text-align: center;
            margin: 20px 0;
            font-feature-settings: "tnum";
        }

        .counter-button {
            width: 220px;
            height: 220px;
            border-radius: 50%;
            background: #007aff;
            color: white;
            font-size: 28px;
            border: none;
            margin: 16px auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            box-shadow: 0 8px 24px rgba(0, 122, 255, 0.3);
            transition: all 0.15s;
        }

        .counter-button:active {
            transform: scale(0.94);
            box-shadow: 0 4px 12px rgba(0, 122, 255, 0.3);
        }

        .progress-bar {
            height: 6px;
            background: rgba(118, 118, 128, 0.1);
            border-radius: 3px;
            overflow: hidden;
            margin: 16px 0;
        }

        .progress-fill {
            height: 100%;
            background: #007aff;
            width: 0%;
            transition: width 0.2s;
            border-radius: 3px;
        }

        /* –ù–∞—Å—Ç—Ä–æ–π–∫–∏ */
        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px 0;
            border-bottom: 0.5px solid rgba(60, 60, 67, 0.1);
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 51px;
            height: 31px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #e9e9ea;
            transition: .2s;
            border-radius: 31px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 29px;
            width: 29px;
            left: 1px;
            bottom: 1px;
            background-color: white;
            transition: .2s;
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        input:checked + .slider {
            background-color: #34c759;
        }

        input:checked + .slider:before {
            transform: translateX(20px);
        }

        /* –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ */
        .debug-info {
            font-size: 12px;
            color: #8e8e93;
            background: rgba(118, 118, 128, 0.05);
            padding: 12px;
            border-radius: 10px;
            margin-top: 12px;
            font-family: 'SF Mono', monospace;
        }

        .warning {
            background: rgba(255, 204, 0, 0.1);
            border-left: 4px solid #ffcc00;
            padding: 14px;
            border-radius: 10px;
            color: #5c5c5c;
            font-size: 14px;
            margin: 16px 0;
        }

        .geo-status {
            font-size: 14px;
            color: #34c759;
            margin-top: 8px;
            font-weight: 500;
        }

        .info {
            color: #8e8e93;
            font-size: 13px;
            text-align: center;
            margin-top: 12px;
        }
    </style>
</head>
<body>
    <!-- –ù–∏–∂–Ω–∏–π —Ç–∞–±‚Äë–±–∞—Ä (–∫–∞–∫ –≤ iOS) -->
    <div class="tabs">
        <div class="tab active" onclick="switchTab(event, 'prayer')">
            <span>üïå</span>
            <span>–ù–∞–º–∞–∑</span>
        </div>
        <div class="tab" onclick="switchTab(event, 'tasbih')">
            <span>üìø</span>
            <span>–¢–∞—Å–±–∏—Ö</span>
        </div>
        <div class="tab" onclick="switchTab(event, 'settings')">
            <span>‚öôÔ∏è</span>
            <span>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</span>
        </div>
    </div>

    <div class="content">
        <!-- –°–¢–†–ê–ù–ò–¶–ê –ù–ê–ú–ê–ó -->
        <div id="prayer" class="page active">
            <div class="card">
                <h2>üïê –¢–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è</h2>
                <div class="current-time" id="currentTime">--:--:--</div>
                <div class="debug-info">
                    –ß–∞—Å–æ–≤–æ–π –ø–æ—è—Å: <span id="timezoneInfo">--</span><br>
                    Offset: <span id="offsetInfo">--</span> –º–∏–Ω
                </div>
            </div>

            <div class="card">
                <h2>üìç –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è</h2>
                <div class="search-row">
                    <input type="text" id="cityInput" placeholder="–ì–æ—Ä–æ–¥ (–Ω–∞–ø—Ä–∏–º–µ—Ä, Baku)">
                    <button class="btn-outline" onclick="geocodeAndFetchCity()">–ù–∞–π—Ç–∏</button>
                </div>
                <button class="btn-outline" onclick="getLocationAndFetchTimes()" style="margin-top: 0;">
                    üìç –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
                </button>
                <div id="geoStatus" class="geo-status"></div>
            </div>

            <div class="card" id="prayerTimesCard" style="display:none;">
                <h2 id="cityName">–í—Ä–µ–º—è –Ω–∞–º–∞–∑–∞</h2>
                
                <!-- –í–´–ë–û–† –ú–ê–ó–•–ê–ë–ê (–ê–°–†) -->
                <div class="madhab-selector">
                    <div id="madhabShafi" class="madhab-option" onclick="setMadhab(0)">üïå –®–∞—Ñ–∏–∏</div>
                    <div id="madhabHanafi" class="madhab-option active" onclick="setMadhab(1)">üïã –•–∞–Ω–∞—Ñ–∏</div>
                </div>

                <div class="debug-info" id="coordsDebug"></div>
                
                <div class="warning">
                    ‚ö†Ô∏è –í—Ä–µ–º—è –Ω–∞–º–∞–∑–∞ –¥–ª—è –≤–∞—à–∏—Ö –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç. –ß–∞—Å–æ–≤–æ–π –ø–æ—è—Å –æ–ø—Ä–µ–¥–µ–ª—ë–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.
                </div>
                
                <div style="margin: 16px 0;">
                    <div class="prayer-time">
                        <div><span class="prayer-emoji">üåÖ</span><span class="prayer-name">–§–∞–¥–∂—Ä</span></div>
                        <span class="prayer-time-value" id="timeFajr">--:--</span>
                    </div>
                    <div class="prayer-time">
                        <div><span class="prayer-emoji">‚òÄÔ∏è</span><span class="prayer-name">–ó—É—Ö—Ä</span></div>
                        <span class="prayer-time-value" id="timeDhuhr">--:--</span>
                    </div>
                    <div class="prayer-time">
                        <div><span class="prayer-emoji">üå§</span><span class="prayer-name">–ê—Å—Ä</span></div>
                        <span class="prayer-time-value" id="timeAsr">--:--</span>
                    </div>
                    <div class="prayer-time">
                        <div><span class="prayer-emoji">üåá</span><span class="prayer-name">–ú–∞–≥—Ä–∏–±</span></div>
                        <span class="prayer-time-value" id="timeMaghrib">--:--</span>
                    </div>
                    <div class="prayer-time">
                        <div><span class="prayer-emoji">üåô</span><span class="prayer-name">–ò—à–∞</span></div>
                        <span class="prayer-time-value" id="timeIsha">--:--</span>
                    </div>
                </div>
                
                <button class="btn-success" onclick="saveToBot()">üì° –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –±–æ—Ç–∞</button>
                <div class="info">–ü–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤—ã –±—É–¥–µ—Ç–µ –ø–æ–ª—É—á–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</div>
            </div>
        </div>

        <!-- –°–¢–†–ê–ù–ò–¶–ê –¢–ê–°–ë–ò–• -->
        <div id="tasbih" class="page">
            <div class="card" style="text-align: center;">
                <h2>üìø –¢–∞—Å–±–∏—Ö</h2>
                <div class="counter-display" id="counterDisplay">0</div>
                
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill" style="width: 0%;"></div>
                </div>
                
                <button class="counter-button" onclick="incrementCounter()">
                    <span style="font-size: 48px;">‚òùÔ∏è</span>
                    <span style="font-size: 18px; margin-top: 12px;">–ù–∞–∂–º–∏</span>
                </button>
                
                <div class="target-info" id="targetInfo">–¶–µ–ª—å: 33</div>
                
                <div class="tasbih-controls" style="display: flex; gap: 8px; margin-top: 24px;">
                    <button class="btn-secondary" onclick="setTarget(33)">33</button>
                    <button class="btn-secondary" onclick="setTarget(99)">99</button>
                    <button class="btn-secondary" onclick="setTarget(100)">100</button>
                    <button class="btn-secondary" onclick="resetCounter()">–°–±—Ä–æ—Å</button>
                </div>
            </div>
            
            <div class="card">
                <h2>üìñ –ó–∏–∫—Ä—ã</h2>
                <div style="padding: 10px 0; border-bottom: 0.5px solid rgba(60,60,67,0.1);">
                    <div style="font-weight: 600; margin-bottom: 4px;">ÿ≥Ÿèÿ®Ÿíÿ≠ŸéÿßŸÜŸé ÿßŸÑŸÑŸáŸê</div>
                    <div style="color: #8e8e93; font-size: 15px;">–°—É–±—Ö–∞–Ω–∞–ª–ª–∞—Ö (33)</div>
                </div>
                <div style="padding: 10px 0; border-bottom: 0.5px solid rgba(60,60,67,0.1);">
                    <div style="font-weight: 600; margin-bottom: 4px;">ÿßŸÑŸíÿ≠ŸéŸÖŸíÿØŸè ŸÑŸêŸÑŸéŸëŸáŸê</div>
                    <div style="color: #8e8e93; font-size: 15px;">–ê–ª—å—Ö–∞–º–¥—É–ª–∏–ª–ª–∞—Ö (33)</div>
                </div>
                <div style="padding: 10px 0;">
                    <div style="font-weight: 600; margin-bottom: 4px;">ÿßŸÑŸÑŸáŸè ÿ£ŸéŸÉŸíÿ®Ÿéÿ±Ÿè</div>
                    <div style="color: #8e8e93; font-size: 15px;">–ê–ª–ª–∞—Ö—É –ê–∫–±–∞—Ä (34)</div>
                </div>
            </div>
        </div>

        <!-- –°–¢–†–ê–ù–ò–¶–ê –ù–ê–°–¢–†–û–ô–ö–ò -->
        <div id="settings" class="page">
            <div class="card">
                <h2>üîî –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</h2>
                <div class="setting-item">
                    <span>üåÖ –§–∞–¥–∂—Ä</span>
                    <label class="switch">
                        <input type="checkbox" id="notifFajr" checked onchange="saveNotificationSettings()">
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="setting-item">
                    <span>‚òÄÔ∏è –ó—É—Ö—Ä</span>
                    <label class="switch">
                        <input type="checkbox" id="notifDhuhr" checked onchange="saveNotificationSettings()">
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="setting-item">
                    <span>üå§ –ê—Å—Ä</span>
                    <label class="switch">
                        <input type="checkbox" id="notifAsr" checked onchange="saveNotificationSettings()">
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="setting-item">
                    <span>üåá –ú–∞–≥—Ä–∏–±</span>
                    <label class="switch">
                        <input type="checkbox" id="notifMaghrib" checked onchange="saveNotificationSettings()">
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="setting-item">
                    <span>üåô –ò—à–∞</span>
                    <label class="switch">
                        <input type="checkbox" id="notifIsha" checked onchange="saveNotificationSettings()">
                        <span class="slider"></span>
                    </label>
                </div>
            </div>

            <div class="card">
                <h2>‚öôÔ∏è –ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Ä–∞—Å—á—ë—Ç–∞</h2>
                <div style="margin-bottom: 8px; color: #1c1c1e;">–ú–µ—Ç–æ–¥: 14 (–†–æ—Å—Å–∏—è/–ö–∞–≤–∫–∞–∑)</div>
                <div style="color: #8e8e93; font-size: 15px;">–ú–∞–∑—Ö–∞–± –¥–ª—è –ê—Å—Ä ‚Äî –≤—ã–±—Ä–∞–Ω –≤ –∫–∞—Ä—Ç–æ—á–∫–µ –Ω–∞–º–∞–∑–∞</div>
            </div>

            <div class="card">
                <h2>‚ÑπÔ∏è –û –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏</h2>
                <p style="color: #3a3a3c; line-height: 1.5;">
                    –¢–æ—á–Ω–æ–µ –≤—Ä–µ–º—è –Ω–∞–º–∞–∑–∞ –ø–æ –º–µ—Ç–æ–¥—É 14 (–†–æ—Å—Å–∏—è/–ö–∞–≤–∫–∞–∑).<br>
                    –ì–µ–æ–ª–æ–∫–∞—Ü–∏—è, —Ä—É—á–Ω–æ–π –ø–æ–∏—Å–∫, —Ç–∞—Å–±–∏—Ö, —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è.
                </p>
                <div style="margin-top: 16px; padding-top: 16px; border-top: 0.5px solid rgba(60,60,67,0.1); color: #8e8e93; font-size: 13px;">
                    –í–µ—Ä—Å–∏—è 4.0 (iOS style)<br>
                    ¬© 2025 Muslim App
                </div>
            </div>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.setHeaderColor('#f2f2f7'); // —Å–≤–µ—Ç–ª—ã–π —Ñ–æ–Ω –ø–æ–¥ —Å—Ç–∞—Ç—É—Å‚Äë–±–∞—Ä

        // --- –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ ---
        let foundLat = 0;
        let foundLon = 0;
        let foundTimezone = '';
        let foundCityName = '';
        let currentSchool = 1; // 0 = –®–∞—Ñ–∏–∏, 1 = –•–∞–Ω–∞—Ñ–∏ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)

        // –¢–∞—Å–±–∏—Ö
        let counter = parseInt(localStorage.getItem('tasbihCounter') || '0');
        let target = parseInt(localStorage.getItem('tasbihTarget') || '33');

        // --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ---
        updateCounterDisplay();
        loadNotificationSettings();
        updateCurrentTime();
        setInterval(updateCurrentTime, 1000);

        // –ê–≤—Ç–æ‚ÄëGPS –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.addEventListener('load', () => {
            setTimeout(() => getLocationAndFetchTimes(), 500);
        });

        // --- –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ç–∞–±–æ–≤ ---
        function switchTab(event, tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            event.currentTarget.classList.add('active');
            document.getElementById(tabName).classList.add('active');
        }

        // --- –í—Ä–µ–º—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ ---
        function updateCurrentTime() {
            const now = new Date();
            document.getElementById('currentTime').textContent = 
                `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}:${String(now.getSeconds()).padStart(2,'0')}`;
            const offset = now.getTimezoneOffset();
            document.getElementById('timezoneInfo').textContent = `UTC${offset<=0?'+':'-'}${Math.abs(offset/60)}`;
            document.getElementById('offsetInfo').textContent = offset;
        }

        // --- –í—ã–±–æ—Ä –º–∞–∑—Ö–∞–±–∞ ---
        function setMadhab(school) {
            currentSchool = school;
            if (school === 0) {
                document.getElementById('madhabShafi').classList.add('active');
                document.getElementById('madhabHanafi').classList.remove('active');
            } else {
                document.getElementById('madhabHanafi').classList.add('active');
                document.getElementById('madhabShafi').classList.remove('active');
            }
            // –ï—Å–ª–∏ —É–∂–µ –µ—Å—Ç—å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã ‚Äî –ø–µ—Ä–µ–∑–∞–ø—Ä–æ—Å–∏—Ç—å –≤—Ä–µ–º—è —Å –Ω–æ–≤—ã–º –º–∞–∑—Ö–∞–±–æ–º
            if (foundLat !== 0 && foundLon !== 0) {
                fetchPrayerTimesByCoords(foundLat, foundLon, foundCityName);
            }
        }

        // --- GPS ---
        function getLocationAndFetchTimes() {
            const status = document.getElementById('geoStatus');
            status.innerHTML = '‚è≥ –û–ø—Ä–µ–¥–µ–ª—è–µ–º –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ...';
            status.style.color = '#007aff';
            if (!navigator.geolocation) {
                status.innerHTML = '‚ùå –ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è';
                status.style.color = '#ff3b30';
                return;
            }
            navigator.geolocation.getCurrentPosition(
                (pos) => {
                    status.innerHTML = `‚úÖ –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: ${pos.coords.latitude.toFixed(4)}, ${pos.coords.longitude.toFixed(4)}. –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—Ä–µ–º—è...`;
                    fetchPrayerTimesByCoords(pos.coords.latitude, pos.coords.longitude, '–í–∞—à–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ');
                },
                (err) => {
                    let msg = '‚ùå –û—à–∏–±–∫–∞: ';
                    if (err.code === 1) msg += '–¥–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω';
                    else if (err.code === 2) msg += '–Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ';
                    else if (err.code === 3) msg += '—Ç–∞–π–º–∞—É—Ç';
                    else msg += err.message;
                    status.innerHTML = msg;
                    status.style.color = '#ff3b30';
                },
                { enableHighAccuracy: true, timeout: 10000, maximumAge: 60000 }
            );
        }

        // --- –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å –≤—Ä–µ–º–µ–Ω–∏ –ø–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º (—Å —É—á—ë—Ç–æ–º –º–∞–∑—Ö–∞–±–∞) ---
        async function fetchPrayerTimesByCoords(lat, lon, displayName) {
            try {
                const date = new Date();
                const dateStr = `${date.getDate().toString().padStart(2,'0')}-${(date.getMonth()+1).toString().padStart(2,'0')}-${date.getFullYear()}`;
                const url = `https://api.aladhan.com/v1/timings/${dateStr}?latitude=${lat}&longitude=${lon}&method=14&school=${currentSchool}`;
                
                const res = await fetch(url);
                const data = await res.json();
                
                if (data.code === 200) {
                    foundLat = lat;
                    foundLon = lon;
                    foundTimezone = data.data.meta.timezone;
                    foundCityName = displayName;

                    document.getElementById('cityName').innerHTML = `üïå ${displayName} (${foundTimezone})`;
                    document.getElementById('coordsDebug').innerHTML = `
                        üìç ${lat.toFixed(4)}, ${lon.toFixed(4)}<br>
                        üåç ${foundTimezone}<br>
                        üìÖ ${date.toLocaleDateString('ru-RU')}<br>
                        üïå –ú–∞–∑—Ö–∞–±: ${currentSchool === 0 ? '–®–∞—Ñ–∏–∏' : '–•–∞–Ω–∞—Ñ–∏'}
                    `;
                    
                    document.getElementById('timeFajr').innerText = data.data.timings.Fajr;
                    document.getElementById('timeDhuhr').innerText = data.data.timings.Dhuhr;
                    document.getElementById('timeAsr').innerText = data.data.timings.Asr;
                    document.getElementById('timeMaghrib').innerText = data.data.timings.Maghrib;
                    document.getElementById('timeIsha').innerText = data.data.timings.Isha;
                    
                    document.getElementById('prayerTimesCard').style.display = 'block';
                    document.getElementById('geoStatus').innerHTML = '‚úÖ –í—Ä–µ–º—è –Ω–∞–º–∞–∑–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–æ';
                    document.getElementById('geoStatus').style.color = '#34c759';
                    
                    tg.HapticFeedback.notificationOccurred('success');
                } else {
                    throw new Error('API error');
                }
            } catch (e) {
                console.error(e);
                document.getElementById('geoStatus').innerHTML = '‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤—Ä–µ–º–µ–Ω–∏';
                document.getElementById('geoStatus').style.color = '#ff3b30';
            }
        }

        // --- –ì–µ–æ–∫–æ–¥–∏–Ω–≥ (—Ä—É—á–Ω–æ–π –ø–æ–∏—Å–∫ –≥–æ—Ä–æ–¥–∞) ---
        async function geocodeAndFetchCity() {
            const city = document.getElementById('cityInput').value.trim();
            if (!city) {
                tg.showAlert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –≥–æ—Ä–æ–¥–∞');
                return;
            }
            const status = document.getElementById('geoStatus');
            status.innerHTML = `üîç –ò—â–µ–º "${city}"...`;
            status.style.color = '#007aff';
            
            try {
                const geoRes = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(city)}&limit=1`, {
                    headers: { 'User-Agent': 'MuslimApp-Telegram/1.0' }
                });
                const geoData = await geoRes.json();
                if (geoData && geoData.length > 0) {
                    const lat = parseFloat(geoData[0].lat);
                    const lon = parseFloat(geoData[0].lon);
                    const name = geoData[0].display_name.split(',')[0];
                    status.innerHTML = `‚úÖ –ù–∞–π–¥–µ–Ω: ${name}. –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—Ä–µ–º—è...`;
                    await fetchPrayerTimesByCoords(lat, lon, name);
                } else {
                    status.innerHTML = '‚ùå –ì–æ—Ä–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω';
                    status.style.color = '#ff3b30';
                    tg.showAlert('–ì–æ—Ä–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω');
                }
            } catch (e) {
                console.error(e);
                status.innerHTML = '‚ùå –û—à–∏–±–∫–∞ –≥–µ–æ–∫–æ–¥–∏–Ω–≥–∞';
                status.style.color = '#ff3b30';
            }
        }

        // --- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –±–æ—Ç–∞ (–ø–µ—Ä–µ–¥–∞—ë–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã, offset, timezone –∏ school) ---
        function saveToBot() {
            if (foundLat === 0) {
                tg.showAlert('–°–Ω–∞—á–∞–ª–∞ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –∏–ª–∏ –≥–æ—Ä–æ–¥');
                return;
            }
            const offset = new Date().getTimezoneOffset();
            tg.sendData(JSON.stringify({
                action: 'sync_location',
                lat: foundLat,
                lon: foundLon,
                offset: offset,
                timezone: foundTimezone,
                school: currentSchool   // –ø–µ—Ä–µ–¥–∞—ë–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π –º–∞–∑—Ö–∞–±
            }));
            tg.close();
        }

        // --- –¢–∞—Å–±–∏—Ö ---
        function incrementCounter() {
            counter++;
            localStorage.setItem('tasbihCounter', counter);
            updateCounterDisplay();
            if (counter === target) {
                tg.HapticFeedback.notificationOccurred('success');
                tg.showAlert(`üéâ –ú–∞—à–∞–ª–ª–∞—Ö! –î–æ—Å—Ç–∏–≥–Ω—É—Ç–æ ${target} –∑–∏–∫—Ä–æ–≤!`);
            } else {
                tg.HapticFeedback.impactOccurred('light');
            }
        }

        function updateCounterDisplay() {
            document.getElementById('counterDisplay').innerText = counter;
            document.getElementById('targetInfo').innerText = `–¶–µ–ª—å: ${target} (–æ—Å—Ç–∞–ª–æ—Å—å: ${Math.max(0, target - counter)})`;
            document.getElementById('progressFill').style.width = `${Math.min(100, (counter / target) * 100)}%`;
        }

        function resetCounter() {
            if (counter > 0) {
                tg.showConfirm('–°–±—Ä–æ—Å–∏—Ç—å —Å—á—ë—Ç—á–∏–∫?', (ok) => {
                    if (ok) {
                        counter = 0;
                        localStorage.setItem('tasbihCounter', '0');
                        updateCounterDisplay();
                        tg.HapticFeedback.notificationOccurred('warning');
                    }
                });
            }
        }

        function setTarget(newTarget) {
            target = newTarget;
            localStorage.setItem('tasbihTarget', target);
            updateCounterDisplay();
            tg.HapticFeedback.impactOccurred('medium');
        }

        // --- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π ---
        function loadNotificationSettings() {
            const saved = localStorage.getItem('notificationSettings');
            if (saved) {
                const s = JSON.parse(saved);
                document.getElementById('notifFajr').checked = s.Fajr !== false;
                document.getElementById('notifDhuhr').checked = s.Dhuhr !== false;
                document.getElementById('notifAsr').checked = s.Asr !== false;
                document.getElementById('notifMaghrib').checked = s.Maghrib !== false;
                document.getElementById('notifIsha').checked = s.Isha !== false;
            }
        }

        function saveNotificationSettings() {
            const settings = {
                Fajr: document.getElementById('notifFajr').checked,
                Dhuhr: document.getElementById('notifDhuhr').checked,
                Asr: document.getElementById('notifAsr').checked,
                Maghrib: document.getElementById('notifMaghrib').checked,
                Isha: document.getElementById('notifIsha').checked
            };
            localStorage.setItem('notificationSettings', JSON.stringify(settings));
            tg.sendData(JSON.stringify({ action: 'update_notifications', settings }));
            tg.HapticFeedback.notificationOccurred('success');
        }
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Muslim App</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* --- Muslim iOS Minimalist Theme --- */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        :root {
            --bg: #F5F7F5; /* –û—á–µ–Ω—å —Å–≤–µ—Ç–ª—ã–π —Å–µ—Ä–æ-–∑–µ–ª–µ–Ω—ã–π –æ—Ç—Ç–µ–Ω–æ–∫ */
            --card-bg: #FFFFFF;
            --text: #111827;
            --secondary-text: #6B7280;
            --border: rgba(0,0,0,0.05);
            
            /* –ò–∑—É–º—Ä—É–¥–Ω—ã–π –∞–∫—Ü–µ–Ω—Ç (Muslim Style) */
            --accent: #10B981; 
            --accent-dim: rgba(16, 185, 129, 0.1);
            
            --success: #34D399;
            --warning: #FBBF24;
            --danger: #EF4444;
            
            --shadow: 0 4px 20px rgba(0,0,0,0.03);
            --radius: 20px;
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --bg: #000000;
                --card-bg: #1C1C1E;
                --text: #FFFFFF;
                --secondary-text: #9CA3AF;
                --border: rgba(255,255,255,0.1);
                --accent: #34D399;
                --accent-dim: rgba(52, 211, 153, 0.15);
            }
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.5;
            padding-bottom: 100px;
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
        }

        /* --- TABS --- */
        .tabs {
            position: fixed;
            bottom: 20px;
            left: 20px;
            right: 20px;
            background: var(--card-bg); /* –ü–ª–∞—à–∫–∞ –≤ –≤–æ–∑–¥—É—Ö–µ */
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            display: flex;
            justify-content: space-around;
            padding: 12px;
            border-radius: 24px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            z-index: 100;
            max-width: 400px;
            margin: 0 auto;
        }

        .tab {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            color: var(--secondary-text);
            font-size: 10px;
            font-weight: 500;
            cursor: pointer;
            transition: transform 0.2s, color 0.2s;
        }
        
        .tab:active { transform: scale(0.9); }

        .tab.active {
            color: var(--accent);
        }

        .tab svg {
            width: 24px;
            height: 24px;
            margin-bottom: 4px;
            fill: currentColor;
        }

        .content {
            padding: 20px;
            max-width: 480px;
            margin: 0 auto;
        }

        .page {
            display: none;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .page.active {
            display: block;
            opacity: 1;
        }

        /* --- CARDS --- */
        .card {
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: 24px;
            margin-bottom: 16px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
        }

        h2 {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 16px;
            color: var(--text);
            letter-spacing: -0.5px;
        }

        /* --- HERO: NEXT PRAYER --- */
        .hero-card {
            text-align: center;
            background: linear-gradient(135deg, var(--accent), #059669);
            color: white;
            padding: 30px 20px;
            border-radius: 24px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(16, 185, 129, 0.3);
            position: relative;
            overflow: hidden;
        }
        
        .hero-pattern {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            opacity: 0.1;
            background-image: radial-gradient(circle at 2px 2px, white 1px, transparent 0);
            background-size: 20px 20px;
        }

        .next-label {
            font-size: 14px;
            opacity: 0.9;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
            position: relative;
        }

        .next-name {
            font-size: 36px;
            font-weight: 800;
            margin-bottom: 4px;
            position: relative;
        }

        .next-timer {
            font-size: 16px;
            font-weight: 500;
            opacity: 0.9;
            background: rgba(255,255,255,0.2);
            padding: 6px 16px;
            border-radius: 20px;
            display: inline-block;
            margin-top: 10px;
            position: relative;
        }

        /* --- PRAYER LIST --- */
        .prayer-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 0;
            border-bottom: 1px solid var(--border);
            transition: background 0.2s;
        }
        
        .prayer-row:last-child { border-bottom: none; }
        
        .prayer-row.current-prayer {
            background: var(--accent-dim);
            margin: 0 -24px;
            padding: 16px 24px;
            border-left: 4px solid var(--accent);
        }

        .p-name {
            font-size: 17px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .p-time {
            font-size: 18px;
            font-weight: 600;
            font-feature-settings: "tnum";
            color: var(--secondary-text);
        }
        
        .current-prayer .p-time { color: var(--accent); }
        .current-prayer .p-name { color: var(--accent); font-weight: 700; }

        /* --- BUTTONS --- */
        .btn {
            width: 100%;
            border: none;
            border-radius: 16px;
            padding: 16px;
            font-size: 17px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.1s;
            text-align: center;
            margin-top: 10px;
        }
        
        .btn:active { transform: scale(0.98); }
        
        .btn-primary {
            background: var(--accent);
            color: white;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
        }
        
        .btn-outline {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text);
        }
        
        .search-container {
            position: relative;
            margin-bottom: 12px;
        }
        
        .search-input {
            width: 100%;
            padding: 16px;
            padding-right: 50px;
            border-radius: 16px;
            border: 1px solid var(--border);
            background: var(--bg);
            font-size: 16px;
            color: var(--text);
        }
        
        .search-btn {
            position: absolute;
            right: 8px;
            top: 8px;
            background: var(--accent);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        /* --- TASBIH --- */
        .counter-circle {
            width: 240px;
            height: 240px;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, var(--accent), #059669);
            margin: 20px auto;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            box-shadow: 0 10px 40px rgba(16, 185, 129, 0.4);
            cursor: pointer;
            transition: transform 0.1s;
        }
        
        .counter-circle:active { transform: scale(0.95); }
        
        .counter-val { font-size: 72px; font-weight: 700; line-height: 1; }
        .counter-lbl { font-size: 16px; opacity: 0.8; margin-top: 8px; }

        /* --- UTILS --- */
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: var(--accent-dim);
            color: var(--accent);
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            margin-top: 10px;
        }

        .switch { position: relative; display: inline-block; width: 50px; height: 30px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #E5E7EB; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 26px; width: 26px; left: 2px; bottom: 2px; background-color: white; transition: .4s; border-radius: 50%; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        input:checked + .slider { background-color: var(--accent); }
        input:checked + .slider:before { transform: translateX(20px); }
    </style>
</head>
<body>

    <div class="content">
        <div id="prayer" class="page active">
            
            <div class="hero-card" id="heroCard" style="display: none;">
                <div class="hero-pattern"></div>
                <div class="next-label">–°–ª–µ–¥—É—é—â–∏–π –Ω–∞–º–∞–∑</div>
                <div class="next-name" id="nextPrayerName">--</div>
                <div class="next-timer" id="nextPrayerTimer">--:--:--</div>
            </div>

            <div class="card">
                <div class="search-container">
                    <input type="text" class="search-input" id="cityInput" placeholder="–ü–æ–∏—Å–∫ –≥–æ—Ä–æ–¥–∞ (–Ω–∞–ø—Ä. Baku)">
                    <button class="search-btn" onclick="geocodeAndFetchCity()">üîç</button>
                </div>
                
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-outline" onclick="getLocationAndFetchTimes()" style="margin-top: 0;">üìç GPS</button>
                    <button class="btn btn-outline" onclick="clearSavedLocation()" style="margin-top: 0;">üóë –°–±—Ä–æ—Å</button>
                </div>
                
                <div id="geoStatus" style="margin-top: 12px; font-size: 14px; color: var(--secondary-text); text-align: center;"></div>
            </div>

            <div class="card" id="prayerTimesCard" style="display:none;">
                <h2 id="cityName" style="font-size: 22px;">–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ</h2>
                
                <div id="prayerList">
                    </div>
                
                <button class="btn btn-primary" onclick="saveToBot()">
                    üì° –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
                </button>
                <div style="text-align: center; font-size: 12px; color: var(--secondary-text); margin-top: 12px;">
                    –ë–æ—Ç –±—É–¥–µ—Ç –ø—Ä–∏—Å—ã–ª–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
                </div>
            </div>
        </div>

        <div id="tasbih" class="page">
            <div class="counter-circle" onclick="incrementCounter()">
                <div class="counter-val" id="counterDisplay">0</div>
                <div class="counter-lbl">–ù–∞–∂–º–∏—Ç–µ</div>
            </div>
            
            <div class="card" style="text-align: center;">
                <div id="targetInfo" style="font-size: 18px; font-weight: 600; color: var(--accent); margin-bottom: 16px;">–¶–µ–ª—å: 33</div>
                <div style="display: flex; gap: 8px; justify-content: center;">
                    <button class="btn btn-outline" onclick="setTarget(33)" style="width: auto; padding: 10px 20px;">33</button>
                    <button class="btn btn-outline" onclick="setTarget(99)" style="width: auto; padding: 10px 20px;">99</button>
                    <button class="btn btn-outline" onclick="resetCounter()" style="width: auto; padding: 10px 20px; border-color: var(--danger); color: var(--danger);">–°–±—Ä–æ—Å</button>
                </div>
            </div>

            <div class="card">
                <div style="display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid var(--border);">
                    <span style="font-size: 18px;">ÿ≥ÿ®ÿ≠ÿßŸÜ ÿßŸÑŸÑŸá</span>
                    <span style="color: var(--secondary-text);">–°—É–±—Ö–∞–Ω–∞–ª–ª–∞—Ö</span>
                </div>
                <div style="display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid var(--border);">
                    <span style="font-size: 18px;">ÿßŸÑÿ≠ŸÖÿØ ŸÑŸÑŸá</span>
                    <span style="color: var(--secondary-text);">–ê–ª—å—Ö–∞–º–¥—É–ª–∏–ª–ª–∞—Ö</span>
                </div>
                <div style="display: flex; justify-content: space-between; padding: 12px 0;">
                    <span style="font-size: 18px;">ÿßŸÑŸÑŸá ÿ£ŸÉÿ®ÿ±</span>
                    <span style="color: var(--secondary-text);">–ê–ª–ª–∞—Ö—É –ê–∫–±–∞—Ä</span>
                </div>
            </div>
        </div>

        <div id="settings" class="page">
            <div class="card">
                <h2>üîî –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</h2>
                <div id="settingsList">
                    </div>
            </div>
            
            <div class="card">
                <h2>‚ÑπÔ∏è –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h2>
                <p style="color: var(--secondary-text); font-size: 14px;">
                    –ú–µ—Ç–æ–¥ —Ä–∞—Å—á—ë—Ç–∞: <strong>MWL (World Islamic League)</strong><br>
                    –£–≥–ª—ã: 18¬∞ / 17¬∞<br>
                    –ú–∞–∑—Ö–∞–±: –®–∞—Ñ–∏–∏—Ç—Å–∫–∏–π
                </p>
                <div style="margin-top: 16px; font-size: 12px; color: var(--accent);">
                    Version 8.0 Muslim Style
                </div>
            </div>
        </div>
    </div>

    <div class="tabs">
        <div class="tab active" onclick="switchTab(event, 'prayer')">
            <svg viewBox="0 0 24 24"><path d="M12 2L2 12h3v8h6v-6h2v6h6v-8h3L12 2z"/></svg>
            <span>–ù–∞–º–∞–∑</span>
        </div>
        <div class="tab" onclick="switchTab(event, 'tasbih')">
            <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"/><circle cx="12" cy="12" r="3"/></svg>
            <span>–¢–∞—Å–±–∏—Ö</span>
        </div>
        <div class="tab" onclick="switchTab(event, 'settings')">
            <svg viewBox="0 0 24 24"><path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58a.49.49 0 0 0 .12-.61l-1.92-3.32a.488.488 0 0 0-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54a.484.484 0 0 0-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.04.17 0 .36.12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58a.49.49 0 0 0-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.04-.22 0-.45-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/></svg>
            <span>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</span>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        // --- GLOBAL VARS ---
        let currentTimings = null;
        let foundLat = 0, foundLon = 0, foundTimezone = '';
        const METHOD = 3; 
        const SCHOOL = 0;

        let counter = parseInt(localStorage.getItem('tasbihCounter') || '0');
        let target = parseInt(localStorage.getItem('tasbihTarget') || '33');

        // --- INIT ---
        window.addEventListener('load', () => {
            updateCounterDisplay();
            renderSettings();
            loadSavedLocation();
            setInterval(updateNextPrayerUI, 1000);
        });

        // --- TABS ---
        function switchTab(e, id) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            e.currentTarget.classList.add('active');
            document.getElementById(id).classList.add('active');
        }

        // --- LOGIC: NEXT PRAYER & UI ---
        function updateNextPrayerUI() {
            if (!currentTimings) return;
            
            const now = new Date();
            const timeNowStr = `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
            
            const prayers = [
                { en: 'Fajr', ru: '–§–∞–¥–∂—Ä', icon: 'üåÖ' },
                { en: 'Dhuhr', ru: '–ó—É—Ö—Ä', icon: '‚òÄÔ∏è' },
                { en: 'Asr', ru: '–ê—Å—Ä', icon: 'üå§' },
                { en: 'Maghrib', ru: '–ú–∞–≥—Ä–∏–±', icon: 'üåá' },
                { en: 'Isha', ru: '–ò—à–∞', icon: 'üåô' }
            ];

            let nextP = null;
            let minDiff = Infinity;

            // –ù–∞—Ö–æ–¥–∏–º —Å–ª–µ–¥—É—é—â–∏–π –Ω–∞–º–∞–∑
            for (let p of prayers) {
                const pTime = currentTimings[p.en];
                const [h, m] = pTime.split(':').map(Number);
                let pDate = new Date();
                pDate.setHours(h, m, 0, 0);

                if (pDate < now) {
                    pDate.setDate(pDate.getDate() + 1); // –ï—Å–ª–∏ –≤—Ä–µ–º—è –ø—Ä–æ—à–ª–æ, –∑–Ω–∞—á–∏—Ç —ç—Ç–æ –∑–∞–≤—Ç—Ä–∞
                }

                const diff = pDate - now;
                if (diff < minDiff) {
                    minDiff = diff;
                    nextP = { ...p, date: pDate };
                }
            }

            // UI Update: Hero Card
            if (nextP) {
                document.getElementById('heroCard').style.display = 'block';
                document.getElementById('nextPrayerName').textContent = nextP.ru;
                
                const hours = Math.floor(minDiff / (1000 * 60 * 60));
                const minutes = Math.floor((minDiff % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((minDiff % (1000 * 60)) / 1000);
                
                document.getElementById('nextPrayerTimer').textContent = 
                    `–ß–µ—Ä–µ–∑ ${hours}:${String(minutes).padStart(2,'0')}:${String(seconds).padStart(2,'0')}`;
            }

            // UI Update: Highlight Row
            // –°–±—Ä–æ—Å –ø–æ–¥—Å–≤–µ—Ç–∫–∏
            document.querySelectorAll('.prayer-row').forEach(row => row.classList.remove('current-prayer'));
            // –õ–æ–≥–∏–∫–∞: –ø–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º —Ç–æ—Ç, —á—Ç–æ –°–ï–ô–ß–ê–° (–ø—Ä–æ—à–ª—ã–π), –∏–ª–∏ —Å–ª–µ–¥—É—é—â–∏–π? 
            // –û–±—ã—á–Ω–æ –ø–æ–¥—Å–≤–µ—á–∏–≤–∞—é—Ç —Å–ª–µ–¥—É—é—â–∏–π –∫–∞–∫ "–∞–∫—Ç—É–∞–ª—å–Ω—ã–π".
            if (nextP) {
                const rowId = `row-${nextP.en}`;
                const el = document.getElementById(rowId);
                if (el) el.classList.add('current-prayer');
            }
        }

        function renderPrayerList(timings) {
            currentTimings = timings;
            const container = document.getElementById('prayerList');
            container.innerHTML = '';
            
            const map = [
                { k: 'Fajr', n: '–§–∞–¥–∂—Ä', i: 'üåÖ' },
                { k: 'Dhuhr', n: '–ó—É—Ö—Ä', i: '‚òÄÔ∏è' },
                { k: 'Asr', n: '–ê—Å—Ä', i: 'üå§' },
                { k: 'Maghrib', n: '–ú–∞–≥—Ä–∏–±', i: 'üåá' },
                { k: 'Isha', n: '–ò—à–∞', i: 'üåô' }
            ];

            map.forEach(item => {
                const time = timings[item.k];
                container.innerHTML += `
                    <div class="prayer-row" id="row-${item.k}">
                        <div class="p-name"><span>${item.i}</span> ${item.n}</div>
                        <div class="p-time">${time}</div>
                    </div>
                `;
            });
            updateNextPrayerUI();
        }

        // --- SETTINGS RENDER ---
        function renderSettings() {
            const list = document.getElementById('settingsList');
            const saved = JSON.parse(localStorage.getItem('notificationSettings') || '{}');
            const map = [
                { k: 'Fajr', n: '–§–∞–¥–∂—Ä' },
                { k: 'Dhuhr', n: '–ó—É—Ö—Ä' },
                { k: 'Asr', n: '–ê—Å—Ä' },
                { k: 'Maghrib', n: '–ú–∞–≥—Ä–∏–±' },
                { k: 'Isha', n: '–ò—à–∞' }
            ];
            
            list.innerHTML = '';
            map.forEach(item => {
                const isChecked = saved[item.k] !== false ? 'checked' : '';
                list.innerHTML += `
                    <div class="setting-item" style="display:flex; justify-content:space-between; padding:12px 0; border-bottom:1px solid var(--border);">
                        <span>${item.n}</span>
                        <label class="switch">
                            <input type="checkbox" id="notif${item.k}" ${isChecked} onchange="saveNotificationSettings()">
                            <span class="slider"></span>
                        </label>
                    </div>
                `;
            });
        }

        // --- LOCATION & API ---
        const STORAGE_KEY = 'muslim_app_location';

        async function fetchPrayerTimesByCoords(lat, lon, name) {
            try {
                const date = new Date();
                const dateStr = `${date.getDate().toString().padStart(2,'0')}-${(date.getMonth()+1).toString().padStart(2,'0')}-${date.getFullYear()}`;
                const url = `https://api.aladhan.com/v1/timings/${dateStr}?latitude=${lat}&longitude=${lon}&method=${METHOD}&school=${SCHOOL}`;
                
                const res = await fetch(url);
                const data = await res.json();
                
                if (data.code === 200) {
                    foundLat = lat; foundLon = lon; foundTimezone = data.data.meta.timezone;
                    document.getElementById('cityName').textContent = name;
                    renderPrayerList(data.data.timings);
                    
                    document.getElementById('prayerTimesCard').style.display = 'block';
                    document.getElementById('heroCard').style.display = 'block';
                    
                    localStorage.setItem(STORAGE_KEY, JSON.stringify({ lat, lon, timezone: foundTimezone, cityName: name }));
                    document.getElementById('geoStatus').innerHTML = `‚úÖ ${name}`;
                }
            } catch (e) {
                document.getElementById('geoStatus').textContent = "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏";
            }
        }

        function getLocationAndFetchTimes() {
            const st = document.getElementById('geoStatus');
            st.textContent = "‚è≥ –û–ø—Ä–µ–¥–µ–ª—è–µ–º...";
            if(!navigator.geolocation) return;
            navigator.geolocation.getCurrentPosition(
                p => fetchPrayerTimesByCoords(p.coords.latitude, p.coords.longitude, "GPS –õ–æ–∫–∞—Ü–∏—è"),
                e => st.textContent = "‚ùå –û—à–∏–±–∫–∞ GPS"
            );
        }

        async function geocodeAndFetchCity() {
            const city = document.getElementById('cityInput').value;
            if(!city) return;
            const st = document.getElementById('geoStatus');
            st.textContent = "üîç –ü–æ–∏—Å–∫...";
            try {
                const r = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${city}&limit=1`);
                const d = await r.json();
                if(d.length) fetchPrayerTimesByCoords(d[0].lat, d[0].lon, d[0].display_name.split(',')[0]);
                else st.textContent = "‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω–æ";
            } catch { st.textContent = "‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏"; }
        }

        function loadSavedLocation() {
            const s = localStorage.getItem(STORAGE_KEY);
            if(s) {
                const d = JSON.parse(s);
                fetchPrayerTimesByCoords(d.lat, d.lon, d.cityName);
            }
        }

        function clearSavedLocation() {
            localStorage.removeItem(STORAGE_KEY);
            location.reload();
        }

        // --- BOT SYNC ---
        function saveToBot() {
            if(!foundLat) return;
            tg.sendData(JSON.stringify({
                action: 'sync_location', lat: foundLat, lon: foundLon,
                timezone: foundTimezone, school: SCHOOL, method: METHOD, 
                offset: new Date().getTimezoneOffset()
            }));
        }

        // --- NOTIFICATIONS ---
        function saveNotificationSettings() {
            const settings = {};
            ['Fajr','Dhuhr','Asr','Maghrib','Isha'].forEach(k => {
                settings[k] = document.getElementById(`notif${k}`).checked;
            });
            localStorage.setItem('notificationSettings', JSON.stringify(settings));
            tg.sendData(JSON.stringify({ action: 'update_notifications', settings }));
        }

        // --- TASBIH ---
        function updateCounterDisplay() {
            document.getElementById('counterDisplay').innerText = counter;
            document.getElementById('progressFill').style.width = `${Math.min(100, (counter / target) * 100)}%`;
            document.getElementById('targetInfo').innerText = `–¶–µ–ª—å: ${target}`;
        }
        function incrementCounter() {
            counter++; localStorage.setItem('tasbihCounter', counter);
            updateCounterDisplay();
            if(counter === target) tg.HapticFeedback.notificationOccurred('success');
            else tg.HapticFeedback.impactOccurred('light');
        }
        function setTarget(t) { target = t; localStorage.setItem('tasbihTarget', t); updateCounterDisplay(); }
        function resetCounter() { 
            tg.showConfirm('–°–±—Ä–æ—Å–∏—Ç—å?', ok => { if(ok) { counter=0; localStorage.setItem('tasbihCounter',0); updateCounterDisplay(); }});
        }
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Muslim App</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg-color: #F2F2F7;
            --card-bg: #FFFFFF;
            --text-color: #000000;
            --secondary-text: #8E8E93;
            --accent-color: #007AFF;
            --tab-bar-bg: #FFFFFF;
            --border-color: #E5E5EA;
        }

        [data-theme="dark"] {
            --bg-color: #000000;
            --card-bg: #1C1C1E;
            --text-color: #FFFFFF;
            --secondary-text: #8E8E93;
            --accent-color: #0A84FF;
            --tab-bar-bg: #1C1C1E;
            --border-color: #38383A;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            padding-bottom: 90px;
            transition: background-color 0.3s, color 0.3s;
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
        }

        /* –ê–Ω–∏–º–∞—Ü–∏—è –ø–µ—Ä–µ—Ö–æ–¥–∞ */
        .container { display: none; animation: fadeIn 0.3s ease; padding: 20px; }
        .container.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }

        h1 { font-size: 28px; font-weight: 700; margin: 10px 0 20px 0; }
        h2 { font-size: 20px; font-weight: 600; margin-bottom: 15px; }

        /* --- –ì–õ–ê–í–ù–ê–Ø --- */
        .hero-card {
            text-align: center;
            color: white;
            padding: 40px 20px;
            background: linear-gradient(135deg, #007AFF, #5AC8FA);
            transition: background 1s ease;
            position: relative;
            overflow: hidden;
        }
        .hero-icon { font-size: 60px; margin-bottom: 10px; display: block; }
        .hero-label { font-size: 16px; opacity: 0.9; text-transform: uppercase; letter-spacing: 1px; }
        .hero-time { font-size: 48px; font-weight: 800; margin: 10px 0; }
        .location-badge { 
            display: inline-block; 
            background: rgba(255,255,255,0.2); 
            padding: 4px 12px; 
            border-radius: 20px; 
            font-size: 13px; 
            backdrop-filter: blur(5px);
        }

        /* --- –†–ê–°–ü–ò–°–ê–ù–ò–ï --- */
        .prayer-row {
            display: flex; justify-content: space-between; padding: 16px 0;
            border-bottom: 1px solid var(--border-color); font-size: 17px;
        }
        .prayer-row:last-child { border-bottom: none; }
        .prayer-time { font-weight: 600; color: var(--accent-color); }
        .prayer-row.next-prayer { background: rgba(0,122,255,0.1); margin: 0 -20px; padding: 16px 20px; border-radius: 10px; }

        /* --- –¢–ê–°–ë–ò–• --- */
        .tasbih-container { text-align: center; padding-top: 40px; }
        .counter-display { font-size: 80px; font-weight: 700; font-variant-numeric: tabular-nums; margin: 20px 0; }
        .tasbih-btn {
            width: 200px; height: 200px;
            border-radius: 50%;
            background: var(--accent-color);
            border: none;
            color: white;
            font-size: 24px;
            box-shadow: 0 10px 30px rgba(0,122,255,0.3);
            cursor: pointer;
            transition: transform 0.1s;
        }
        .tasbih-btn:active { transform: scale(0.95); }
        .reset-btn { margin-top: 30px; background: none; border: none; color: var(--secondary-text); font-size: 16px; padding: 10px; }

        /* --- –ù–ê–°–¢–†–û–ô–ö–ò --- */
        .setting-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 16px 0; border-bottom: 1px solid var(--border-color);
        }
        .input-city {
            background: var(--bg-color); border: 1px solid var(--border-color);
            color: var(--text-color); padding: 10px; border-radius: 8px; width: 60%;
            font-size: 16px;
        }
        .btn-small {
            background: var(--accent-color); color: white; border: none;
            padding: 10px 16px; border-radius: 8px; font-size: 14px; cursor: pointer;
        }

        /* --- –ú–ï–ù–Æ (TAB BAR) --- */
        .tab-bar {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: var(--tab-bar-bg);
            border-top: 1px solid var(--border-color);
            display: flex; justify-content: space-around;
            padding-bottom: env(safe-area-inset-bottom);
            height: 60px;
            z-index: 100;
        }
        .tab-btn {
            flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center;
            background: none; border: none; color: var(--secondary-text);
            font-size: 10px; cursor: pointer; padding-top: 5px;
        }
        .tab-btn.active { color: var(--accent-color); }
        .tab-icon { font-size: 24px; margin-bottom: 4px; }
    </style>
</head>
<body>

    <div id="tab-home" class="container active">
        <h1>–ê—Å—Å–∞–ª—è–º—É –∞–ª–µ–π–∫—É–º</h1>
        
        <div class="card hero-card" id="heroCard">
            <span class="hero-icon" id="heroIcon">‚è≥</span>
            <div class="hero-label">–°–ª–µ–¥—É—é—â–∏–π –Ω–∞–º–∞–∑</div>
            <div class="hero-time" id="nextPrayerTime">--:--</div>
            <div class="hero-label" id="nextPrayerName">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            <br>
            <div class="location-badge" id="locationBadge">üìç –ü–æ–∏—Å–∫...</div>
        </div>

        <div class="card">
            <h2 style="margin-top:0">–°–µ–≥–æ–¥–Ω—è</h2>
            <div id="homeScheduleList">–ó–∞–≥—Ä—É–∑–∫–∞ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è...</div>
        </div>
    </div>

    <div id="tab-schedule" class="container">
        <h1>–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ</h1>
        <div class="card" id="scheduleList">
            </div>
    </div>

    <div id="tab-tasbih" class="container">
        <h1>–¢–∞—Å–±–∏—Ö</h1>
        <div class="tasbih-container">
            <div class="counter-display" id="tasbihCount">0</div>
            <button class="tasbih-btn" onclick="incrementTasbih()">–°—É–±—Ö–∞–Ω–ê–ª–ª–∞—Ö</button>
            <br>
            <button class="reset-btn" onclick="resetTasbih()">–°–±—Ä–æ—Å–∏—Ç—å</button>
        </div>
    </div>

    <div id="tab-settings" class="container">
        <h1>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h1>
        <div class="card">
            <div class="setting-item">
                <span>–¢–µ–º–Ω–∞—è —Ç–µ–º–∞</span>
                <input type="checkbox" id="themeToggle" onchange="toggleTheme()">
            </div>
        </div>

        <h2>–õ–æ–∫–∞—Ü–∏—è</h2>
        <div class="card">
            <div style="margin-bottom: 15px;">
                <button class="btn-small" onclick="getLocation('gps')" style="width:100%">üìç –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å GPS (–¢–æ—á–Ω–æ)</button>
            </div>
            <div style="border-top: 1px solid var(--border-color); padding-top: 15px;">
                <div style="margin-bottom: 5px; font-size: 14px; color: var(--secondary-text);">–ò–ª–∏ –≤–≤–µ–¥–∏—Ç–µ –≥–æ—Ä–æ–¥ (–ª–∞—Ç–∏–Ω–∏—Ü–µ–π):</div>
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="cityInput" class="input-city" placeholder="Baku">
                    <button class="btn-small" onclick="getLocation('city')">–ù–∞–π—Ç–∏</button>
                </div>
            </div>
        </div>
    </div>

    <div class="tab-bar">
        <button class="tab-btn active" onclick="switchTab('home', this)">
            <span class="tab-icon">üè†</span>–ì–ª–∞–≤–Ω–∞—è
        </button>
        <button class="tab-btn" onclick="switchTab('schedule', this)">
            <span class="tab-icon">üìÖ</span>–í—Ä–µ–º—è
        </button>
        <button class="tab-btn" onclick="switchTab('tasbih', this)">
            <span class="tab-icon">üìø</span>–¢–∞—Å–±–∏—Ö
        </button>
        <button class="tab-btn" onclick="switchTab('settings', this)">
            <span class="tab-icon">‚öôÔ∏è</span>–ù–∞—Å—Ç—Ä–æ–π–∫–∏
        </button>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        // –î–∞–Ω–Ω—ã–µ
        let currentTimings = null;
        let tasbihCount = parseInt(localStorage.getItem('tasbih')) || 0;
        const prayerNamesRu = {
            Fajr: "–§–∞–¥–∂—Ä", Sunrise: "–í–æ—Å—Ö–æ–¥", Dhuhr: "–ó—É—Ö—Ä", 
            Asr: "–ê—Å—Ä", Maghrib: "–ú–∞–≥—Ä–∏–±", Isha: "–ò—à–∞"
        };

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        document.getElementById('tasbihCount').innerText = tasbihCount;
        
        // –¢–µ–º–∞
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme === 'dark') {
            document.body.setAttribute('data-theme', 'dark');
            document.getElementById('themeToggle').checked = true;
        }

        // –õ–æ–∫–∞—Ü–∏—è
        const savedCity = localStorage.getItem('savedCity');
        if (savedCity) {
            document.getElementById('cityInput').value = savedCity;
            fetchByCity(savedCity);
        } else {
            getLocation('gps');
        }

        // --- –õ–û–ì–ò–ö–ê ---
        function switchTab(tabName, btn) {
            document.querySelectorAll('.container').forEach(el => el.classList.remove('active'));
            document.getElementById('tab-' + tabName).classList.add('active');
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            btn.classList.add('active');
        }

        function incrementTasbih() {
            tasbihCount++;
            document.getElementById('tasbihCount').innerText = tasbihCount;
            localStorage.setItem('tasbih', tasbihCount);
            if(tg.HapticFeedback) tg.HapticFeedback.impactOccurred('light');
        }

        function resetTasbih() {
            if(confirm('–°–±—Ä–æ—Å–∏—Ç—å —Å—á–µ—Ç—á–∏–∫?')) {
                tasbihCount = 0;
                document.getElementById('tasbihCount').innerText = 0;
                localStorage.setItem('tasbih', 0);
                if(tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('success');
            }
        }

        function toggleTheme() {
            if (document.body.getAttribute('data-theme') === 'dark') {
                document.body.removeAttribute('data-theme');
                localStorage.setItem('theme', 'light');
            } else {
                document.body.setAttribute('data-theme', 'dark');
                localStorage.setItem('theme', 'dark');
            }
        }

        function getLocation(type) {
            document.getElementById('locationBadge').innerText = "‚è≥ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ...";
            if (type === 'gps') {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        (pos) => fetchByCoords(pos.coords.latitude, pos.coords.longitude),
                        (err) => { alert("–í–∫–ª—é—á–∏—Ç–µ GPS –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥ –≤—Ä—É—á–Ω—É—é."); document.getElementById('locationBadge').innerText = "‚ùå –ù–µ—Ç GPS"; }
                    );
                } else {
                    alert("GPS –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è");
                }
            } else if (type === 'city') {
                const city = document.getElementById('cityInput').value;
                if(city) {
                    localStorage.setItem('savedCity', city);
                    fetchByCity(city);
                }
            }
        }

        async function fetchByCoords(lat, lon) {
            const date = Math.floor(Date.now() / 1000);
            const url = `https://api.aladhan.com/v1/timings/${date}?latitude=${lat}&longitude=${lon}&method=3&school=0`;
            loadData(url, "GPS");
        }

        async function fetchByCity(city) {
            const url = `https://api.aladhan.com/v1/timingsByCity?city=${city}&country=Azerbaijan&method=3&school=0`;
            loadData(url, city);
        }

        async function loadData(url, locationName) {
            try {
                const response = await fetch(url);
                const data = await response.json();
                if (data.code === 200) {
                    currentTimings = data.data.timings || data.data.data.timings;
                    document.getElementById('locationBadge').innerText = "üìç " + locationName;
                    renderAll();
                } else {
                    alert("–û—à–∏–±–∫–∞ –¥–∞–Ω–Ω—ã—Ö API");
                }
            } catch (e) {
                document.getElementById('locationBadge').innerText = "‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏";
            }
        }

        function renderAll() {
            renderList('scheduleList');
            renderList('homeScheduleList'); // –î—É–±–ª–∏—Ä—É–µ–º –Ω–∞ –≥–ª–∞–≤–Ω—É—é –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞
            updateHero();
        }

        function renderList(elementId) {
            const list = document.getElementById(elementId);
            list.innerHTML = "";
            const prayers = ['Fajr', 'Sunrise', 'Dhuhr', 'Asr', 'Maghrib', 'Isha'];
            
            prayers.forEach(key => {
                const div = document.createElement('div');
                div.className = 'prayer-row';
                div.innerHTML = `<span>${prayerNamesRu[key]}</span><span class="prayer-time">${currentTimings[key]}</span>`;
                list.appendChild(div);
            });
        }

        function updateHero() {
            const now = new Date();
            const currentTime = now.getHours() * 60 + now.getMinutes();
            const prayers = ['Fajr', 'Sunrise', 'Dhuhr', 'Asr', 'Maghrib', 'Isha'];
            
            let nextPrayer = 'Fajr';
            let nextTimeStr = currentTimings['Fajr'];
            let foundNext = false;

            // –ù–∞–π—Ç–∏ —Å–ª–µ–¥—É—é—â–∏–π –Ω–∞–º–∞–∑
            for (let key of prayers) {
                const [h, m] = currentTimings[key].split(':').map(Number);
                const prayerTime = h * 60 + m;
                if (prayerTime > currentTime) {
                    nextPrayer = key;
                    nextTimeStr = currentTimings[key];
                    foundNext = true;
                    break;
                }
            }
            // –ï—Å–ª–∏ —Å–µ–≥–æ–¥–Ω—è –Ω–∞–º–∞–∑—ã –∫–æ–Ω—á–∏–ª–∏—Å—å, —Å–ª–µ–¥—É—é—â–∏–π - –§–∞–¥–∂—Ä –∑–∞–≤—Ç—Ä–∞
            if (!foundNext) {
                nextPrayer = 'Fajr'; 
                nextTimeStr = currentTimings['Fajr'];
            }

            document.getElementById('nextPrayerName').innerText = prayerNamesRu[nextPrayer];
            document.getElementById('nextPrayerTime').innerText = nextTimeStr;

            // –§–æ–Ω –∏ –∏–∫–æ–Ω–∫–∞
            const card = document.getElementById('heroCard');
            const icon = document.getElementById('heroIcon');
            
            if (nextPrayer === 'Fajr' || nextPrayer === 'Sunrise') {
                card.style.background = "linear-gradient(135deg, #2c3e50, #4ca1af)"; // –ù–æ—á—å/–£—Ç—Ä–æ
                icon.innerText = "üåô";
            } else if (nextPrayer === 'Dhuhr' || nextPrayer === 'Asr') {
                card.style.background = "linear-gradient(135deg, #56CCF2, #2F80ED)"; // –î–µ–Ω—å
                icon.innerText = "‚òÄÔ∏è";
            } else if (nextPrayer === 'Maghrib') {
                card.style.background = "linear-gradient(135deg, #f12711, #f5af19)"; // –ó–∞–∫–∞—Ç
                icon.innerText = "üåÖ";
            } else {
                card.style.background = "linear-gradient(135deg, #141E30, #243B55)"; // –í–µ—á–µ—Ä
                icon.innerText = "üåå";
            }
        }
    </script>
</body>
</html>

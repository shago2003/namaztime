<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Muslim App</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg-color: #F2F2F7;
            --card-bg: #FFFFFF;
            --text-color: #000000;
            --secondary-text: #8E8E93;
            --accent-color: #007AFF;
            --success-color: #34C759;
            --tab-bar-bg: #FFFFFF;
            --border-color: #E5E5EA;
        }

        [data-theme="dark"] {
            --bg-color: #000000;
            --card-bg: #1C1C1E;
            --text-color: #FFFFFF;
            --secondary-text: #8E8E93;
            --accent-color: #0A84FF;
            --tab-bar-bg: #1C1C1E;
            --border-color: #38383A;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0; padding: 0; padding-bottom: 90px;
            overflow-x: hidden; -webkit-tap-highlight-color: transparent;
        }

        /* –ê–ù–ò–ú–ê–¶–ò–Ø */
        .container { display: none; padding: 20px; animation: fadeIn 0.3s ease; }
        .container.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .card {
            background: var(--card-bg); border-radius: 16px; padding: 20px;
            margin-bottom: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }

        h1 { font-size: 28px; font-weight: 700; margin: 10px 0 20px 0; }
        h2 { font-size: 18px; font-weight: 600; margin-bottom: 10px; margin-top: 5px; color: var(--secondary-text); text-transform: uppercase; letter-spacing: 0.5px; }

        /* HERO –°–ï–ö–¶–ò–Ø (–°–û–õ–ù–¶–ï/–õ–£–ù–ê) */
        .hero-card {
            text-align: center; color: white; padding: 40px 20px;
            background: linear-gradient(135deg, #007AFF, #5AC8FA); /* Default */
            transition: background 1s ease;
        }
        .hero-icon { font-size: 60px; margin-bottom: 10px; display: block; }
        .hero-label { font-size: 16px; opacity: 0.9; text-transform: uppercase; letter-spacing: 1px; }
        .hero-time { font-size: 48px; font-weight: 800; margin: 10px 0; }
        .location-badge { 
            display: inline-block; background: rgba(255,255,255,0.2); 
            padding: 4px 12px; border-radius: 20px; font-size: 13px; backdrop-filter: blur(5px);
        }

        /* –°–ü–ò–°–û–ö –ù–ê–ú–ê–ó–û–í */
        .prayer-row {
            display: flex; justify-content: space-between; padding: 16px 0;
            border-bottom: 1px solid var(--border-color); font-size: 17px;
        }
        .prayer-row:last-child { border-bottom: none; }
        .prayer-time { font-weight: 600; color: var(--accent-color); }

        /* –¢–ê–°–ë–ò–• */
        .tasbih-container { text-align: center; padding-top: 40px; }
        .counter-display { font-size: 80px; font-weight: 700; font-variant-numeric: tabular-nums; margin: 20px 0; }
        .tasbih-btn {
            width: 200px; height: 200px; border-radius: 50%;
            background: var(--accent-color); border: none; color: white;
            font-size: 24px; box-shadow: 0 10px 30px rgba(0,122,255,0.3);
            cursor: pointer; transition: transform 0.1s;
        }
        .tasbih-btn:active { transform: scale(0.95); }
        .reset-btn { margin-top: 30px; background: none; border: none; color: var(--secondary-text); font-size: 16px; padding: 10px; }


        /* –ù–ê–°–¢–†–û–ô–ö–ò */
        .setting-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 16px 0; border-bottom: 1px solid var(--border-color);
        }
        .btn-full {
            background: var(--accent-color); color: white; border: none;
            padding: 14px; border-radius: 12px; font-size: 16px; font-weight: 600;
            width: 100%; cursor: pointer; margin-top: 10px;
        }
        .btn-full:disabled { background-color: var(--secondary-text); opacity: 0.5; }
        .btn-test { background-color: var(--success-color); }
        .input-time, .input-city {
            background: var(--bg-color); border: 1px solid var(--border-color);
            color: var(--text-color); padding: 12px; border-radius: 8px; 
            font-size: 16px; width: 100%; box-sizing: border-box; display: block;
        }

        /* –ü–ï–†–ï–ö–õ–Æ–ß–ê–¢–ï–õ–¨ (Switch) */
        .switch { position: relative; display: inline-block; width: 50px; height: 30px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
            background-color: #ccc; transition: .4s; border-radius: 34px;
        }
        .slider:before {
            position: absolute; content: ""; height: 26px; width: 26px;
            left: 2px; bottom: 2px; background-color: white; transition: .4s; border-radius: 50%;
        }
        input:checked + .slider { background-color: var(--success-color); }
        input:checked + .slider:before { transform: translateX(20px); }

        /* –ú–ï–ù–Æ (TAB BAR) */
        .tab-bar {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: var(--tab-bar-bg); border-top: 1px solid var(--border-color);
            display: flex; justify-content: space-around; height: 60px; padding-bottom: env(safe-area-inset-bottom); z-index: 100;
        }
        .tab-btn {
            flex: 1; background: none; border: none; color: var(--secondary-text);
            font-size: 10px; display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .tab-btn.active { color: var(--accent-color); }
        .tab-icon { font-size: 24px; margin-bottom: 4px; }
    </style>
</head>
<body>

    <div id="tab-home" class="container active">
        <h1>–ê—Å—Å–∞–ª—è–º—É –∞–ª–µ–π–∫—É–º</h1>
        
        <div class="card hero-card" id="heroCard">
            <span class="hero-icon" id="heroIcon">‚è≥</span>
            <div class="hero-label">–°–ª–µ–¥—É—é—â–∏–π –Ω–∞–º–∞–∑</div>
            <div class="hero-time" id="nextPrayerTime">--:--</div>
            <div class="hero-label" id="nextPrayerName">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            <br>
            <div class="location-badge" id="locationBadge">üìç –ü–æ–∏—Å–∫...</div>
        </div>

        <div class="card" id="homeScheduleList">–ó–∞–≥—Ä—É–∑–∫–∞ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è...</div>
    </div>

    <div id="tab-schedule" class="container">
        <h1>–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ</h1>
        <div class="card" id="scheduleList"></div>
    </div>

    <div id="tab-tasbih" class="container">
        <h1>–¢–∞—Å–±–∏—Ö</h1>
        <div class="tasbih-container">
            <div class="counter-display" id="tasbihCount">0</div>
            <button class="tasbih-btn" onclick="incrementTasbih()">–°—É–±—Ö–∞–Ω–ê–ª–ª–∞—Ö</button>
            <br>
            <button class="reset-btn" onclick="resetTasbih()">–°–±—Ä–æ—Å–∏—Ç—å</button>
        </div>
    </div>

    <div id="tab-settings" class="container">
        <h1>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h1>
        <div class="card">
            <div class="setting-item">
                <span>–¢–µ–º–Ω–∞—è —Ç–µ–º–∞</span>
                <label class="switch">
                    <input type="checkbox" id="themeToggle" onchange="toggleTheme()">
                    <span class="slider"></span>
                </label>
            </div>
        </div>

        <h2>–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</h2>
        <div class="card">
            <div class="setting-item">
                <span style="font-weight: 600;">–í–∫–ª—é—á–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</span>
                <label class="switch">
                    <input type="checkbox" id="notifToggle" onchange="toggleNotifications()">
                    <span class="slider"></span>
                </label>
            </div>
            
            <div style="margin-top: 15px; border-top: 1px solid var(--border-color); padding-top: 15px;">
                <button id="btnTest" class="btn-full btn-test" onclick="sendTest()">üîî –ü—Ä–æ–≤–µ—Ä–∏—Ç—å (–¢–µ—Å—Ç)</button>
            </div>

            <div style="margin-top: 15px;">
                <input type="time" id="alarmTime" class="input-time">
                <button id="btnAlarm" class="btn-full" onclick="setAlarm()">‚è∞ –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
            </div>
        </div>

        <h2>–õ–æ–∫–∞—Ü–∏—è</h2>
        <div class="card">
            <button class="btn-full" onclick="getLocation('gps')">üìç GPS</button>
            <div style="margin-top: 10px; display: flex; gap: 10px;">
                <input type="text" id="cityInput" class="input-city" placeholder="–ì–æ—Ä–æ–¥ (Baku)">
                <button class="btn-full" style="width: 80px; margin-top:0" onclick="getLocation('city')">OK</button>
            </div>
        </div>
    </div>

    <div class="tab-bar">
        <button class="tab-btn active" onclick="switchTab('home', this)"><span class="tab-icon">üè†</span>–ì–ª–∞–≤–Ω–∞—è</button>
        <button class="tab-btn" onclick="switchTab('schedule', this)"><span class="tab-icon">üìÖ</span>–í—Ä–µ–º—è</button>
        <button class="tab-btn" onclick="switchTab('tasbih', this)"><span class="tab-icon">üìø</span>–¢–∞—Å–±–∏—Ö</button>
        <button class="tab-btn" onclick="switchTab('settings', this)"><span class="tab-icon">‚öôÔ∏è</span>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        let currentTimings = null;
        let tasbihCount = parseInt(localStorage.getItem('tasbih')) || 0;
        let notificationsEnabled = localStorage.getItem('notifEnabled') === 'true';

        // --- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ---
        function init() {
            document.getElementById('tasbihCount').innerText = tasbihCount;
            
            if(localStorage.getItem('theme') === 'dark') {
                document.body.setAttribute('data-theme', 'dark');
                document.getElementById('themeToggle').checked = true;
            }

            document.getElementById('notifToggle').checked = notificationsEnabled;
            updateButtonsState();

            const savedCity = localStorage.getItem('savedCity');
            if (savedCity) fetchByCity(savedCity); else getLocation('gps');
        }

        // --- –¢–ê–°–ë–ò–• ---
        function incrementTasbih() {
            tasbihCount++;
            document.getElementById('tasbihCount').innerText = tasbihCount;
            localStorage.setItem('tasbih', tasbihCount);
            if(tg.HapticFeedback) tg.HapticFeedback.impactOccurred('light');
        }

        function resetTasbih() {
            if(confirm('–°–±—Ä–æ—Å–∏—Ç—å?')) {
                tasbihCount = 0;
                document.getElementById('tasbihCount').innerText = 0;
                localStorage.setItem('tasbih', 0);
            }
        }

        // --- –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø ---
        function toggleNotifications() {
            notificationsEnabled = document.getElementById('notifToggle').checked;
            localStorage.setItem('notifEnabled', notificationsEnabled);
            updateButtonsState();
        }

        function updateButtonsState() {
            const disabled = !notificationsEnabled;
            document.getElementById('btnTest').disabled = disabled;
            document.getElementById('btnAlarm').disabled = disabled;
            document.getElementById('alarmTime').disabled = disabled;
        }

        function sendTest() {
            if(!notificationsEnabled) return;
            // –í–ê–ñ–ù–û: –≠—Ç–æ —Å—Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –æ—Ç–∫—Ä—ã—Ç–æ —á–µ—Ä–µ–∑ Keyboard Button
            tg.sendData(JSON.stringify({ action: 'test_notification' }));
        }

        function setAlarm() {
            if(!notificationsEnabled) return;
            const time = document.getElementById('alarmTime').value;
            if(!time) return alert("–í—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–µ–º—è!");
            tg.sendData(JSON.stringify({ action: 'set_alarm', time: time }));
        }

        // --- API & RENDER ---
        function getLocation(type) {
            document.getElementById('locationBadge').innerText = "‚è≥ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ...";
            if (type === 'gps') {
                navigator.geolocation.getCurrentPosition(
                    pos => fetchByCoords(pos.coords.latitude, pos.coords.longitude),
                    err => alert("GPS –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω")
                );
            } else {
                const city = document.getElementById('cityInput').value;
                if(city) { localStorage.setItem('savedCity', city); fetchByCity(city); }
            }
        }

        async function fetchByCoords(lat, lon) {
            const date = Math.floor(Date.now() / 1000);
            const url = `https://api.aladhan.com/v1/timings/${date}?latitude=${lat}&longitude=${lon}&method=3`;
            loadData(url, "GPS");
        }

        async function fetchByCity(city) {
            const url = `https://api.aladhan.com/v1/timingsByCity?city=${city}&country=Azerbaijan&method=3`;
            loadData(url, city);
        }

        async function loadData(url, locName) {
            try {
                const res = await fetch(url);
                const data = await res.json();
                currentTimings = data.data.timings || data.data.data.timings;
                document.getElementById('locationBadge').innerText = "üìç " + locName;
                renderAll();
            } catch(e) { console.error(e); }
        }

        function renderAll() {
            const ruNames = {Fajr:"–§–∞–¥–∂—Ä", Sunrise:"–í–æ—Å—Ö–æ–¥", Dhuhr:"–ó—É—Ö—Ä", Asr:"–ê—Å—Ä", Maghrib:"–ú–∞–≥—Ä–∏–±", Isha:"–ò—à–∞"};
            const list = document.getElementById('scheduleList');
            const homeList = document.getElementById('homeScheduleList');
            list.innerHTML = ""; homeList.innerHTML = "";

            const now = new Date();
            const nowMins = now.getHours() * 60 + now.getMinutes();
            let nextName = "Fajr", nextTime = currentTimings["Fajr"];
            let found = false;

            ['Fajr','Sunrise','Dhuhr','Asr','Maghrib','Isha'].forEach(key => {
                const time = currentTimings[key];
                const row = `<div class="prayer-row"><span>${ruNames[key]}</span><span class="prayer-time">${time}</span></div>`;
                list.innerHTML += row;
                homeList.innerHTML += row;

                const [h, m] = time.split(':').map(Number);
                if (!found && (h*60+m) > nowMins) {
                    nextName = key; nextTime = time; found = true;
                }
            });

            // –û–±–Ω–æ–≤–ª—è–µ–º HERO
            document.getElementById('nextPrayerName').innerText = ruNames[nextName];
            document.getElementById('nextPrayerTime').innerText = nextTime;
            updateHeroVisuals(nextName);
        }

        function updateHeroVisuals(prayer) {
            const card = document.getElementById('heroCard');
            const icon = document.getElementById('heroIcon');
            
            if (prayer === 'Fajr' || prayer === 'Sunrise') {
                card.style.background = "linear-gradient(135deg, #2c3e50, #4ca1af)"; // –ù–æ—á—å
                icon.innerText = "üåô";
            } else if (prayer === 'Dhuhr' || prayer === 'Asr') {
                card.style.background = "linear-gradient(135deg, #56CCF2, #2F80ED)"; // –î–µ–Ω—å
                icon.innerText = "‚òÄÔ∏è";
            } else if (prayer === 'Maghrib') {
                card.style.background = "linear-gradient(135deg, #f12711, #f5af19)"; // –ó–∞–∫–∞—Ç
                icon.innerText = "üåÖ";
            } else {
                card.style.background = "linear-gradient(135deg, #141E30, #243B55)"; // –ò—à–∞
                icon.innerText = "üåå";
            }
        }

        // --- TABS & THEME ---
        function switchTab(tab, btn) {
            document.querySelectorAll('.container').forEach(e => e.classList.remove('active'));
            document.getElementById('tab-'+tab).classList.add('active');
            document.querySelectorAll('.tab-btn').forEach(e => e.classList.remove('active'));
            btn.classList.add('active');
        }

        function toggleTheme() {
            const isDark = document.body.getAttribute('data-theme') === 'dark';
            document.body.setAttribute('data-theme', isDark ? 'light' : 'dark');
            localStorage.setItem('theme', isDark ? 'light' : 'dark');
        }

        init();
    </script>
</body>
</html>
